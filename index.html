<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TACTICAL COMMAND DUAL - Ver19.1</title>
    <style>
        :root {
            --bg-dark: #020617; --panel-bg: #0f172a; --panel-border: #1e293b;
            --cyan: #22d3ee; --red: #fb7185; --green: #4ade80; --orange: #f97316; --gray: #475569; --blue: #3b82f6; --yellow: #fbbf24;
            --text-main: #f1f5f9; --text-muted: #94a3b8;
        }
        * { box-sizing: border-box; outline: none; }
        body { margin: 0; padding: 12px; background: var(--bg-dark); color: var(--text-main); font-family: 'Consolas', 'Meiryo', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        h1 { text-align: center; margin: 0 0 10px 0; font-size: 18px; color: var(--cyan); text-shadow: 0 0 8px rgba(34,211,238,0.4); letter-spacing: 3px; border-bottom: 1px solid var(--panel-border); padding-bottom: 5px; flex-shrink: 0; }

        .layout { display: flex; flex: 1; gap: 12px; min-height: 0; }
        
        .side-panel { width: 320px; display: flex; flex-direction: column; gap: 12px; min-height: 0; transition: 0.3s ease-out; }
        .main-panel { flex: 1; display: flex; flex-direction: column; gap: 10px; min-width: 0; min-height: 0; }

        .panel { background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: 8px; padding: 10px; display: flex; flex-direction: column; min-height: 0; }
        .panel-title { font-size: 12px; font-weight: bold; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; border-left: 3px solid var(--cyan); padding-left: 8px; flex-shrink: 0; }

        /* --- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ --- */
        .setup-area { flex: 1; overflow-y: auto; padding-right: 5px; min-height: 0; }
        details { background: #161b22; border: 1px solid #30363d; border-radius: 4px; margin-bottom: 6px; }
        summary { padding: 8px; font-size: 12px; cursor: pointer; color: var(--yellow); font-weight: bold; }
        summary:hover { background: #1f2937; }
        .unit-info-box { padding: 8px; background: #0d1117; font-size: 11px; color: var(--text-muted); border-top: 1px solid #30363d; }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚°ãƒªãƒƒãƒ‰ã®å¹…èª¿æ•´ï¼ˆæ–‡å­—ã®ã¯ã¿å‡ºã—é˜²æ­¢ï¼‰ */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-bottom: 4px; font-size: 10.5px; }
        .stat-grid-atk { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2px; margin-bottom: 8px; background: #111827; padding: 4px; border-radius: 4px; text-align: center; }
        
        .ctrl-row { display: flex; gap: 4px; margin-top: 8px; align-items: center; }
        select, input { background: #020617; color: #fff; border: 1px solid #334155; border-radius: 4px; padding: 4px; font-size: 10px; flex: 1; }
        input[type="number"] { max-width: 35px; text-align: center; }
        
        button { cursor: pointer; border: none; border-radius: 4px; padding: 6px 10px; font-weight: bold; transition: 0.2s; font-family: inherit; font-size: 11px; }
        button:hover:not(:disabled) { filter: brightness(1.2); }
        button:disabled { opacity: 0.4; cursor: not-allowed; pointer-events: none; }
        
        .btn-a { background: var(--cyan); color: #000; }
        .btn-b { background: var(--red); color: #fff; }

        .trait-toggle-panel { background: #111827; padding: 8px; border-radius: 4px; margin-bottom: 10px; border: 1px solid var(--cyan); }
        .toggle-row { display: flex; align-items: center; justify-content: space-between; font-size: 11px; color: var(--cyan); font-weight: bold; }
        .switch { position: relative; display: inline-block; width: 34px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 18px; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--cyan); }
        input:checked + .slider:before { transform: translateX(16px); }
        
        .trait-box { background: #111827; border: 1px solid #334155; padding: 6px; border-radius: 4px; margin-top: 4px; margin-bottom: 10px; }
        .trait-box ul { margin: 4px 0 0 20px; padding: 0; font-size: 10px; color: #cbd5e1; }

        /* --- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ»ãƒãƒ¼ --- */
        .control-bar { display: flex; gap: 8px; padding: 10px; background: #1e293b; border-radius: 8px; align-items: center; flex-shrink: 0; }
        .control-bar button { flex: 1; padding: 10px; font-size: 13px; }
        .btn-main { background: var(--green); color: #000; }
        .btn-reset { background: transparent; border: 1px solid var(--red); color: var(--red); }

        /* --- ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒƒãƒ— --- */
        #battlefield-container { flex: 1.5; position: relative; background: #000; border: 1px solid #334155; border-radius: 8px; overflow: hidden; min-height: 250px; }
        #attack-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
        .battlefield { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: space-between; padding: 10px 4px; gap: 4px; }
        
        .map-zone { flex: 1; display: flex; flex-direction: column; gap: 2px; height: 100%; overflow-y: auto; overflow-x: hidden; position: relative; align-items: center; padding-top: 15px; }
        .map-center { width: 10px; flex-shrink: 0; border-left: 1px dashed rgba(251,113,133,0.3); border-right: 1px dashed rgba(34,211,238,0.3); }
        .map-zone::-webkit-scrollbar { width: 2px; } .map-zone::-webkit-scrollbar-thumb { background: #334155; }

        /* ã‚¾ãƒ¼ãƒ³ã®èƒŒæ™¯æ–‡å­— */
        .map-zone::before { position: absolute; top: 0; width: 100%; text-align: center; font-size: 9px; color: #475569; font-weight: bold; pointer-events: none; }
        #zone-a-4::before, #zone-b-4::before { content: "æœ€å¾Œè¡›"; }
        #zone-a-3::before, #zone-b-3::before { content: "ç‰¹æ®Š"; }
        #zone-a-2::before, #zone-b-2::before { content: "å¾Œæ´"; }
        #zone-a-1::before, #zone-b-1::before { content: "æœ€å‰è¡›"; }

        .map-unit { 
            background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(255,255,255,0.4); padding: 2px 4px; 
            border-radius: 2px; text-align: center; color: #fff; width: 95%; position: relative; 
            display: flex; flex-direction: column; justify-content: center; overflow: hidden;
            transition: 0.2s;
        }
        .map-unit.a { border-color: var(--cyan); color: var(--cyan); }
        .map-unit.b { border-color: var(--red); color: var(--red); }
        .map-unit.dead { opacity: 0.15; filter: grayscale(1); border-color: #334155; color: #64748b; }
        .map-unit span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; font-weight: bold; }
        
        .m-bar-container { display: flex; flex-direction: column; gap: 1px; margin-top: 2px; }
        .m-bar { height: 2px; background: #000; border-radius: 1px; width: 100%; display: flex; }
        .m-fill-hp { background: var(--green); } .m-fill-faint { background: var(--orange); } .m-fill-mor { background: var(--blue); }

        @keyframes pulse-atk { 0% { transform: scale(1); background: #fff; color: #000; } 100% { transform: scale(1); } }
        @keyframes pulse-def { 0% { transform: translateX(3px); background: #9f1239; } 50% { transform: translateX(-3px); } 100% { transform: translateX(0); } }
        @keyframes pulse-heal { 0% { background: var(--green); color: #000; } 100% { background: inherit; } }
        .anim-atk { animation: pulse-atk 0.3s ease-out; z-index: 10; }
        .anim-def { animation: pulse-def 0.3s ease-out; }
        .anim-heal { animation: pulse-heal 0.3s ease-out; }

        /* --- ãƒªã‚¹ãƒˆã¨ãƒ­ã‚° --- */
        .bottom-area { display: flex; gap: 12px; flex: 1.2; min-height: 0; }
        .list-area { flex: 1; overflow-y: auto; padding-right: 5px; }
        .log-area { flex: 1.4; background: #010409; overflow-y: auto; padding: 10px; font-size: 11px; line-height: 1.4; color: #c9d1d9; border: 1px solid #30363d; border-radius: 4px; }
        
        .unit-card { background: #161b22; border-radius: 4px; padding: 6px; margin-bottom: 6px; border-left: 3px solid #30363d; font-size: 11px; }
        .unit-card.a { border-left-color: var(--cyan); } .unit-card.b { border-left-color: var(--red); }
        .bar-wrap { height: 10px; background: #1e293b; border-radius: 2px; margin-top: 4px; position: relative; display: flex; overflow: hidden; }
        .bar-hp { background: var(--green); transition: width 0.3s; }
        .bar-faint { background: var(--orange); transition: width 0.3s; }
        .bar-dead { background: var(--gray); transition: width 0.3s; }
        .bar-morale { background: var(--blue); transition: width 0.3s; }
        .bar-text { position: absolute; width: 100%; text-align: center; font-size: 8px; line-height: 10px; font-weight: bold; color: #fff; text-shadow: 1px 1px 1px #000; }
        
        .log-turn { color: var(--yellow); font-weight: bold; border-bottom: 1px dashed #334155; margin: 8px 0 4px 0; padding-bottom: 2px; }
        .log-atk { color: #d2a8ff; } .log-dmg { color: #8b949e; } .log-fatal { color: var(--red); font-weight: bold; }
        .log-route { background: #7f1d1d; color: #fff; padding: 1px 4px; border-radius: 2px; font-weight: bold; display: inline-block; margin-top: 2px; }
        .faction-header { background: #1e293b; color: var(--yellow); font-size: 10px; font-weight: bold; padding: 3px 6px; margin: 8px 0 4px 0; border-left: 3px solid var(--yellow); border-radius: 2px; }
    </style>
</head>
<body>

    <h1>TACTICAL COMMAND DUAL Ver19.1</h1>

    <div class="layout">
        <div class="side-panel" id="side-panel">
            <div class="panel" style="flex: 1;">
                <div class="panel-title">DATABASE & SETUP</div>
                <div class="trait-toggle-panel" style="margin-bottom: 8px; padding: 6px;">
                    <div class="toggle-row">
                        <span>ğŸ”Š ã‚µã‚¦ãƒ³ãƒ‰åŠ¹æœ</span>
                        <label class="switch"><input type="checkbox" id="toggle-sfx" checked><span class="slider"></span></label>
                    </div>
                </div>
                <div class="setup-area" id="setup-list"></div>
            </div>
        </div>

        <div class="main-panel">
            <div class="panel map-panel" style="flex:1.5; padding:0; border:none; background:transparent;">
                <div id="battlefield-container">
                    <canvas id="attack-canvas"></canvas>
                    <div class="battlefield">
                        <div class="map-zone" id="zone-a-4"></div>
                        <div class="map-zone" id="zone-a-3"></div>
                        <div class="map-zone" id="zone-a-2"></div>
                        <div class="map-zone" id="zone-a-1"></div>
                        <div class="map-center"></div>
                        <div class="map-zone" id="zone-b-1"></div>
                        <div class="map-zone" id="zone-b-2"></div>
                        <div class="map-zone" id="zone-b-3"></div>
                        <div class="map-zone" id="zone-b-4"></div>
                    </div>
                </div>
            </div>

            <div class="control-bar" id="control-bar">
                <button id="btn-start" class="btn-main" onclick="startBattle()">âš” MISSION START (æˆ¦é—˜é–‹å§‹)</button>
                <button id="btn-next" style="display:none; background:var(--blue); color:#fff;" onclick="runTurn()" disabled>â­ NEXT TURN</button>
                <button id="btn-auto" style="display:none; background:var(--yellow); color:#000;" onclick="toggleAuto()" disabled>â© AUTO RUN</button>
                <button id="btn-reset" style="display:none;" class="btn-reset" onclick="resetGame()">ğŸ”„ ãƒ¦ãƒ‹ãƒƒãƒˆãƒªã‚»ãƒƒãƒˆ</button>
            </div>
            
            <div class="bottom-area">
                <div class="panel list-area">
                    <div class="panel-title" id="title-a" style="color:var(--cyan); border-color:var(--cyan);">FORCE A</div>
                    <div id="list-a"></div>
                </div>
                <div class="log-area" id="log-area">
                    <div style="color:var(--text-muted);">SYSTEM ONLINE. å…µç§‘ã¨å‘½ä¸­ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Œå…¨å®Ÿè£…ã€‚</div>
                </div>
                <div class="panel list-area">
                    <div class="panel-title" id="title-b" style="color:var(--red); border-color:var(--red);">FORCE B</div>
                    <div id="list-b"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const roll = (sides) => Math.floor(Math.random() * sides) + 1;
        const roll100 = () => Math.floor(Math.random() * 100) + 1;
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // ğŸ”Š éŸ³å£°ã‚¨ãƒ³ã‚¸ãƒ³
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSfx(type) {
            const sfxCheckbox = document.getElementById('toggle-sfx');
            if (sfxCheckbox && !sfxCheckbox.checked) return;
            try {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
                o.connect(g); g.connect(audioCtx.destination);
                const now = audioCtx.currentTime;
                switch(type) {
                    case 'hit': o.type = 'square'; o.frequency.setValueAtTime(120, now); o.frequency.exponentialRampToValueAtTime(40, now + 0.1); g.gain.setValueAtTime(0.01, now); g.gain.linearRampToValueAtTime(0, now + 0.1); break;
                    case 'miss': o.type = 'triangle'; o.frequency.setValueAtTime(800, now); o.frequency.exponentialRampToValueAtTime(300, now + 0.1); g.gain.setValueAtTime(0.01, now); g.gain.linearRampToValueAtTime(0, now + 0.1); break; 
                    case 'pierce': o.type = 'sawtooth'; o.frequency.setValueAtTime(400, now); o.frequency.linearRampToValueAtTime(800, now + 0.05); g.gain.setValueAtTime(0.008, now); g.gain.linearRampToValueAtTime(0, now + 0.15); break;
                    case 'heal': o.type = 'sine'; o.frequency.setValueAtTime(659, now); g.gain.setValueAtTime(0.01, now); g.gain.linearRampToValueAtTime(0, now + 0.2); break;
                    case 'purge': o.type = 'sawtooth'; o.frequency.setValueAtTime(40, now); g.gain.setValueAtTime(0.02, now); g.gain.linearRampToValueAtTime(0, now + 0.4); break;
                    case 'win': o.type = 'triangle'; o.frequency.setValueAtTime(440, now); [554, 659, 880].forEach((f, i) => { setTimeout(() => { const o2=audioCtx.createOscillator(), g2=audioCtx.createGain(); o2.type='sine'; o2.frequency.value=f; o2.connect(g2); g2.connect(audioCtx.destination); g2.gain.setValueAtTime(0.01, audioCtx.currentTime); g2.gain.linearRampToValueAtTime(0, audioCtx.currentTime+0.3); o2.start(); o2.stop(audioCtx.currentTime+0.3); }, i * 150); }); return;
                }
                o.start(); o.stop(now + 0.5);
            } catch(e){}
        }

        const TRAIT_DESCRIPTIONS = {
            "é©å‘½ä¸‡æ­³": "ç„¡è¬€ãªæ”»æ’ƒã®è‡ªå‚·ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒ4å‰²ã«ãªã‚‹ã€‚æ­»äº¡è€…ç™ºç”Ÿæ™‚ã®å£«æ°—ä½ä¸‹ã‚’30%ã®ç¢ºç‡ã§ç„¡åŠ¹åŒ–ã€‚",
            "çš‡å¸é™›ä¸‹ä¸‡æ­³": "æ­»äº¡è€…ç™ºç”Ÿã«ã‚ˆã‚‹éƒ¨éšŠã®å£«æ°—ä½ä¸‹ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒå¸¸ã«åŠæ¸›ã™ã‚‹ã€‚éå¸¸ã«ç²˜ã‚Šå¼·ã„ã€‚",
            "ç²›æ¸…": "ã€ç‰¹æ®Šã€‘å‘³æ–¹éƒ¨éšŠãŒæ•—èµ°ã—ãŸéš›ã€ç”Ÿå­˜è€…ã®åŠæ•°ã‚’å‡¦åˆ‘ã—ã€å£«æ°—ã‚’ã€Œç„¡é™ã€ã«ã—ã¦æ­»ã¬ã¾ã§æˆ¦ç·šã«ç•™ã¾ã‚‰ã›ã‚‹ã€‚",
            "è¡›ç”Ÿå…µ": "ã€æ•‘è­·ã€‘æ”»æ’ƒã®ä»£ã‚ã‚Šã«å‘³æ–¹ã®æ°—çµ¶è€…ã‚’å„ªå…ˆã—ã¦æ²»ç™‚ã™ã‚‹ã€‚ãƒ€ã‚¤ã‚¹å‡ºç›®ã®åˆ†ã ã‘HPã‚’å›å¾©ã—ã€åŠåˆ†ã‚’è¶…ãˆã‚‹ã¨æˆ¦ç·šå¾©å¸°ã™ã‚‹ã€‚",
            "è²«å¾¹": "ã€ç‰¹æ®Šã€‘æ•µã®è£…ç”²ã‚’ç„¡è¦–ã—ã¦ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‹ã€‚",
            "é‡éˆ": "ã€ç‰¹æ®Šã€‘ã©ã‚Œã ã‘æ©Ÿå‹•åŠ›ãŒé«˜ãã¦ã‚‚ã€å…¨ãƒ¦ãƒ‹ãƒƒãƒˆã®æœ€å¾Œã«è¡Œå‹•ã™ã‚‹ã€‚"
        };

        // â˜… è¿½åŠ : æ–°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€Œå…µç§‘(type)ã€ã‚’å…¨ãƒ¦ãƒ‹ãƒƒãƒˆã«å®šç¾©
        const DATABASE = {
            "ãƒ©ãƒ«ã‚­ã‚¢å›½å®¶ç¤¾ä¼šä¸»ç¾©äººæ°‘å…±å’Œå›½": {
                "ç¬¬ã€‡æ­©å…µå¤§éšŠ": { type: "æ­©å…µ", size: 600, cat: "æœ€å‰è¡›éƒ¨éšŠ", morale: 50, agi: 30, arm: 0, hp: 10, fail: 40, gen: [1, 1], spc: [1, 3], reck: [1, 3], traits: ["é©å‘½ä¸‡æ­³"] },
                "ç¬¬ã€‡æ”¿æ²»ç›£æŸ»å§”å“¡ä¸­éšŠ": { type: "æ­©å…µ", size: 100, cat: "å¾Œæ´éƒ¨éšŠ", morale: 200, agi: 30, arm: 0, hp: 10, fail: 30, gen: [1, 1], spc: [1, 2], reck: [1, 2], traits: ["é©å‘½ä¸‡æ­³", "ç²›æ¸…"] },
                "ç¬¬ã€‡æ©Ÿå‹•è£…ç”²ä¸­éšŠ": { type: "è»½æˆ¦è»Š", size: 100, cat: "ç‰¹æ®Šéƒ¨éšŠ", morale: 100, agi: 80, arm: 3, hp: 10, fail: 50, gen: [1, 4], spc: [2, 3], reck: [3, 3], traits: ["é©å‘½ä¸‡æ­³"] },
                "ç¬¬ã€‡è¡›ç”Ÿä¸­éšŠ": { type: "æ­©å…µ", size: 100, cat: "å¾Œæ´éƒ¨éšŠ", morale: 100, agi: 80, arm: 0, hp: 10, fail: 10, gen: [2, 2], spc: [3, 3], reck: [4, 5], traits: ["è¡›ç”Ÿå…µ"] },
                "ç¬¬ã€‡æ”¯æ´ç ²å…µä¸­éšŠ": { type: "ç ²å…µ", size: 100, cat: "æœ€å¾Œè¡›éƒ¨éšŠ", morale: 60, agi: 0, arm: 0, hp: 10, fail: 60, gen: [1, 6], spc: [1, 8], reck: [1, 4], traits: ["è²«å¾¹"] }
            },
            "å…¨åœŸã‚«ãƒ«ãƒ´ã‚§ãƒŠé©å‘½æˆ¦ç·š": {
                "ç¬¬ã€‡é©å‘½ãƒ‘ãƒ«ãƒã‚¶ãƒ³å¤§éšŠ": { type: "æ­©å…µ", size: 600, cat: "æœ€å‰è¡›éƒ¨éšŠ", morale: 200, agi: 0, arm: 0, hp: 10, fail: 60, gen: [1, 2], spc: [1, 2], reck: [1, 5], traits: ["é©å‘½ä¸‡æ­³"] }
            },
            "ã‚«ãƒ«ãƒ´ã‚§ãƒŠå¸å›½": {
                "ç¬¬ã€‡æ­£è¦æ­©å…µå¤§éšŠ": { type: "æ­©å…µ", size: 600, cat: "æœ€å‰è¡›éƒ¨éšŠ", morale: 100, agi: 20, arm: 0, hp: 10, fail: 30, gen: [1, 2], spc: [1, 2], reck: [1, 3], traits: ["çš‡å¸é™›ä¸‹ä¸‡æ­³"] },
                "ç¬¬ã€‡å¸ç«‹é‡è£…ç”²ä¸­éšŠ": { type: "é‡æˆ¦è»Š", size: 100, cat: "ç‰¹æ®Šéƒ¨éšŠ", morale: 250, agi: 10, arm: 6, hp: 10, fail: 30, gen: [1, 5], spc: [1, 6], reck: [1, 3], traits: ["çš‡å¸é™›ä¸‹ä¸‡æ­³", "è²«å¾¹", "é‡éˆ"] }
            }
        };

        const WORKER_PRESET = { type: "æ­©å…µ", size: 100, cat: "æœ€å‰è¡›éƒ¨éšŠ", morale: 50, agi: 0, arm: 0, hp: 7, fail: 65, gen: [1, 1], spc: [1, 1], reck: [2, 3], traits: ["é©å‘½ä¸‡æ­³"] };

        class Unit {
            constructor(name, preset, affiliation, team, id) {
                this.id = id; this.name = name; this.affiliation = affiliation; this.team = team; 
                this.type = preset.type;
                this.category = preset.cat; this.size = preset.size; 
                this.morale = preset.morale; this.max_morale = preset.morale;
                this.agi = preset.agi; this.arm = preset.arm; this.hp = preset.hp; this.fail = preset.fail;
                this.dice = { "é€šå¸¸æ”»æ’ƒ": [...preset.gen], "ç‰¹æ®Šæ”»æ’ƒ": [...preset.spc], "ç„¡è¬€ãªæ”»æ’ƒ": [...preset.reck] };
                this.traits = preset.traits || [];
                this.hpList = new Array(this.size).fill(this.hp);
                this.statusList = new Array(this.size).fill(0); 
                this.isRouted = false;
            }
            getActive() { return this.statusList.filter(s => s === 0).length; }
            getFaint() { return this.statusList.filter(s => s === 1 || s === 2).length; }
            getDead() { return this.statusList.filter(s => s === -1).length; }
            isAlive() { return (this.max_morale === "/" || !this.isRouted) && this.statusList.some(s => s !== -1); }
            
            takeDamage(dmg, isPiercing = false) {
                if (!this.isAlive()) return { hit: false, killed: false };
                let actualDmg = Math.min(Math.max(0, dmg - (isPiercing ? 0 : this.arm)), this.hp);
                let targets = []; for(let i=0; i<this.size; i++) if(this.statusList[i] >= 0) targets.push(i);
                if(targets.length === 0) return { hit: false, killed: false };
                let idx = targets[Math.floor(Math.random() * targets.length)];
                let oldHp = this.hpList[idx]; this.hpList[idx] -= actualDmg;
                if (oldHp > 1 && this.hpList[idx] <= 0) this.hpList[idx] = 1;
                if (this.hpList[idx] <= this.hp / 2 && this.statusList[idx] === 0) this.statusList[idx] = 1;
                let killed = false; if (this.hpList[idx] <= 0) { this.statusList[idx] = -1; killed = true; }
                return { hit: true, killed: killed };
            }
            receiveHealing(amount) {
                let targets = []; for(let i=0; i<this.size; i++) if(this.statusList[i] === 1 || this.statusList[i] === 2) targets.push(i);
                if(targets.length === 0) return false;
                let idx = targets[Math.floor(Math.random() * targets.length)];
                this.hpList[idx] = Math.min(this.hp, this.hpList[idx] + amount);
                if(this.hpList[idx] > this.hp / 2) { this.statusList[idx] = 0; return true; }
                return false;
            }
            applyMoraleDamage(deaths) {
                if(this.max_morale==="/" || this.isRouted || deaths<=0) return false;
                let d = deaths + roll(20);
                if(this.traits.includes("çš‡å¸é™›ä¸‹ä¸‡æ­³")) d = Math.floor(d/2);
                if(this.traits.includes("é©å‘½ä¸‡æ­³") && roll100()<=30) d=0;
                if(d>0) this.morale -= d;
                return this.morale <= 0;
            }
        }

        let teams = { A: [], B: [] };
        let turn = 1; let isBattling = false; let autoMode = false; let unitCounter = 0; let isProcessing = false;

        function initSetup() {
            const list = document.getElementById("setup-list");
            list.innerHTML = "";
            for (let [faction, units] of Object.entries(DATABASE)) {
                let html = `<details class="faction-group"><summary class="faction-summary">ğŸŒ ${faction}</summary>`;
                
                if (faction === "å…¨åœŸã‚«ãƒ«ãƒ´ã‚§ãƒŠé©å‘½æˆ¦ç·š") {
                    html += `
                    <div class="trait-toggle-panel" style="margin: 8px;">
                        <div class="toggle-row">
                            <span>ğŸš© çµ„ç¹”ç‰¹æ€§: åŠ´åƒè€…ã®æ‰‡å‹•</span>
                            <label class="switch"><input type="checkbox" id="trait-incite-workers"><span class="slider"></span></label>
                        </div>
                        <div style="font-size: 10px; color: var(--text-muted); margin-top: 6px; line-height: 1.4;">
                            <span style="color: var(--cyan); font-style: italic;">ã€Œé‰„é–ã®ä»–ã«å¤±ã†ã‚‚ã®ãªã—ï¼ æ­¦å™¨ã‚’å–ã‚Œï¼ã€</span><br>
                            <span style="color: #cbd5e1;">ã€åŠ¹æœã€‘ã‚ªãƒ³ã«ã™ã‚‹ã¨ã€2ã‚¿ãƒ¼ãƒ³ã«1åº¦ã€Œé©å‘½åŠ´åƒè€…ä¸­éšŠ(100å)ã€ãŒè‡ªå‹•å¢—æ´ã•ã‚Œã‚‹ã€‚</span>
                        </div>
                    </div>`;
                }

                for (let [key, data] of Object.entries(units)) {
                    let sid = `s-${unitCounter++}`;
                    let traitsHtml = `<div>[ç‰¹æ€§] ãªã—</div>`;
                    if (data.traits && data.traits.length > 0) {
                        let traitItems = data.traits.map(t => `<li><span class="trait-name">${t}</span>: ${TRAIT_DESCRIPTIONS[t]}</li>`).join('');
                        traitsHtml = `<div class="trait-box"><span style="color:var(--cyan); font-weight:bold;">â—† ç‰¹æ€§è§£èª¬</span><ul>${traitItems}</ul></div>`;
                    }

                    // â˜… ä¿®æ­£: é…ç½®å ´æ‰€ï¼ˆéƒ¨éšŠã‚’çœãï¼‰ã¨å…µç§‘ã‚’è¿½åŠ ã€8é …ç›®ã§ç¶ºéº—ã«æ•´åˆ—
                    let shortCat = data.cat.replace("éƒ¨éšŠ", "");
                    html += `<details class="unit-details"><summary class="unit-summary">${key}</summary>
                        <div class="preset-info">
                            <div class="flavor-text">"${data.desc}"</div>
                            <div class="stat-grid">
                                <div>é…ç½®: ${shortCat}</div><div>å…µç§‘: <span style="color:#fff;">${data.type}</span></div>
                                <div>è¦æ¨¡: ${data.size}</div><div>å£«æ°—: ${data.morale}</div>
                                <div>è£…ç”²: ${data.arm}</div><div>æ©Ÿå‹•: ${data.agi}</div>
                                <div>HP: ${data.hp}</div><div>å¤±æ•—: ${data.fail}%</div>
                            </div>
                            <div class="stat-grid-atk">
                                <div><span style="color:var(--text-muted)">é€šå¸¸</span><br>${data.gen[0]}D${data.gen[1]}</div>
                                <div><span style="color:var(--cyan)">ç‰¹æ®Š</span><br>${data.spc[0]}D${data.spc[1]}</div>
                                <div><span style="color:var(--red)">ç„¡è¬€</span><br>${data.reck[0]}D${data.reck[1]}</div>
                            </div>
                            ${traitsHtml}
                            <div class="ctrl-row">
                                <select id="eq-${sid}"><option value="none">è£…å‚™ãªã—</option><option value="mg">æ©Ÿé–¢éŠƒ(+2D1ç‰¹æ®Š)</option><option value="sp">ã‚¹ã‚³ãƒƒãƒ—(+1è£…ç”²)</option></select>
                                <input type="number" id="ct-${sid}" value="1" min="1" max="10">
                                <button class="btn-a" onclick="addUnit('${faction}','${key}','${sid}','A')">Aã¸</button>
                                <button class="btn-b" onclick="addUnit('${faction}','${key}','${sid}','B')">Bã¸</button>
                            </div>
                        </div></details>`;
                }
                list.innerHTML += html + `</details>`;
            }
        }

        function addUnit(fac, key, sid, team) {
            if(isBattling) return;
            let d = DATABASE[fac][key], c = parseInt(document.getElementById(`ct-${sid}`).value), eq = document.getElementById(`eq-${sid}`).value;
            if(eq==='mg' && (!key.includes('æ­©å…µ') || d.size!==600)) { alert("æ©Ÿé–¢éŠƒã¯æ­©å…µå¤§éšŠå°‚ç”¨ã§ã™ã€‚"); return; }
            if(eq==='sp' && d.arm>0) { alert("å¡¹å£•ã‚¹ã‚³ãƒƒãƒ—ã¯ç„¡è£…ç”²å°‚ç”¨ã§ã™ã€‚"); return; }
            
            for(let i=0; i<c; i++){
                let name = key.replace('ã€‡', Math.floor(Math.random()*84)+1);
                let u = new Unit(name, d, fac, team, `u${unitCounter++}`);
                if(eq==='mg') { u.name+='(æ©ŸéŠƒ)'; u.dice["ç‰¹æ®Šæ”»æ’ƒ"][0]+=2; u.dice["ç‰¹æ®Šæ”»æ’ƒ"][1]+=1; }
                if(eq==='sp') { u.name+='(æ˜)'; u.arm+=1; u.agi-=50; }
                teams[team].push(u);
            }
            updateUI();
        }

        const CAT_TO_ZONE = { "æœ€å‰è¡›éƒ¨éšŠ": 1, "å¾Œæ´éƒ¨éšŠ": 2, "ç‰¹æ®Šéƒ¨éšŠ": 3, "æœ€å¾Œè¡›éƒ¨éšŠ": 4 };

        function updateUI() {
            ["A", "B"].forEach(tid => {
                const list = document.getElementById(`list-${tid.toLowerCase()}`);
                list.innerHTML = ""; let stats = { a:0, f:0, d:0 };
                let grouped = {};
                teams[tid].forEach(u => { if(!grouped[u.affiliation]) grouped[u.affiliation]=[]; grouped[u.affiliation].push(u); });
                
                for(let [fac, units] of Object.entries(grouped)){
                    list.innerHTML += `<div class="faction-header">${fac}</div>`;
                    units.forEach(u => {
                        let active = u.getActive(), faint = u.getFaint(), dead = u.getDead();
                        stats.a+=active; stats.f+=faint; stats.d+=dead;
                        
                        let aPct = (active/u.size)*100; let fPct = (faint/u.size)*100; let dPct = (dead/u.size)*100;
                        let mPct = u.max_morale==="/"?100:Math.max(0,(u.morale/u.max_morale)*100);
                        
                        let statusText = "æˆ¦é—˜ä¸­"; let statusColor = "var(--green)";
                        if(dead >= u.size) { statusText = "å…¨æ»…"; statusColor = "var(--gray)"; }
                        else if(u.isRouted) { statusText = "æ•—èµ°"; statusColor = "var(--red)"; }
                        else if(u.max_morale === "/") { statusText = "æ­»å®ˆ"; statusColor = "var(--red)"; }

                        list.innerHTML += `
                        <div class="unit-card ${tid.toLowerCase()}" style="${u.isAlive()?'':'opacity:0.4; filter:grayscale(0.8);'}">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                                <span style="font-weight:bold; font-size:12px;">${u.name}</span>
                                <div>
                                    <span style="color:${statusColor}; font-weight:bold; margin-right:8px;">${statusText}</span>
                                    <button style="display:${isBattling?'none':'inline-block'}; color:var(--red); background:none; border:none; cursor:pointer; font-size:12px;" onclick="removeUnit('${tid}','${u.id}')">âœ–</button>
                                </div>
                            </div>
                            <div class="bar-wrap">
                                <div class="bar-hp" style="width:${aPct}%"></div><div class="bar-faint" style="width:${fPct}%"></div><div class="bar-dead" style="width:${dPct}%"></div>
                                <div class="bar-text">ç”Ÿå­˜:${active} / æ°—çµ¶:${faint} / æ­»è€…:${dead}</div>
                            </div>
                            <div class="bar-wrap">
                                <div class="bar-morale" style="width:${mPct}%"></div>
                                <div class="bar-text">å£«æ°—: ${u.max_morale === "/" ? "ç„¡é™" : u.morale}</div>
                            </div>
                        </div>`;
                    });
                }
                document.getElementById(`title-${tid.toLowerCase()}`).innerHTML = `FORCE ${tid} <span style="font-size:10px; color:var(--text-muted); font-weight:normal;">(å…µåŠ›:${stats.a})</span>`;
            });

            document.querySelectorAll('.map-zone').forEach(z => z.innerHTML='');
            let zoneCounts = {};
            [...teams.A, ...teams.B].forEach(u => {
                let s = u.team.toLowerCase(); let zId = `zone-${s}-${CAT_TO_ZONE[u.category]}`;
                if(!zoneCounts[zId]) zoneCounts[zId] = 0; zoneCounts[zId]++;
            });

            [...teams.A, ...teams.B].forEach(u => {
                let s = u.team.toLowerCase(); let zId = `zone-${s}-${CAT_TO_ZONE[u.category]}`;
                let countInZone = zoneCounts[zId];
                
                let h = countInZone > 30 ? "16px" : (countInZone > 15 ? "22px" : "32px");
                let fz = countInZone > 30 ? "6px" : (countInZone > 15 ? "7px" : "9px");

                let aPct = (u.getActive()/u.size)*100;
                let fPct = (u.getFaint()/u.size)*100;
                let mP = u.max_morale==="/"?100:Math.max(0,(u.morale/u.max_morale)*100);
                
                document.getElementById(zId).innerHTML += `
                    <div class="map-unit ${s} ${u.isAlive()?'':'dead'}" id="map-${u.id}" style="min-height:${h}; font-size:${fz}; padding:1px;">
                        <span>${u.name}</span>
                        <div class="m-bar-container">
                            <div class="m-bar"><div class="m-fill-hp" style="width:${aPct}%"></div><div class="m-fill-faint" style="width:${fPct}%"></div></div>
                            <div class="m-bar"><div class="m-fill-mor" style="width:${mP}%"></div></div>
                        </div>
                    </div>`;
            });
        }

        function drawAttackLine(atkId, tgtId, type) {
            const canvas = document.getElementById('attack-canvas');
            const ctx = canvas.getContext('2d');
            const parent = canvas.parentElement;
            
            canvas.width = parent.clientWidth;
            canvas.height = parent.clientHeight;
            
            const el1 = document.getElementById(`map-${atkId}`);
            const el2 = document.getElementById(`map-${tgtId}`);
            if(!el1 || !el2) return;

            const r1 = el1.getBoundingClientRect();
            const r2 = el2.getBoundingClientRect();
            const pRect = parent.getBoundingClientRect();

            const x1 = r1.left - pRect.left + r1.width/2;
            const y1 = r1.top - pRect.top + r1.height/2;
            const x2 = r2.left - pRect.left + r2.width/2;
            const y2 = r2.top - pRect.top + r2.height/2;

            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.lineWidth = 2;
            ctx.strokeStyle = type === 'heal' ? 'rgba(74, 222, 128, 0.9)' : 'rgba(251, 113, 133, 0.9)';
            if(type === 'atk') ctx.setLineDash([4, 4]); 
            ctx.stroke();

            setTimeout(() => { ctx.clearRect(0, 0, canvas.width, canvas.height); }, 300);
        }

        function removeUnit(t, id) { teams[t] = teams[t].filter(u => u.id !== id); updateUI(); }
        
        function startBattle() { 
            if(teams.A.length===0 || teams.B.length===0) {
                alert("å¸ä»¤å®˜ã€ä¸¡è»ã«æœ€ä½1ã¤ä»¥ä¸Šã®éƒ¨éšŠã‚’é…å‚™ã—ã¦ãã ã•ã„ï¼");
                return; 
            }
            if(audioCtx.state === 'suspended') audioCtx.resume();
            isBattling = true; 
            document.getElementById("side-panel").style.display = "none";
            document.getElementById("btn-start").style.display = "none"; 
            document.getElementById("btn-next").style.display = "block"; document.getElementById("btn-next").disabled = false; 
            document.getElementById("btn-auto").style.display = "block"; document.getElementById("btn-auto").disabled = false; 
            document.getElementById("btn-reset").style.display = "block"; 
            document.getElementById("log-area").innerHTML = `<div style="color:var(--green); font-weight:bold; font-size:14px;">âš” MISSION START âš”</div>`;
            updateUI(); setTimeout(updateUI, 100); 
        }

        function toggleAuto() { 
            if(!isBattling) return;
            autoMode = !autoMode; 
            let btn = document.getElementById("btn-auto");
            if (autoMode) { btn.innerHTML = "â¸ PAUSE"; btn.style.background = "#eab308"; btn.style.color = "#000"; } 
            else { btn.innerHTML = "â© AUTO RUN"; btn.style.background = ""; btn.style.color = ""; }
            if(autoMode && !isProcessing) runTurn(); 
        }

        async function runTurn() {
            if(!isBattling || isProcessing) return; 
            isProcessing = true;
            document.getElementById("btn-next").disabled = true;
            const logArea = document.getElementById("log-area");
            const log = (msg, cls='') => { logArea.innerHTML+=`<div class="${cls}">${msg}</div>`; logArea.scrollTop=logArea.scrollHeight; };
            log(`â–¼ TURN ${turn} â–¼`, 'log-turn');

            const inciteCheckbox = document.getElementById('trait-incite-workers');
            if (inciteCheckbox && inciteCheckbox.checked && turn % 2 === 0) {
                ["A", "B"].forEach(side => {
                    if (teams[side].some(u => u.affiliation === "å…¨åœŸã‚«ãƒ«ãƒ´ã‚§ãƒŠé©å‘½æˆ¦ç·š")) {
                        let name = `ç¬¬${Math.floor(Math.random()*84)+1}åŠ´åƒè€…ä¸­éšŠ`;
                        teams[side].push(new Unit(name, WORKER_PRESET, "å…¨åœŸã‚«ãƒ«ãƒ´ã‚§ãƒŠé©å‘½æˆ¦ç·š", side, `u_i_${unitCounter++}`));
                        log(`ğŸ“¢ã€æ‰‡å‹•ã€‘${side}è»ã« ${name} åˆ°ç€ï¼`); playSfx('heal');
                    }
                });
                updateUI();
            }

            let all = [...teams.A, ...teams.B];
            all.forEach(u => u.turnStartDead = u.getDead());

            let cats = ["ç‰¹æ®Šéƒ¨éšŠ", "æœ€å¾Œè¡›éƒ¨éšŠ", "æœ€å‰è¡›éƒ¨éšŠ", "å¾Œæ´éƒ¨éšŠ"];
            let actionList = [];
            cats.forEach(c => all.filter(u => u.category === c && !u.traits.includes('é‡éˆ')).forEach(u => actionList.push(u)));
            cats.forEach(c => all.filter(u => u.category === c && u.traits.includes('é‡éˆ')).forEach(u => actionList.push(u)));

            for (let atk of actionList) {
                if(!atk.isAlive()) continue;
                let isM = atk.traits.includes('è¡›ç”Ÿå…µ'), isP = atk.traits.includes('è²«å¾¹'), target;
                if(isM) {
                    let allies = teams[atk.team].filter(u => u.isAlive() && !u.traits.includes('è¡›ç”Ÿå…µ') && u.getFaint() > 0);
                    if(!allies.length) allies = teams[atk.team].filter(u => u.isAlive() && !u.traits.includes('è¡›ç”Ÿå…µ') && u !== atk);
                    target = allies[Math.floor(Math.random()*allies.length)];
                } else {
                    let enemies = teams[atk.team==='A'?'B':'A'].filter(u => u.isAlive());
                    target = enemies[Math.floor(Math.random()*enemies.length)];
                }
                if(!target) continue;

                let rollV = roll(6), type = rollV===1?"ç‰¹æ®Š":(rollV===6?"ç„¡è¬€":"é€šå¸¸");
                let [dN, dS] = atk.dice[type==="é€šå¸¸"?"é€šå¸¸æ”»æ’ƒ":(type==="ç‰¹æ®Š"?"ç‰¹æ®Šæ”»æ’ƒ":"ç„¡è¬€ãªæ”»æ’ƒ")];
                let hits = 0, misses = 0, kills = 0, revs = 0, selfK = 0, count = atk.getActive();

                for(let i=0; i<count; i++){
                    // â˜…å‘½ä¸­å¤±æ•—ã®åˆ¤å®šï¼ˆã“ã“ã§å¤–ã‚ŒãŸå ´åˆã¯ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—ã‚’è¡Œã‚ãªã„ï¼‰
                    if (roll100() <= atk.fail) {
                        misses++;
                        if (type === "ç„¡è¬€" && roll100() > 50) selfK++; // ç„¡è¬€ã®å ´åˆã¯å¤–ã‚Œã¦ã‚‚è‡ªå‚·ãƒªã‚¹ã‚¯
                        continue;
                    }
                    
                    let d = 0; for(let j=0; j<dN; j++) d += roll(dS);
                    if(isM){ 
                        if(target.receiveHealing(d)) revs++; 
                        if(type==="ç„¡è¬€" && atk.takeDamage(Math.floor(d*0.3)).killed) selfK++; 
                    } else {
                        let res = target.takeDamage(d, isP);
                        if(res.hit) hits++; if(res.killed) kills++;
                        if(type==="ç„¡è¬€" && atk.takeDamage(Math.floor(d*0.3)).killed) selfK++;
                    }
                }

                const aEl = document.getElementById(`map-${atk.id}`), tEl = document.getElementById(`map-${target.id}`);
                if(aEl) aEl.classList.add('anim-atk'); if(tEl && hits > 0) tEl.classList.add(isM?'anim-heal':'anim-def');
                drawAttackLine(atk.id, target.id, isM ? 'heal' : 'atk');
                
                if (isM) { playSfx('heal'); } 
                else if (hits === 0 && misses > 0) { playSfx('miss'); } // å…¨å¼¾ãƒŸã‚¹ã®æ™‚ã®é¢¨åˆ‡ã‚ŠéŸ³
                else { if (isP) playSfx('pierce'); else playSfx('hit'); }

                await sleep(350);
                if(aEl) aEl.classList.remove('anim-atk'); if(tEl) tEl.classList.remove(isM?'anim-heal':'anim-def');

                let resTxt = isM ? `<span style="color:var(--green)">å¾©å¸°:${revs}</span> / ãƒŸã‚¹:${misses}` : `æœ‰åŠ¹:${hits} / <span style="color:var(--orange)">ãƒŸã‚¹:${misses}</span> / <span class="log-fatal">æ­»:${kills}</span>`;
                if(selfK>0) resTxt += ` | è‡ªæ:${selfK}`;
                log(`[${atk.name}] ${type} -> [${target.name}]<br>&nbsp;&nbsp;â”” ${resTxt}`, 'log-dmg');
                updateUI();
            }

            all.forEach(u => {
                for(let i=0; i<u.size; i++) if(u.statusList[i]===1) u.statusList[i]=2; else if(u.statusList[i]===2){ u.statusList[i]=-1; u.hpList[i]=0; }
                if(u.isAlive() && u.applyMoraleDamage(u.getDead()-u.turnStartDead)){
                    let commissar = teams[u.team].find(c => c.traits.includes('ç²›æ¸…') && c.isAlive() && c !== u);
                    if(commissar){
                        let aliveIds = []; u.statusList.forEach((s,idx)=>{ if(s!==-1) aliveIds.push(idx); });
                        let killC = Math.floor(aliveIds.length/2);
                        for(let i=0; i<killC; i++) { let rIdx = aliveIds.splice(Math.floor(Math.random()*aliveIds.length),1)[0]; u.statusList[rIdx]=-1; u.hpList[rIdx]=0; }
                        u.max_morale="/"; u.morale="/"; playSfx('purge'); log(`ğŸ’¥ã€ç²›æ¸…ã€‘${u.name} ã‚’å†ç·¨æˆï¼`, 'log-route');
                    } else { u.isRouted=true; u.statusList.forEach((s,idx)=>{ if(s>0) u.statusList[idx]=-1; }); playSfx('purge'); log(`âš ï¸ã€æ•—èµ°ã€‘${u.name} å´©å£Šï¼`, 'log-route'); }
                }
            });

            turn++; updateUI(); isProcessing = false;
            let winA = teams.B.every(u => !u.isAlive()), winB = teams.A.every(u => !u.isAlive());
            if(winA || winB){ 
                autoMode = false; playSfx('win'); log(`ğŸ† çµ‚çµ: ${winA?'FORCE A':'FORCE B'}ã®å‹åˆ©ï¼`, 'log-turn'); 
                document.getElementById("btn-next").disabled = true; document.getElementById("btn-auto").disabled = true; // â˜… æˆ¦é—˜çµ‚äº†å¾Œãƒ­ãƒƒã‚¯
                return; 
            }
            if(autoMode) setTimeout(runTurn, 400); else document.getElementById("btn-next").disabled = false;
        }

        function resetGame(){ location.reload(); }
        document.addEventListener('DOMContentLoaded', initSetup);
    </script>
</body>
</html>
