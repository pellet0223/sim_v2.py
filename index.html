<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TACTICAL COMMAND DUAL - Ver7.0</title>
    <style>
        :root {
            --bg-dark: #050b14; --panel-bg: #0f172a; --panel-border: #1e293b;
            --cyan: #06b6d4; --red: #ef4444; --green: #10b981; --yellow: #eab308; --blue: #3b82f6;
            --text-main: #f8fafc; --text-muted: #64748b;
        }
        * { box-sizing: border-box; }
        body { margin: 0; padding: 10px; background: var(--bg-dark); color: var(--text-main); font-family: 'Segoe UI', Meiryo, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        h1 { text-align: center; margin: 0 0 10px 0; font-size: 20px; color: var(--cyan); text-shadow: 0 0 10px rgba(6,182,212,0.5); letter-spacing: 2px; }

        .top-section { display: flex; gap: 10px; height: 45%; min-height: 280px; margin-bottom: 10px; }
        .bottom-section { display: flex; gap: 10px; flex: 1; min-height: 0; }
        .panel { background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: 6px; padding: 10px; display: flex; flex-direction: column; overflow: hidden; }
        .panel-title { font-size: 14px; font-weight: bold; border-bottom: 1px solid var(--panel-border); padding-bottom: 5px; margin-bottom: 10px; color: #fff; display: flex; justify-content: space-between; align-items: center; }

        .setup-panel { flex: 1.2; overflow-y: auto; padding-right: 5px; }
        .faction-group { background: #020617; border: 1px solid var(--panel-border); border-radius: 4px; margin-bottom: 10px; overflow: hidden; }
        .faction-summary { padding: 10px; font-weight: bold; color: var(--yellow); background: #1e293b; cursor: pointer; outline: none; border-bottom: 1px solid #000; }
        .faction-summary:hover { background: #334155; }
        
        .unit-details { background: #0f172a; border-top: 1px solid #000; margin: 5px; border: 1px solid var(--panel-border); border-radius: 4px; }
        .unit-summary { padding: 10px; cursor: pointer; color: #fff; font-size: 13px; font-weight: bold; }
        .unit-summary:hover { background: #1e293b; }
        .preset-info { padding: 10px; background: #020617; border-top: 1px solid var(--panel-border); font-size: 12px; }
        .flavor-text { color: var(--cyan); font-style: italic; margin-bottom: 8px; border-left: 3px solid var(--cyan); padding-left: 8px; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; color: var(--text-muted); margin-bottom: 8px; font-size: 11px; }
        
        .trait-box { grid-column: 1 / -1; background: #111827; border: 1px solid #334155; padding: 6px; border-radius: 4px; margin-top: 4px; margin-bottom: 10px; }
        .trait-box ul { margin: 4px 0 0 20px; padding: 0; font-size: 11px; color: #cbd5e1; }
        .trait-box li { margin-bottom: 4px; }
        .trait-name { color: #f472b6; font-weight: bold; }

        .action-btns { display: flex; flex-direction: column; gap: 8px; background: #1e293b; padding: 8px; border-radius: 4px; }
        .action-btns select, .action-btns input { background: #020617; color: #fff; border: 1px solid #475569; padding: 4px; border-radius: 4px; font-size: 11px; }
        .btn-row { display: flex; gap: 5px; align-items: center; width: 100%; }
        button { background: var(--blue); color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 11px; }
        button:hover { filter: brightness(1.2); }
        button:disabled { background: #334155; color: #64748b; cursor: not-allowed; }
        .btn-a { background: var(--cyan); color: #000; flex: 1; } 
        .btn-b { background: var(--red); color: #fff; flex: 1; }
        .btn-del { background: transparent; color: #ef4444; border: 1px solid #ef4444; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer; }
        .btn-del:hover { background: #ef4444; color: #fff; }

        .map-panel { flex: 2; position: relative; display: flex; flex-direction: column; }
        .battlefield { flex: 1; display: flex; justify-content: space-between; background: repeating-linear-gradient(0deg, #050b14, #050b14 20px, #0a1120 20px, #0a1120 40px); border: 1px solid #334155; border-radius: 4px; padding: 10px; overflow: hidden; }
        .map-zone { display: flex; flex-direction: column; justify-content: center; gap: 5px; width: 22%; }
        .map-center { width: 6%; border-left: 2px dashed #ef4444; border-right: 2px dashed #06b6d4; opacity: 0.5; }
        .map-unit { background: #1e293b; border: 1px solid #fff; padding: 6px; text-align: center; border-radius: 4px; font-size: 11px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; position: relative; }
        .map-unit.a { border-color: var(--cyan); color: var(--cyan); box-shadow: 0 0 5px rgba(6,182,212,0.3); }
        .map-unit.b { border-color: var(--red); color: var(--red); box-shadow: 0 0 5px rgba(239,68,68,0.3); }
        .map-unit.dead { opacity: 0.2; border-color: #475569; box-shadow: none; color: #475569; }
        
        @keyframes anim-atk { 0% { transform: scale(1); background: #1e293b; } 50% { transform: scale(1.15); background: #fff; color: #000; box-shadow: 0 0 15px #fff; z-index: 10; } 100% { transform: scale(1); } }
        @keyframes anim-def { 0% { transform: translateX(0); background: #9f1239; color: #fff; } 20% { transform: translateX(-4px) rotate(-2deg); } 40% { transform: translateX(4px) rotate(2deg); } 60% { transform: translateX(-4px) rotate(-2deg); } 80% { transform: translateX(4px) rotate(2deg); } 100% { transform: translateX(0); } }
        @keyframes anim-heal { 0% { transform: scale(1); background: #1e293b; } 50% { transform: scale(1.1); background: #10b981; color: #fff; box-shadow: 0 0 15px #10b981; z-index: 10; } 100% { transform: scale(1); } }
        
        .anim-atk { animation: anim-atk 0.4s ease-out; }
        .anim-def { animation: anim-def 0.4s ease-out; }
        .anim-heal { animation: anim-heal 0.4s ease-out; }

        .list-panel { flex: 1; overflow-y: auto; padding-right: 5px; }
        .log-panel { flex: 1.5; overflow-y: auto; background: #020617; font-family: var(--font-mono); font-size: 13px; line-height: 1.5; padding: 10px; border: 1px solid var(--panel-border); }
        
        .unit-card { background: #0f172a; border-left: 3px solid #475569; padding: 8px; margin-bottom: 8px; border-radius: 4px; font-size: 12px; position: relative; }
        .unit-card.a { border-left-color: var(--cyan); } .unit-card.b { border-left-color: var(--red); }
        .affiliation-tag { font-size: 9px; color: var(--text-muted); display: block; margin-bottom: 4px; }
        
        .bar-wrap { height: 12px; background: #000; border-radius: 2px; margin-top: 4px; position: relative; display: flex; overflow: hidden; }
        .bar-hp { background: var(--green); transition: width 0.3s; }
        .bar-faint { background: var(--yellow); transition: width 0.3s; }
        .bar-dead { background: var(--red); transition: width 0.3s; }
        .bar-morale { background: var(--blue); transition: width 0.3s; }
        .bar-text { position: absolute; width: 100%; text-align: center; font-size: 9px; line-height: 12px; font-weight: bold; color: #fff; text-shadow: 1px 1px 1px #000; }

        .log-turn { color: var(--yellow); font-weight: bold; margin-top: 10px; border-bottom: 1px dashed #334155; padding-bottom: 4px; }
        .log-atk { color: #c084fc; } .log-dmg { color: #cbd5e1; } .log-fatal { color: var(--red); font-weight: bold; }
        .log-route { color: #fff; background: #9f1239; padding: 3px 6px; font-weight: bold; border-radius: 2px; display: inline-block; margin-top: 4px; border: 1px solid #f43f5e; }
        .controls { display: flex; gap: 8px; margin-top: 10px; justify-content: center; }
        .controls button { padding: 10px 15px; font-size: 13px; }
    </style>
</head>
<body>

    <h1>TACTICAL COMMAND DUAL - Ver 7.0</h1>

    <div class="top-section">
        <div class="panel setup-panel">
            <div class="panel-title">â–¼ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (è£…å‚™ï¼†æ‰€å±)</div>
            <div id="setup-list"></div>
        </div>

        <div class="panel map-panel">
            <div class="panel-title">ğŸ“¡ æˆ¦è¡“ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒƒãƒ—</div>
            <div class="battlefield" id="battlefield">
                <div class="map-zone" id="zone-a-back"></div>
                <div class="map-zone" id="zone-a-front"></div>
                <div class="map-center"></div>
                <div class="map-zone" id="zone-b-front"></div>
                <div class="map-zone" id="zone-b-back"></div>
            </div>
            <div class="controls">
                <button id="btn-start" onclick="startBattle()" style="background: var(--green);">âš”ï¸ æˆ¦é—˜é–‹å§‹</button>
                <button id="btn-next" onclick="runTurn()" disabled>â­ æ¬¡ã‚¿ãƒ¼ãƒ³</button>
                <button id="btn-auto" onclick="toggleAuto()" disabled>â© è‡ªå‹•å®Ÿè¡Œ</button>
                <button onclick="resetGame()" style="background: transparent; color: var(--red); border: 1px solid var(--red);">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
        </div>
    </div>

    <div class="bottom-section">
        <div class="panel list-panel" id="panel-a">
            <div class="panel-title" id="title-a" style="color:var(--cyan)">[A] æ”»æ’ƒè» <span style="font-size:11px; color:var(--text-muted);">(ç·å…µåŠ›: 0)</span></div>
            <div id="list-a"></div>
        </div>
        <div class="panel log-panel" id="log-area"><div style="color:var(--text-muted)">SYSTEM: è£…å‚™ã‚·ã‚¹ãƒ†ãƒ ï¼†è¡›ç”Ÿå…µAIãŒã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«ãªã‚Šã¾ã—ãŸã€‚</div></div>
        <div class="panel list-panel" id="panel-b">
            <div class="panel-title" id="title-b" style="color:var(--red)">[B] é˜²è¡›è» <span style="font-size:11px; color:var(--text-muted);">(ç·å…µåŠ›: 0)</span></div>
            <div id="list-b"></div>
        </div>
    </div>

    <script>
        const roll = (sides) => Math.floor(Math.random() * sides) + 1;
        const roll100 = () => Math.floor(Math.random() * 100) + 1;
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        const TRAIT_DESCRIPTIONS = {
            "é©å‘½ä¸‡æ­³": "ç„¡è¬€ãªæ”»æ’ƒã«ã‚ˆã‚‹è‡ªå‚·ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒ4å‰²ã«ãªã‚‹ã€‚ã¾ãŸã€æ­»äº¡è€…ç™ºç”Ÿæ™‚ã®å£«æ°—ä½ä¸‹ã‚’30%ã®ç¢ºç‡ã§ç„¡åŠ¹åŒ–ã™ã‚‹ã€‚",
            "çš‡å¸é™›ä¸‹ä¸‡æ­³": "æ­»äº¡è€…ç™ºç”Ÿã«ã‚ˆã‚‹éƒ¨éšŠã®å£«æ°—ä½ä¸‹ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒå¸¸ã«åŠæ¸›ã™ã‚‹ã€‚éå¸¸ã«ç²˜ã‚Šå¼·ã„ã€‚",
            "ç²›æ¸…": "ã€ç‰¹æ®Šã€‘å‘³æ–¹éƒ¨éšŠãŒæ•—èµ°ã—ãŸéš›ã€ç”Ÿå­˜è€…ã®åŠæ•°ã‚’å‡¦åˆ‘ã—ã€å£«æ°—ã‚’ã€Œç„¡é™ã€ã«ã—ã¦æ­»ã¬ã¾ã§æˆ¦ç·šã«ç•™ã¾ã‚‰ã›ã‚‹ã€‚",
            "è¡›ç”Ÿå…µ": "ã€æ•‘è­·ã€‘æ”»æ’ƒã®ä»£ã‚ã‚Šã«å‘³æ–¹ã®æ°—çµ¶è€…ã‚’å„ªå…ˆã—ã¦æ²»ç™‚ã™ã‚‹ã€‚ãƒ€ã‚¤ã‚¹ã®å‡ºç›®ã®åˆ†ã ã‘HPã‚’å›å¾©ã—ã€HPãŒåŠåˆ†ã‚’è¶…ãˆã‚‹ã¨æˆ¦ç·šå¾©å¸°(ç”Ÿå­˜)ã™ã‚‹ã€‚"
        };

        const DATABASE = {
            "ãƒ©ãƒ«ã‚­ã‚¢å›½å®¶ç¤¾ä¼šä¸»ç¾©äººæ°‘å…±å’Œå›½": {
                "ç¬¬31æ­©å…µå¤§éšŠ": { desc: "ç‹‚ä¿¡çš„ãªå›½å®¶ç¤¾ä¼šä¸»ç¾©ã®æ­©å…µå¤§éšŠã€‚è£…ç”²ã¯ãªã„ãŒã€é©å‘½ä¸‡æ­³ã®ç²¾ç¥ã§çµ¶ãˆé–“ãªã„çªæ’ƒã‚’ç¹°ã‚Šè¿”ã™ã€‚", size: 600, cat: "æœ€å‰è¡›éƒ¨éšŠ", morale: 50, agi: 30, arm: 0, hp: 10, fail: 40, gen: [1, 1], spc: [1, 3], reck: [1, 3], traits: ["é©å‘½ä¸‡æ­³"] },
                "ç¬¬4æ”¿æ²»ç›£æŸ»å§”å“¡ä¸­éšŠ": { desc: "å‘³æ–¹ã®æ•—èµ°ã‚’çµ¶å¯¾ã«è¨±ã•ãªã„æã‚‹ã¹ãç›£æŸ»å§”å“¡ã€‚æ•—èµ°éƒ¨éšŠã®åŠæ•°ã‚’å‡¦åˆ‘ã—ã€æ­»ã¬ã¾ã§æˆ¦ç·šã«ç¸›ã‚Šä»˜ã‘ã‚‹ã€‚", size: 100, cat: "å¾Œæ´éƒ¨éšŠ", morale: 200, agi: 30, arm: 0, hp: 10, fail: 30, gen: [1, 1], spc: [1, 2], reck: [1, 2], traits: ["é©å‘½ä¸‡æ­³", "ç²›æ¸…"] },
                "ç¬¬ã€‡æ©Ÿå‹•è£…ç”²ä¸­éšŠ": { desc: "é«˜æ©Ÿå‹•ã¨é‡è£…ç”²ã‚’å…¼ã­å‚™ãˆãŸç‰¹æ®Šè£…ç”²éƒ¨éšŠã€‚çµ¶å¤§ãªç«åŠ›ã‚’èª‡ã‚Šã€æ•µé™£ã‚’è¹‚èº™ã™ã‚‹ã€‚", size: 100, cat: "ç‰¹æ®Šéƒ¨éšŠ", morale: 100, agi: 80, arm: 3, hp: 10, fail: 50, gen: [1, 4], spc: [2, 3], reck: [3, 3], traits: ["é©å‘½ä¸‡æ­³"] },
                "ç¬¬ã€‡è¡›ç”Ÿä¸­éšŠ": { desc: "é«˜ã„æ©Ÿå‹•åŠ›ã§æˆ¦å ´ã‚’é§†ã‘å›ã‚Šã€å€’ã‚ŒãŸå‘³æ–¹ã‚’æˆ¦ç·šå¾©å¸°ã•ã›ã‚‹è£…ç”²æ•‘è­·éƒ¨éšŠã€‚é©šç•°ã®å›å¾©åŠ›ã‚’æŒã¤ã€‚", size: 100, cat: "ç‰¹æ®Šéƒ¨éšŠ", morale: 100, agi: 80, arm: 3, hp: 10, fail: 10, gen: [2, 3], spc: [3, 4], reck: [5, 6], traits: ["è¡›ç”Ÿå…µ"] }
            },
            "å…¨åœŸã‚«ãƒ«ãƒ´ã‚§ãƒŠé©å‘½æˆ¦ç·š": {
                "ç¬¬13é©å‘½ãƒ‘ãƒ«ãƒã‚¶ãƒ³å¤§éšŠ": { desc: "ç¥–å›½è§£æ”¾ã‚’æ²ã’ã‚‹æ°‘å…µå¤§éšŠã€‚è£…ç”²ã¯çš†ç„¡ã ãŒã€æ³¢çŠ¶æ”»æ’ƒã§æ•µã‚’åœ§å€’ã™ã‚‹ã€‚", size: 600, cat: "æœ€å‰è¡›éƒ¨éšŠ", morale: 200, agi: 0, arm: 0, hp: 10, fail: 60, gen: [1, 2], spc: [1, 2], reck: [1, 5], traits: ["é©å‘½ä¸‡æ­³"] },
                "å¾Œæ–¹æ”¯æ´ç ²å…µä¸­éšŠ": { desc: "å®‰å…¨ãªå¾Œæ–¹ã‹ã‚‰è‡´å‘½çš„ãªç ²æ’ƒã‚’è¡Œã†ã€‚æˆ¦å±€ã‚’è¦†ã™ç«åŠ›ã‚’èª‡ã‚‹ã€‚", size: 100, cat: "å¾Œæ´éƒ¨éšŠ", morale: 80, agi: 10, arm: 0, hp: 15, fail: 40, gen: [2, 4], spc: [3, 6], reck: [1, 6], traits: [] }
            },
            "ã‚«ãƒ«ãƒ´ã‚§ãƒŠå¸å›½": {
                "ç¬¬22æ­©å…µå¤§éšŠ": { desc: "ã‚«ãƒ«ãƒ´ã‚§ãƒŠå¸å›½ã®æ­£è¦æ­©å…µã€‚è¦å¾‹æ­£ã—ãã€çš‡å¸ã¸ã®çµ¶å¯¾ã®å¿ èª ã‚’èƒ¸ã«æˆ¦ç·šã‚’ç¶­æŒã™ã‚‹ã€‚", size: 600, cat: "æœ€å‰è¡›éƒ¨éšŠ", morale: 100, agi: 20, arm: 0, hp: 10, fail: 30, gen: [1, 2], spc: [1, 2], reck: [1, 3], traits: ["çš‡å¸é™›ä¸‹ä¸‡æ­³"] },
                "é‡è£…ç”²é˜²è¡›ä¸­éšŠ": { desc: "åˆ†åšã„è£…ç”²æœã‚’ç€è¾¼ã‚“ã é˜²è¡›ç‰¹åŒ–éƒ¨éšŠã€‚æ•µã®æ”»æ’ƒã‚’å¼¾ãè¿”ã—å‰ç·šã‚’ç¶­æŒã™ã‚‹ã€‚", size: 100, cat: "æœ€å‰è¡›éƒ¨éšŠ", morale: 120, agi: 5, arm: 3, hp: 20, fail: 30, gen: [1, 3], spc: [1, 4], reck: [1, 5], traits: [] }
            }
        };

        class Unit {
            constructor(name, preset, affiliation, team, id) {
                this.id = id; this.name = name; this.affiliation = affiliation; this.team = team; 
                this.category = preset.cat; this.size = preset.size; 
                this.morale = preset.morale; this.max_morale = preset.morale;
                this.agi = preset.agi; this.arm = preset.arm; this.hp = preset.hp || 10; this.fail = preset.fail;
                // â˜… é…åˆ—ã®ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼ï¼ˆè£…å‚™å¤‰æ›´ãŒä»–ã«å½±éŸ¿ã—ãªã„ãŸã‚ï¼‰
                this.dice = { "é€šå¸¸æ”»æ’ƒ": [...preset.gen], "ç‰¹æ®Šæ”»æ’ƒ": [...preset.spc], "ç„¡è¬€ãªæ”»æ’ƒ": [...preset.reck] };
                this.traits = preset.traits;
                
                this.hpList = new Array(this.size).fill(this.hp);
                this.statusList = new Array(this.size).fill(0); 
                this.isRouted = false;
                this.turnStartDead = 0; 
            }
            getActive() { return this.statusList.filter(s => s === 0).length; }
            getFaint() { return this.statusList.filter(s => s === 1 || s === 2).length; }
            getDead() { return this.statusList.filter(s => s === -1).length; }
            isAlive() { 
                if (this.max_morale === "/") return this.statusList.some(s => s !== -1);
                return !this.isRouted && this.statusList.some(s => s !== -1); 
            }
            
            takeDamage(dmg) {
                if (!this.isAlive() || roll100() <= this.fail) return { hit: false, killed: false };
                let actualDmg = Math.min(Math.max(0, dmg - this.arm), this.hp);
                let targets = [];
                for(let i=0; i<this.size; i++) if(this.statusList[i] >= 0) targets.push(i);
                if(targets.length === 0) return { hit: false, killed: false };
                let idx = targets[Math.floor(Math.random() * targets.length)];
                let oldHp = this.hpList[idx];
                this.hpList[idx] -= actualDmg;
                if (oldHp > 1 && this.hpList[idx] <= 0) this.hpList[idx] = 1;
                let killed = false;
                if (this.hpList[idx] <= this.hp / 2 && this.statusList[idx] === 0) this.statusList[idx] = 1;
                if (this.hpList[idx] <= 0) { this.statusList[idx] = -1; killed = true; }
                return { hit: true, killed: killed };
            }

            // â˜… æ–°è¦è¿½åŠ : æ²»ç™’ã‚·ã‚¹ãƒ†ãƒ ï¼ˆè¡›ç”Ÿå…µç”¨ï¼‰
            receiveHealing(amount) {
                let targets = [];
                // æ°—çµ¶è€…ã‚’å„ªå…ˆ
                for(let i=0; i<this.size; i++) if(this.statusList[i] === 1 || this.statusList[i] === 2) targets.push(i);
                // æ°—çµ¶è€…ãŒã„ãªã‘ã‚Œã°è² å‚·ã—ãŸç”Ÿå­˜è€…ã‚’å›å¾©
                if(targets.length === 0) {
                    for(let i=0; i<this.size; i++) if(this.statusList[i] === 0 && this.hpList[i] < this.hp) targets.push(i);
                }
                if(targets.length === 0) return false;

                let idx = targets[Math.floor(Math.random() * targets.length)];
                let oldStatus = this.statusList[idx];
                this.hpList[idx] += amount;
                if(this.hpList[idx] > this.hp) this.hpList[idx] = this.hp;

                // HPãŒåŠåˆ†ã‚’è¶…ãˆãŸã‚‰æ°—çµ¶ã‹ã‚‰å¾©å¸°ï¼ˆç”Ÿå­˜ï¼‰
                if(this.hpList[idx] > this.hp / 2 && (oldStatus === 1 || oldStatus === 2)) {
                    this.statusList[idx] = 0;
                    return true; // å¾©å¸°æˆåŠŸ
                }
                return false;
            }

            applyMoraleDamage(deathsThisTurn) {
                if (this.max_morale === "/" || this.isRouted || deathsThisTurn <= 0) return false;
                let baseDmg = deathsThisTurn + roll(20);
                if (this.traits.includes("çš‡å¸é™›ä¸‹ä¸‡æ­³")) baseDmg = Math.floor(baseDmg / 2);
                if (this.traits.includes("é©å‘½ä¸‡æ­³") && roll100() <= 30) baseDmg = 0;
                if (baseDmg > 0) {
                    this.morale -= baseDmg;
                    logHTML(`<span class="log-sys"> â”” [å£«æ°—å¤‰å‹•] ${this.name}: -${baseDmg} (æ®‹:${this.morale})</span>`);
                }
                if (this.morale <= 0) return true; 
                return false;
            }
        }

        let teams = { "A": [], "B": [] };
        let turn = 1; let isBattling = false; let autoMode = false; let unitCounter = 0; let isProcessingTurn = false;

        function initSetup() {
            const setupList = document.getElementById("setup-list");
            for (let [faction, units] of Object.entries(DATABASE)) {
                let factionHTML = `<details class="faction-group"><summary class="faction-summary">ğŸŒ ${faction}</summary>`;
                for (let [key, data] of Object.entries(units)) {
                    let traitsHtml = `<div>[ç‰¹æ€§] ãªã—</div>`;
                    if (data.traits.length > 0) {
                        let traitItems = data.traits.map(t => `<li><span class="trait-name">${t}</span>: ${TRAIT_DESCRIPTIONS[t]}</li>`).join('');
                        traitsHtml = `<div class="trait-box"><span style="color:var(--cyan); font-weight:bold;">â—† ç‰¹æ€§è§£èª¬</span><ul>${traitItems}</ul></div>`;
                    }
                    factionHTML += `
                        <details class="unit-details">
                            <summary class="unit-summary">${key}</summary>
                            <div class="preset-info">
                                <div class="flavor-text">"${data.desc}"</div>
                                <div class="stat-grid">
                                    <div>[å…µç§‘] ${data.cat}</div><div>[è¦æ¨¡] ${data.size}å</div>
                                    <div>[å£«æ°—] ${data.morale}</div><div>[è£…ç”²] ${data.arm} / [æ©Ÿå‹•] ${data.agi}</div>
                                    <div>[HP] ${data.hp || 10} / [å¤±æ•—ç‡] ${data.fail}%</div>
                                    ${traitsHtml}
                                </div>
                                <div class="action-btns">
                                    <div class="btn-row">
                                        <span style="font-size:11px;">è£…å‚™:</span>
                                        <select id="equip-${key}" style="flex:1;">
                                            <option value="none">ãªã—</option>
                                            <option value="machinegun">æ©Ÿé–¢éŠƒ (+2D1ç‰¹æ®Š / æ­©å…µå¤§éšŠç”¨)</option>
                                            <option value="armor">è¿½åŠ è£…ç”² (+1è£…ç”² -50æ©Ÿå‹• / ç„¡è£…ç”²ç”¨)</option>
                                        </select>
                                    </div>
                                    <div class="btn-row">
                                        <span style="font-size:11px;">æ•°:</span>
                                        <input type="number" id="cnt-${key}" value="1" min="1" max="5" style="width:35px; text-align:center;">
                                        <button class="btn-a" onclick="addUnit('${faction}', '${key}', 'A')">â—€ Aè»ã¸</button>
                                        <button class="btn-b" onclick="addUnit('${faction}', '${key}', 'B')">Bè»ã¸ â–¶</button>
                                    </div>
                                </div>
                            </div>
                        </details>
                    `;
                }
                factionHTML += `</details>`;
                setupList.innerHTML += factionHTML;
            }
        }

        function logHTML(html) {
            const area = document.getElementById("log-area");
            area.innerHTML += `<div>${html}</div>`;
            area.scrollTop = area.scrollHeight;
        }

        // â˜… æ–°è¦: è£…å‚™ã‚·ã‚¹ãƒ†ãƒ å¯¾å¿œã®é…å‚™å‡¦ç†
        function addUnit(faction, key, team) {
            if(isBattling) return;
            let data = DATABASE[faction][key];
            let count = parseInt(document.getElementById(`cnt-${key}`).value);
            let equip = document.getElementById(`equip-${key}`).value;

            // è£…å‚™ã®è£…ç€åˆ¶é™ãƒã‚§ãƒƒã‚¯
            if (equip === "machinegun") {
                if (data.size !== 600 || !key.includes("æ­©å…µ")) {
                    alert("ã€æ©Ÿé–¢éŠƒã€‘ã¯ã€Œæ­©å…µã€ã¨åã®ä»˜ãå¤§éšŠ(600å)ã«ã®ã¿è£…å‚™å¯èƒ½ã§ã™ï¼");
                    return;
                }
            } else if (equip === "armor") {
                if (data.arm > 0) {
                    alert("ã€è¿½åŠ è£…ç”²ã€‘ã¯å…ƒã®è£…ç”²ãŒ0ã®ãƒ¦ãƒ‹ãƒƒãƒˆã«ã®ã¿è£…å‚™å¯èƒ½ã§ã™ï¼");
                    return;
                }
            }

            for(let i=0; i<count; i++) {
                let id = `u_${team}_${unitCounter++}`;
                let unit = new Unit(key, data, faction, team, id);

                // è£…å‚™ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è£œæ­£
                if (equip === "machinegun") {
                    unit.name += " (æ©Ÿé–¢éŠƒ)";
                    unit.dice["ç‰¹æ®Šæ”»æ’ƒ"][0] += 2; // +2D
                    unit.dice["ç‰¹æ®Šæ”»æ’ƒ"][1] += 1; // D+1
                } else if (equip === "armor") {
                    unit.name += " (è£…ç”²)";
                    unit.agi -= 50;
                    unit.arm += 1;
                }
                teams[team].push(unit);
            }
            updateUI();
        }

        function removeUnit(team, id) {
            if(isBattling) return;
            teams[team] = teams[team].filter(u => u.id !== id);
            updateUI();
        }

        function updateUI() {
            let totalA = 0; let totalB = 0;

            ["A", "B"].forEach(t => {
                const list = document.getElementById(`list-${t.toLowerCase()}`);
                list.innerHTML = "";
                let teamTotal = 0;

                teams[t].forEach(u => {
                    let a = u.getActive(), f = u.getFaint(), d = u.getDead();
                    teamTotal += a; 
                    
                    let aPct = (a/u.size)*100, fPct = (f/u.size)*100, dPct = (d/u.size)*100;
                    let mPct = u.max_morale === "/" ? 100 : Math.max(0, (u.morale/u.max_morale)*100);
                    let st = u.isRouted ? "æ•—èµ°" : (d >= u.size ? "å…¨æ»…" : "æˆ¦é—˜ä¸­");
                    let nameColor = u.max_morale === "/" ? "#dc2626" : (u.isRouted ? "var(--red)" : "var(--green)");
                    
                    let delBtn = !isBattling ? `<button class="btn-del" onclick="removeUnit('${t}', '${u.id}')">âœ–</button>` : '';

                    list.innerHTML += `
                        <div class="unit-card ${t.toLowerCase()}" style="${u.isRouted || d>=u.size ? 'opacity:0.5' : ''}">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                <span class="affiliation-tag">${u.affiliation}</span>
                                ${delBtn}
                            </div>
                            <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:4px;">
                                <span>${u.name}</span><span style="color:${nameColor}">${st}</span>
                            </div>
                            <div class="bar-wrap">
                                <div class="bar-hp" style="width:${aPct}%"></div>
                                <div class="bar-faint" style="width:${fPct}%"></div>
                                <div class="bar-dead" style="width:${dPct}%"></div>
                                <div class="bar-text">ç”Ÿå­˜:${a} / æ°—çµ¶:${f} / æ­»è€…:${d}</div>
                            </div>
                            <div class="bar-wrap">
                                <div class="bar-morale" style="width:${mPct}%"></div>
                                <div class="bar-text">å£«æ°—: ${u.max_morale === "/" ? "ç„¡é™" : u.morale}</div>
                            </div>
                        </div>
                    `;
                });

                if(t === "A") { totalA = teamTotal; document.getElementById("title-a").innerHTML = `[A] æ”»æ’ƒè» <span style="font-size:11px; color:var(--text-muted);">(ç·ç”Ÿå­˜è€…: ${totalA}å)</span>`; }
                if(t === "B") { totalB = teamTotal; document.getElementById("title-b").innerHTML = `[B] é˜²è¡›è» <span style="font-size:11px; color:var(--text-muted);">(ç·ç”Ÿå­˜è€…: ${totalB}å)</span>`; }
            });

            document.querySelectorAll('.map-zone').forEach(el => el.innerHTML = '');
            const placeOnMap = (u, cl) => {
                let zone = (u.category === "å¾Œæ´éƒ¨éšŠ" || u.category === "æœ€å¾Œè¡›éƒ¨éšŠ") ? `zone-${cl}-back` : `zone-${cl}-front`;
                let stateCl = u.isAlive() ? cl : "dead";
                document.getElementById(zone).innerHTML += `<div class="map-unit ${stateCl}" id="map-${u.id}">${u.name} <br>(${u.getActive()}å)</div>`;
            };
            teams.A.forEach(u => placeOnMap(u, 'a'));
            teams.B.forEach(u => placeOnMap(u, 'b'));
        }

        function getTarget(enemyTeam, category) {
            let enemies = teams[enemyTeam].filter(u => u.isAlive());
            if(!enemies.length) return null;
            let possible = enemies.filter(u => u.category === category);
            if(!possible.length) return enemies[Math.floor(Math.random() * enemies.length)];
            possible.sort((a,b) => a.agi - b.agi);
            let minAgi = possible[0].agi;
            let candidates = possible.filter(u => u.agi === minAgi);
            return candidates[Math.floor(Math.random() * candidates.length)];
        }

        function startBattle() {
            if(!teams.A.length || !teams.B.length) return;
            isBattling = true;
            document.getElementById("btn-start").disabled = true;
            document.getElementById("btn-next").disabled = false;
            document.getElementById("btn-auto").disabled = false;
            logHTML(`<div class="log-turn" style="font-size:16px;">âš”ï¸ BATTLE START âš”ï¸</div>`);
            updateUI(); 
        }

        async function playAnimation(id, animClass, duration) {
            let el = document.getElementById(`map-${id}`);
            if(!el) return;
            el.classList.remove(animClass);
            void el.offsetWidth;
            el.classList.add(animClass);
            await sleep(duration);
            el.classList.remove(animClass);
        }

        function toggleAuto() {
            let btn = document.getElementById("btn-auto");
            if (autoMode) {
                autoMode = false;
                btn.innerHTML = "â© è‡ªå‹•å®Ÿè¡Œ";
                btn.style.background = ""; 
                if (!isProcessingTurn) document.getElementById("btn-next").disabled = false;
            } else {
                autoMode = true;
                btn.innerHTML = "â¸ ä¸€æ™‚åœæ­¢";
                btn.style.background = "#eab308"; 
                btn.style.color = "#000";
                document.getElementById("btn-next").disabled = true;
                if (!isProcessingTurn) runTurn();
            }
        }

        async function runTurn() {
            if(isProcessingTurn) return;
            isProcessingTurn = true;
            document.getElementById("btn-next").disabled = true;

            logHTML(`<div class="log-turn">â–¼ TURN ${turn} â–¼</div>`);
            
            [...teams.A, ...teams.B].forEach(u => u.turnStartDead = u.getDead());

            let cats = ["ç‰¹æ®Šéƒ¨éšŠ", "æœ€å¾Œè¡›éƒ¨éšŠ", "æœ€å‰è¡›éƒ¨éšŠ", "å¾Œæ´éƒ¨éšŠ"];
            for (let cat of cats) {
                for (let side of ["A", "B"]) {
                    let enemySide = side === "A" ? "B" : "A";
                    
                    for (let atk of teams[side]) {
                        if (atk.category !== cat || !atk.isAlive()) continue;
                        
                        let isMedic = atk.traits.includes("è¡›ç”Ÿå…µ");
                        let target;

                        // â˜… è¡›ç”Ÿå…µã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆé¸æŠï¼ˆå‘³æ–¹ã‚’å›å¾©ï¼‰
                        if(isMedic) {
                            let allies = teams[atk.team].filter(u => u.isAlive() && u.getFaint() > 0);
                            if(allies.length === 0) allies = teams[atk.team].filter(u => u.isAlive() && u.getActive() > 0 && u !== atk);
                            if(allies.length === 0) allies = [atk]; // èª°ã‚‚ã„ãªã‘ã‚Œã°è‡ªåˆ†ã‚’å›å¾©
                            target = allies[Math.floor(Math.random() * allies.length)];
                        } else {
                            let r = roll100();
                            let tgtCat = r === 1 ? "ç‰¹æ®Šéƒ¨éšŠ" : (r === 2 ? "æœ€å¾Œè¡›éƒ¨éšŠ" : (r <= 13 ? "å¾Œæ´éƒ¨éšŠ" : "æœ€å‰è¡›éƒ¨éšŠ"));
                            target = getTarget(enemySide, tgtCat);
                        }
                        
                        if (!target) continue;

                        let p1 = playAnimation(atk.id, 'anim-atk', 400);
                        let p2 = playAnimation(target.id, isMedic ? 'anim-heal' : 'anim-def', 400);
                        await Promise.all([p1, p2]);

                        let actRoll = roll(6);
                        let atkType = actRoll === 1 ? "ç‰¹æ®Šæ”»æ’ƒ" : (actRoll === 6 ? "ç„¡è¬€ãªæ”»æ’ƒ" : "é€šå¸¸æ”»æ’ƒ");
                        let [dNum, dSide] = atk.dice[atkType];
                        
                        let hits = 0, kills = 0, selfKills = 0, revives = 0;
                        let activeMen = atk.getActive();

                        for (let i=0; i<activeMen; i++) {
                            let dmg = 0; for
