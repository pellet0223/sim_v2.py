<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TACTICAL COMMAND DUAL - Ver3.0</title>
    <style>
        :root {
            --bg-dark: #050b14; --panel-bg: #0f172a; --panel-border: #1e293b;
            --cyan: #06b6d4; --red: #ef4444; --green: #10b981; --yellow: #eab308; --blue: #3b82f6;
            --text-main: #f8fafc; --text-muted: #64748b;
        }
        * { box-sizing: border-box; }
        body { margin: 0; padding: 10px; background: var(--bg-dark); color: var(--text-main); font-family: 'Segoe UI', Meiryo, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        h1 { text-align: center; margin: 0 0 10px 0; font-size: 20px; color: var(--cyan); text-shadow: 0 0 10px rgba(6,182,212,0.5); letter-spacing: 2px; }

        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .top-section { display: flex; gap: 10px; height: 35%; min-height: 250px; margin-bottom: 10px; }
        .bottom-section { display: flex; gap: 10px; flex: 1; min-height: 0; }
        .panel { background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: 6px; padding: 10px; display: flex; flex-direction: column; overflow: hidden; }
        .panel-title { font-size: 14px; font-weight: bold; border-bottom: 1px solid var(--panel-border); padding-bottom: 5px; margin-bottom: 10px; color: #fff; }

        /* ç·¨æˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ */
        .setup-panel { flex: 1; overflow-y: auto; }
        details { background: #1e293b; border-radius: 4px; margin-bottom: 5px; border: 1px solid var(--panel-border); }
        summary { padding: 10px; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; align-items: center; outline: none; }
        summary:hover { background: #334155; }
        .preset-info { padding: 10px; background: #0f172a; border-top: 1px solid var(--panel-border); font-size: 12px; }
        .flavor-text { color: var(--cyan); font-style: italic; margin-bottom: 8px; border-left: 3px solid var(--cyan); padding-left: 8px; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; color: var(--text-muted); margin-bottom: 10px; }
        .action-btns { display: flex; gap: 5px; justify-content: space-between; }
        button { background: var(--blue); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { filter: brightness(1.2); }
        button:disabled { background: #475569; color: #94a3b8; cursor: not-allowed; }
        .btn-a { background: var(--cyan); color: #000; } .btn-b { background: var(--red); }

        /* æˆ¦è¡“ãƒãƒƒãƒ— */
        .map-panel { flex: 2; position: relative; display: flex; flex-direction: column; }
        .battlefield { flex: 1; display: flex; justify-content: space-between; background: repeating-linear-gradient(0deg, #050b14, #050b14 20px, #0a1120 20px, #0a1120 40px); border: 1px solid #334155; border-radius: 4px; position: relative; padding: 10px; overflow: hidden; }
        .map-zone { display: flex; flex-direction: column; justify-content: center; gap: 5px; width: 20%; }
        .map-center { width: 10%; border-left: 2px dashed #ef4444; border-right: 2px dashed #06b6d4; opacity: 0.5; }
        .map-unit { background: #1e293b; border: 1px solid #fff; padding: 5px; text-align: center; border-radius: 4px; font-size: 10px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: 0.3s; }
        .map-unit.a { border-color: var(--cyan); color: var(--cyan); box-shadow: 0 0 5px var(--cyan); }
        .map-unit.b { border-color: var(--red); color: var(--red); box-shadow: 0 0 5px var(--red); }
        .map-unit.atk { transform: scale(1.1); background: #fff; color: #000; z-index: 10;}
        .map-unit.def { transform: scale(0.9); background: #9f1239; animation: shake 0.3s; }
        .map-unit.dead { opacity: 0.2; border-color: #475569; box-shadow: none; color: #475569; }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 20% { transform: translate(-1px, -2px) rotate(-1deg); } 40% { transform: translate(-3px, 0px) rotate(1deg); } 60% { transform: translate(3px, 2px) rotate(0deg); } 80% { transform: translate(1px, -1px) rotate(1deg); } 100% { transform: translate(0, 0) rotate(0deg); } }

        /* ãƒªã‚¹ãƒˆã¨ãƒ­ã‚° */
        .list-panel { flex: 1; overflow-y: auto; }
        .log-panel { flex: 1.5; overflow-y: auto; background: #020617; font-family: var(--font-mono); font-size: 13px; line-height: 1.5; padding: 10px; border: 1px solid var(--panel-border); }
        
        /* ãƒ¦ãƒ‹ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ */
        .unit-card { background: #0f172a; border-left: 3px solid #475569; padding: 8px; margin-bottom: 8px; border-radius: 4px; font-size: 12px; }
        .unit-card.a { border-left-color: var(--cyan); } .unit-card.b { border-left-color: var(--red); }
        .bar-wrap { height: 12px; background: #000; border-radius: 2px; margin-top: 4px; position: relative; display: flex; }
        .bar-hp { background: var(--green); transition: 0.3s; }
        .bar-faint { background: var(--yellow); transition: 0.3s; }
        .bar-dead { background: var(--red); transition: 0.3s; }
        .bar-morale { background: var(--blue); transition: 0.3s; }
        .bar-text { position: absolute; width: 100%; text-align: center; font-size: 9px; line-height: 12px; font-weight: bold; color: #fff; text-shadow: 1px 1px 1px #000; }

        .log-turn { color: var(--yellow); font-weight: bold; margin-top: 10px; border-bottom: 1px dashed #334155; }
        .log-atk { color: #c084fc; } .log-dmg { color: #cbd5e1; } .log-fatal { color: var(--red); font-weight: bold; }
        .log-route { color: #fff; background: #9f1239; padding: 2px 4px; font-weight: bold; }
        .controls { display: flex; gap: 5px; margin-top: 10px; justify-content: center; }
    </style>
</head>
<body>

    <h1>TACTICAL COMMAND DUAL v3.0</h1>

    <div class="top-section">
        <div class="panel setup-panel">
            <div class="panel-title">â–¼ éƒ¨éšŠãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°)</div>
            <div id="setup-list"></div>
        </div>

        <div class="panel map-panel">
            <div class="panel-title">ğŸ“¡ æˆ¦è¡“ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒƒãƒ—</div>
            <div class="battlefield" id="battlefield">
                <div class="map-zone" id="zone-a-back"></div>
                <div class="map-zone" id="zone-a-front"></div>
                <div class="map-center"></div>
                <div class="map-zone" id="zone-b-front"></div>
                <div class="map-zone" id="zone-b-back"></div>
            </div>
            <div class="controls">
                <button id="btn-start" onclick="startBattle()" style="background: var(--green);">âš”ï¸ æˆ¦é—˜é–‹å§‹</button>
                <button id="btn-next" onclick="runTurn()" disabled>â­ æ¬¡ã‚¿ãƒ¼ãƒ³</button>
                <button id="btn-auto" onclick="runAuto()" disabled>â© è‡ªå‹•å®Ÿè¡Œ</button>
                <button onclick="resetGame()" style="background: var(--red);">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
        </div>
    </div>

    <div class="bottom-section">
        <div class="panel list-panel" id="panel-a"><div class="panel-title" style="color:var(--cyan)">[A] æ”»æ’ƒè»</div><div id="list-a"></div></div>
        <div class="panel log-panel" id="log-area"><div style="color:var(--text-muted)">SYSTEM: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰èµ·å‹•ã€‚éƒ¨éšŠã‚’é…å‚™ã›ã‚ˆã€‚</div></div>
        <div class="panel list-panel" id="panel-b"><div class="panel-title" style="color:var(--red)">[B] é˜²è¡›è»</div><div id="list-b"></div></div>
    </div>

    <script>
        const roll = (sides) => Math.floor(Math.random() * sides) + 1;
        const roll100 = () => Math.floor(Math.random() * 100) + 1;

        // â˜… æ–°æ©Ÿèƒ½ï¼šãƒ•ãƒ¬ãƒ¼ãƒãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã¨è©³ç´°ãƒ‡ãƒ¼ã‚¿
        const PRESETS = {
            "ç¬¬13é©å‘½ãƒ‘ãƒ«ãƒã‚¶ãƒ³å¤§éšŠ": { desc: "ç¥–å›½è§£æ”¾ã‚’æ²ã’ã‚‹æ°‘å…µå¤§éšŠã€‚è£…ç”²ã¯çš†ç„¡ã ãŒã€æ­»ã‚’æã‚Œã¬æ³¢çŠ¶æ”»æ’ƒã§æ•µã‚’åœ§å€’ã™ã‚‹ã€‚", size: 600, cat: "æœ€å‰è¡›éƒ¨éšŠ", morale: 200, agi: 0, arm: 0, hp: 10, fail: 60, gen: [1, 2], spc: [1, 2], reck: [1, 5], traits: ["é©å‘½ä¸‡æ­³"] },
            "ç¬¬22æ­©å…µå¤§éšŠ": { desc: "ã‚«ãƒ«ãƒ´ã‚§ãƒŠå¸å›½ã®æ­£è¦æ­©å…µã€‚è¦å¾‹æ­£ã—ãã€çš‡å¸ã¸ã®çµ¶å¯¾ã®å¿ èª ã‚’èƒ¸ã«æˆ¦ç·šã‚’ç¶­æŒã™ã‚‹ã€‚", size: 600, cat: "æœ€å‰è¡›éƒ¨éšŠ", morale: 100, agi: 20, arm: 0, hp: 10, fail: 30, gen: [1, 2], spc: [1, 2], reck: [1, 3], traits: ["çš‡å¸é™›ä¸‹ä¸‡æ­³"] },
            "é‡è£…ç”²é˜²è¡›ä¸­éšŠ": { desc: "åˆ†åšã„è£…ç”²æœã‚’ç€è¾¼ã‚“ã é˜²è¡›ç‰¹åŒ–éƒ¨éšŠã€‚æ•µã®æ”»æ’ƒã‚’å¼¾ãè¿”ã—ã€ã˜ã‚ã˜ã‚ã¨å‰ç·šã‚’æŠ¼ã—ä¸Šã’ã‚‹ã€‚", size: 100, cat: "æœ€å‰è¡›éƒ¨éšŠ", morale: 120, agi: 5, arm: 3, hp: 20, fail: 30, gen: [1, 3], spc: [1, 4], reck: [1, 5], traits: [] },
            "å¾Œæ–¹æ”¯æ´ç ²å…µä¸­éšŠ": { desc: "å®‰å…¨ãªå¾Œæ–¹ã‹ã‚‰è‡´å‘½çš„ãªç ²æ’ƒã‚’è¡Œã†ã€‚æ¥è¿‘æˆ¦ã«ã¯å¼±ã„ãŒã€æˆ¦å±€ã‚’è¦†ã™ç«åŠ›ã‚’èª‡ã‚‹ã€‚", size: 100, cat: "å¾Œæ´éƒ¨éšŠ", morale: 80, agi: 10, arm: 0, hp: 15, fail: 40, gen: [2, 4], spc: [3, 6], reck: [1, 6], traits: [] },
            "ç‰¹æ®Šæš—æ®ºéƒ¨éšŠ 'å½±'": { desc: "é—‡ã«ç´›ã‚Œã¦æ•µå°†ã®é¦–ã‚’ç‹™ã†æ¥µç§˜éƒ¨éšŠã€‚æ¥µã‚ã¦é«˜ã„æ©Ÿå‹•åŠ›ã§å¥‡è¥²ã‚’æ›ã‘ã‚‹ã€‚", size: 20, cat: "ç‰¹æ®Šéƒ¨éšŠ", morale: 150, agi: 80, arm: 1, hp: 25, fail: 10, gen: [2, 6], spc: [3, 6], reck: [1, 10], traits: [] }
        };

        class Unit {
            constructor(name, preset, team, id) {
                this.id = id; this.name = name; this.team = team; this.category = preset.cat;
                this.size = preset.size; this.morale = preset.morale; this.max_morale = preset.morale;
                this.agi = preset.agi; this.arm = preset.arm; this.hp = preset.hp; this.fail = preset.fail;
                this.dice = { "é€šå¸¸æ”»æ’ƒ": preset.gen, "ç‰¹æ®Šæ”»æ’ƒ": preset.spc, "ç„¡è¬€ãªæ”»æ’ƒ": preset.reck };
                this.traits = preset.traits;
                
                this.hpList = new Array(this.size).fill(this.hp);
                this.statusList = new Array(this.size).fill(0); // 0:ç”Ÿå­˜, 1-2:æ°—çµ¶, -1:æ­»äº¡
                this.isRouted = false;
            }

            getActive() { return this.statusList.filter(s => s === 0).length; }
            getFaint() { return this.statusList.filter(s => s === 1 || s === 2).length; }
            getDead() { return this.statusList.filter(s => s === -1).length; }
            isAlive() { return !this.isRouted && this.statusList.some(s => s !== -1); }

            takeDamage(dmg) {
                if (!this.isAlive() || roll100() <= this.fail) return { hit: false, killed: false };
                
                let actualDmg = Math.min(Math.max(0, dmg - this.arm), this.hp);
                let targets = [];
                for(let i=0; i<this.size; i++) if(this.statusList[i] >= 0) targets.push(i);
                if(targets.length === 0) return { hit: false, killed: false };

                let idx = targets[Math.floor(Math.random() * targets.length)];
                let oldHp = this.hpList[idx];
                this.hpList[idx] -= actualDmg;
                if (oldHp > 0 && this.hpList[idx] <= 0) this.hpList[idx] = 1;

                let killed = false;
                if (this.hpList[idx] <= this.hp / 2 && this.statusList[idx] === 0) {
                    this.statusList[idx] = 1;
                } else if (this.hpList[idx] <= 0) {
                    this.statusList[idx] = -1;
                    killed = true;
                }
                return { hit: true, killed: killed };
            }

            // â˜… æ–°æ©Ÿèƒ½ï¼šå£«æ°—ãƒªãƒ¯ãƒ¼ã‚¯ï¼ˆã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ã«ã¾ã¨ã‚ã¦åˆ¤å®šï¼‰
            applyMoraleDamage(deathsThisTurn) {
                if (this.max_morale === "/" || this.isRouted || deathsThisTurn === 0) return false;
                
                // æ­»äº¡è€…æ•° ï¼‹ 1D20ï¼ˆææ€–åˆ¤å®šï¼‰ã§å£«æ°—ãŒã‚´ãƒªã‚´ãƒªå‰Šã‚Œã‚‹
                let baseDmg = deathsThisTurn + roll(20);
                if (this.traits.includes("çš‡å¸é™›ä¸‹ä¸‡æ­³")) baseDmg = Math.floor(baseDmg / 2); // çš‡å¸ä¸‡æ­³ã¯å£«æ°—ãƒ€ãƒ¡åŠæ¸›
                if (this.traits.includes("é©å‘½ä¸‡æ­³") && roll100() < 30) baseDmg = 0; // é©å‘½ä¸‡æ­³ã¯ãŸã¾ã«å£«æ°—ãƒ€ãƒ¡ç„¡åŠ¹
                
                this.morale -= baseDmg;
                logHTML(`<span class="log-sys"> â”” [å£«æ°—å¤‰å‹•] ${this.name}: -${baseDmg} (æ®‹:${this.morale})</span>`);
                
                if (this.morale <= 0) {
                    this.isRouted = true;
                    for(let i=0; i<this.size; i++) if(this.statusList[i] > 0) this.statusList[i] = -1; // æ°—çµ¶è€…ã¯æ­»äº¡
                    return true; // æ•—èµ°ã—ãŸ
                }
                return false;
            }
        }

        let teams = { "A": [], "B": [] };
        let turn = 1; let isBattling = false; let autoInterval = null; let unitCounter = 0;

        // --- åˆæœŸåŒ–ï¼†UIæ›´æ–° ---
        function initSetup() {
            const setupList = document.getElementById("setup-list");
            for (let [key, data] of Object.entries(PRESETS)) {
                setupList.innerHTML += `
                    <details>
                        <summary>${key} <span style="font-size:10px; color:#64748b;">(è©³ç´°)</span></summary>
                        <div class="preset-info">
                            <div class="flavor-text">"${data.desc}"</div>
                            <div class="stat-grid">
                                <div>[å…µç§‘] ${data.cat}</div>
                                <div>[è¦æ¨¡] ${data.size}å</div>
                                <div>[å£«æ°—] ${data.morale}</div>
                                <div>[è£…ç”²] ${data.arm} / [æ©Ÿå‹•] ${data.agi}</div>
                                <div>[HP] ${data.hp} / [å¤±æ•—ç‡] ${data.fail}%</div>
                                <div>[ç‰¹æ€§] ${data.traits.length > 0 ? data.traits.join(',') : 'ãªã—'}</div>
                            </div>
                            <div class="action-btns">
                                <input type="number" id="cnt-${key}" value="1" min="1" max="5" style="width:40px;">
                                <button class="btn-a" onclick="addUnit('${key}', 'A')">Aã«é…å‚™</button>
                                <button class="btn-b" onclick="addUnit('${key}', 'B')">Bã«é…å‚™</button>
                            </div>
                        </div>
                    </details>
                `;
            }
        }

        function logHTML(html) {
            const area = document.getElementById("log-area");
            area.innerHTML += `<div>${html}</div>`;
            area.scrollTop = area.scrollHeight;
        }

        function addUnit(key, team) {
            if(isBattling) return;
            let count = parseInt(document.getElementById(`cnt-${key}`).value);
            for(let i=0; i<count; i++) {
                let id = `u_${team}_${unitCounter++}`;
                teams[team].push(new Unit(key, PRESETS[key], team, id));
            }
            updateUI();
        }

        function updateUI() {
            // ãƒªã‚¹ãƒˆã®æ›´æ–°
            ["A", "B"].forEach(t => {
                const list = document.getElementById(`list-${t.toLowerCase()}`);
                list.innerHTML = "";
                teams[t].forEach(u => {
                    let a = u.getActive(), f = u.getFaint(), d = u.getDead();
                    let aPct = (a/u.size)*100, fPct = (f/u.size)*100, dPct = (d/u.size)*100;
                    let mPct = u.max_morale === "/" ? 100 : Math.max(0, (u.morale/u.max_morale)*100);
                    let st = u.isRouted ? "æ•—èµ°" : (d >= u.size ? "å…¨æ»…" : "æˆ¦é—˜ä¸­");
                    
                    list.innerHTML += `
                        <div class="unit-card ${t.toLowerCase()}" style="${u.isRouted || d>=u.size ? 'opacity:0.5' : ''}">
                            <div style="display:flex; justify-content:space-between; font-weight:bold;">
                                <span>${u.name}</span><span style="color:${u.isRouted?'var(--red)':'var(--green)'}">${st}</span>
                            </div>
                            <div class="bar-wrap">
                                <div class="bar-hp" style="width:${aPct}%"></div>
                                <div class="bar-faint" style="width:${fPct}%"></div>
                                <div class="bar-dead" style="width:${dPct}%"></div>
                                <div class="bar-text">ç”Ÿå­˜:${a} / æ°—çµ¶:${f} / æ­»è€…:${d}</div>
                            </div>
                            <div class="bar-wrap">
                                <div class="bar-morale" style="width:${mPct}%"></div>
                                <div class="bar-text">å£«æ°—: ${u.morale}</div>
                            </div>
                        </div>
                    `;
                });
            });

            // ãƒãƒƒãƒ—ã®æ›´æ–° (æœ€å‰è¡›ã¯ä¸­å¤®å¯„ã‚Šã€å¾Œæ´ã¯ç«¯)
            document.querySelectorAll('.map-zone').forEach(el => el.innerHTML = '');
            teams.A.forEach(u => {
                let zone = (u.category === "å¾Œæ´éƒ¨éšŠ" || u.category === "æœ€å¾Œè¡›éƒ¨éšŠ") ? "zone-a-back" : "zone-a-front";
                let cl = u.isAlive() ? "a" : "dead";
                document.getElementById(zone).innerHTML += `<div class="map-unit ${cl}" id="map-${u.id}">${u.name.replace('A: ','')} <br>(${u.getActive()}å)</div>`;
            });
            teams.B.forEach(u => {
                let zone = (u.category === "å¾Œæ´éƒ¨éšŠ" || u.category === "æœ€å¾Œè¡›éƒ¨éšŠ") ? "zone-b-back" : "zone-b-front";
                let cl = u.isAlive() ? "b" : "dead";
                document.getElementById(zone).innerHTML += `<div class="map-unit ${cl}" id="map-${u.id}">${u.name.replace('B: ','')} <br>(${u.getActive()}å)</div>`;
            });
        }

        // --- ãƒãƒˆãƒ«ãƒ­ã‚¸ãƒƒã‚¯ ---
        function getTarget(enemyTeam, category) {
            let enemies = teams[enemyTeam].filter(u => u.isAlive());
            if(!enemies.length) return null;
            let possible = enemies.filter(u => u.category === category);
            if(!possible.length) return enemies[Math.floor(Math.random() * enemies.length)]; // è¶…éå‡¦ç†
            possible.sort((a,b) => a.agi - b.agi);
            let minAgi = possible[0].agi;
            let candidates = possible.filter(u => u.agi === minAgi);
            return candidates[Math.floor(Math.random() * candidates.length)];
        }

        async function startBattle() {
            if(!teams.A.length || !teams.B.length) return;
            isBattling = true;
            document.getElementById("btn-start").disabled = true;
            document.getElementById("btn-next").disabled = false;
            document.getElementById("btn-auto").disabled = false;
            logHTML(`<div class="log-turn" style="font-size:16px;">âš”ï¸ BATTLE START âš”ï¸</div>`);
        }

        // ãƒãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
        function flashMapUnit(id, type) {
            let el = document.getElementById(`map-${id}`);
            if(el) {
                el.classList.add(type);
                setTimeout(() => el.classList.remove(type), 400);
            }
        }

        function runTurn() {
            logHTML(`<div class="log-turn">â–¼ TURN ${turn} â–¼</div>`);
            
            // å„éƒ¨éšŠã®ã‚¿ãƒ¼ãƒ³ã®æ­»è€…ã‚’è¨˜éŒ²ã™ã‚‹å¤‰æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
            let deathsThisTurn = {};
            [...teams.A, ...teams.B].forEach(u => deathsThisTurn[u.id] = 0);

            let cats = ["ç‰¹æ®Šéƒ¨éšŠ", "æœ€å¾Œè¡›éƒ¨éšŠ", "æœ€å‰è¡›éƒ¨éšŠ", "å¾Œæ´éƒ¨éšŠ"];
            for (let cat of cats) {
                for (let side of ["A", "B"]) {
                    let enemySide = side === "A" ? "B" : "A";
                    
                    teams[side].forEach(atk => {
                        if (atk.category !== cat || !atk.isAlive()) return;
                        
                        let r = roll100();
                        let tgtCat = r === 1 ? "ç‰¹æ®Šéƒ¨éšŠ" : (r === 2 ? "æœ€å¾Œè¡›éƒ¨éšŠ" : (r <= 13 ? "å¾Œæ´éƒ¨éšŠ" : "æœ€å‰è¡›éƒ¨éšŠ"));
                        let target = getTarget(enemySide, tgtCat);
                        if (!target) return;

                        flashMapUnit(atk.id, 'atk');
                        flashMapUnit(target.id, 'def');

                        let actRoll = roll(6);
                        let atkType = actRoll === 1 ? "ç‰¹æ®Šæ”»æ’ƒ" : (actRoll === 6 ? "ç„¡è¬€ãªæ”»æ’ƒ" : "é€šå¸¸æ”»æ’ƒ");
                        let [dNum, dSide] = atk.dice[atkType];
                        
                        let hits = 0, kills = 0, selfKills = 0;
                        let activeMen = atk.getActive();

                        for (let i=0; i<activeMen; i++) {
                            let dmg = 0; for(let d=0; d<dNum; d++) dmg += roll(dSide);
                            
                            if (atkType === "ç„¡è¬€ãªæ”»æ’ƒ") {
                                let ratio = atk.traits.includes("é©å‘½ä¸‡æ­³") ? 0.4 : 0.3;
                                let res = target.takeDamage(dmg - Math.floor(dmg * ratio));
                                if(res.hit) hits++; if(res.killed) kills++;
                                if(atk.takeDamage(Math.floor(dmg * ratio)).killed) selfKills++;
                            } else {
                                let res = target.takeDamage(dmg);
                                if(res.hit) hits++; if(res.killed) kills++;
                            }
                        }

                        deathsThisTurn[target.id] += kills;
                        deathsThisTurn[atk.id] += selfKills;

                        let logTxt = `<span class="log-atk">[${atk.name}] ãŒ ${atkType} -> [${target.name}]</span><br>`;
                        logTxt += `<span class="log-dmg"> â”” æœ‰åŠ¹æ‰“: ${hits} / æ–°ãŸãªæ­»è€…: <span class="log-fatal">${kills}å</span></span>`;
                        if (atkType === "ç„¡è¬€ãªæ”»æ’ƒ") logTxt += `<span class="log-fatal"> | è‡ªè»çŠ ç‰²: ${selfKills}å</span>`;
                        logHTML(logTxt);
                    });
                }
            }

            // â˜… å£«æ°—ãƒ€ãƒ¡ãƒ¼ã‚¸ã®é©ç”¨ã¨æ•—èµ°ãƒã‚§ãƒƒã‚¯
            [...teams.A, ...teams.B].forEach(u => {
                if(u.applyMoraleDamage(deathsThisTurn[u.id])) {
                    logHTML(`<span class="log-route">âš ï¸ã€æˆ¦ç·šå´©å£Šã€‘ ${u.name} ã¯ææ€–ã«è€ãˆãã‚Œãšæ•—èµ°ã—ãŸï¼ï¼</span>`);
                }
            });

            // æ°—çµ¶é€²è¡Œ
            ["A", "B"].forEach(side => {
                teams[side].forEach(u => {
                    for(let i=0; i<u.size; i++) {
                        if (u.statusList[i] === 1) u.statusList[i] = 2;
                        else if (u.statusList[i] === 2) u.statusList[i] = -1;
                    }
                });
            });

            turn++;
            updateUI();

            let aAlive = teams.A.some(u => u.isAlive());
            let bAlive = teams.B.some(u => u.isAlive());

            if (!aAlive || !bAlive) {
                if(autoInterval) clearInterval(autoInterval);
                let winner = aAlive ? "æ”»æ’ƒè»(A)" : (bAlive ? "é˜²è¡›è»(B)" : "å¼•ãåˆ†ã‘(ä¸¡è»å…¨æ»…)");
                logHTML(`<div class="log-turn" style="font-size:18px; color:var(--cyan);">ğŸ† æˆ¦é—˜çµ‚äº†ï¼ å‹è€…: ${winner} ğŸ†</div>`);
                document.getElementById("btn-next").disabled = true;
                document.getElementById("btn-auto").disabled = true;
                return false;
            }
            return true;
        }

        function runAuto() {
            document.getElementById("btn-next").disabled = true;
            document.getElementById("btn-auto").disabled = true;
            autoInterval = setInterval(() => {
                if (!runTurn()) clearInterval(autoInterval);
            }, 500); // ãƒãƒƒãƒ—æ¼”å‡ºãŒè¦‹ãˆã‚‹ã‚ˆã†ã«0.5ç§’é–“éš”
        }

        function resetGame() {
            teams = { "A": [], "B": [] }; turn = 1; isBattling = false; unitCounter = 0;
            if(autoInterval) clearInterval(autoInterval);
            document.getElementById("btn-start").disabled = false;
            document.getElementById("btn-next").disabled = true;
            document.getElementById("btn-auto").disabled = true;
            document.getElementById("log-area").innerHTML = '<div style="color:var(--text-muted)">SYSTEM: é…å‚™ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚</div>';
            updateUI();
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        initSetup();
    </script>
</body>
</html>
