<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TACTICAL COMMAND DUAL - Ver11.0</title>
    <style>
        :root {
            --bg-dark: #050b14; --panel-bg: #0f172a; --panel-border: #1e293b;
            --cyan: #06b6d4; --red: #ef4444; --green: #10b981; --yellow: #eab308; --blue: #3b82f6;
            --text-main: #f8fafc; --text-muted: #64748b;
        }
        * { box-sizing: border-box; }
        body { margin: 0; padding: 10px; background: var(--bg-dark); color: var(--text-main); font-family: 'Segoe UI', Meiryo, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        h1 { text-align: center; margin: 0 0 10px 0; font-size: 20px; color: var(--cyan); text-shadow: 0 0 10px rgba(6,182,212,0.5); letter-spacing: 2px; }

        .top-section { display: flex; gap: 10px; height: 45%; min-height: 300px; margin-bottom: 10px; }
        .bottom-section { display: flex; gap: 10px; flex: 1; min-height: 0; }
        .panel { background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: 6px; padding: 10px; display: flex; flex-direction: column; overflow: hidden; }
        .panel-title { font-size: 14px; font-weight: bold; border-bottom: 1px solid var(--panel-border); padding-bottom: 5px; margin-bottom: 10px; color: #fff; display: flex; justify-content: space-between; align-items: center; }

        .setup-panel { flex: 1.2; overflow-y: auto; padding-right: 5px; }
        .faction-group { background: #020617; border: 1px solid var(--panel-border); border-radius: 4px; margin-bottom: 10px; overflow: hidden; }
        .faction-summary { padding: 10px; font-weight: bold; color: var(--yellow); background: #1e293b; cursor: pointer; outline: none; border-bottom: 1px solid #000; }
        .faction-summary:hover { background: #334155; }
        
        .unit-details { background: #0f172a; border-top: 1px solid #000; margin: 5px; border: 1px solid var(--panel-border); border-radius: 4px; }
        .unit-summary { padding: 10px; cursor: pointer; color: #fff; font-size: 13px; font-weight: bold; }
        .unit-summary:hover { background: #1e293b; }
        .preset-info { padding: 10px; background: #020617; border-top: 1px solid var(--panel-border); font-size: 12px; }
        .flavor-text { color: var(--cyan); font-style: italic; margin-bottom: 8px; border-left: 3px solid var(--cyan); padding-left: 8px; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; color: var(--text-muted); margin-bottom: 8px; font-size: 11px; }
        
        .trait-box { grid-column: 1 / -1; background: #111827; border: 1px solid #334155; padding: 6px; border-radius: 4px; margin-top: 4px; margin-bottom: 10px; }
        .trait-box ul { margin: 4px 0 0 20px; padding: 0; font-size: 11px; color: #cbd5e1; }
        .trait-box li { margin-bottom: 4px; }
        .trait-name { color: #f472b6; font-weight: bold; }

        .action-btns { display: flex; flex-direction: column; gap: 8px; background: #1e293b; padding: 8px; border-radius: 4px; }
        .action-btns select, .action-btns input { background: #020617; color: #fff; border: 1px solid #475569; padding: 4px; border-radius: 4px; font-size: 11px; }
        .btn-row { display: flex; gap: 5px; align-items: center; width: 100%; }
        button { background: var(--blue); color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 11px; }
        button:hover { filter: brightness(1.2); }
        button:disabled { background: #334155; color: #64748b; cursor: not-allowed; }
        .btn-a { background: var(--cyan); color: #000; flex: 1; } 
        .btn-b { background: var(--red); color: #fff; flex: 1; }
        .btn-del { background: transparent; color: #ef4444; border: 1px solid #ef4444; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer; }
        .btn-del:hover { background: #ef4444; color: #fff; }

        .faction-header { background: #1e293b; color: var(--yellow); font-size: 11px; font-weight: bold; padding: 4px 8px; margin: 10px 0 5px 0; border-left: 3px solid var(--yellow); border-radius: 2px; }

        .map-panel { flex: 2; position: relative; display: flex; flex-direction: column; }
        .battlefield { flex: 1; display: flex; justify-content: space-between; background: repeating-linear-gradient(0deg, #050b14, #050b14 20px, #0a1120 20px, #0a1120 40px); border: 1px solid #334155; border-radius: 4px; padding: 10px; overflow: hidden; }
        .map-zone { display: flex; flex-direction: column; justify-content: center; gap: 5px; width: 22%; }
        .map-center { width: 6%; border-left: 2px dashed #ef4444; border-right: 2px dashed #06b6d4; opacity: 0.5; }
        .map-unit { background: #1e293b; border: 1px solid #fff; padding: 6px; text-align: center; border-radius: 4px; font-size: 11px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; position: relative; }
        .map-unit.a { border-color: var(--cyan); color: var(--cyan); box-shadow: 0 0 5px rgba(6,182,212,0.3); }
        .map-unit.b { border-color: var(--red); color: var(--red); box-shadow: 0 0 5px rgba(239,68,68,0.3); }
        .map-unit.dead { opacity: 0.2; border-color: #475569; box-shadow: none; color: #475569; }
        
        @keyframes anim-atk { 0% { transform: scale(1); background: #1e293b; } 50% { transform: scale(1.15); background: #fff; color: #000; box-shadow: 0 0 15px #fff; z-index: 10; } 100% { transform: scale(1); } }
        @keyframes anim-def { 0% { transform: translateX(0); background: #9f1239; color: #fff; } 20% { transform: translateX(-4px) rotate(-2deg); } 40% { transform: translateX(4px) rotate(2deg); } 60% { transform: translateX(-4px) rotate(-2deg); } 80% { transform: translateX(4px) rotate(2deg); } 100% { transform: translateX(0); } }
        @keyframes anim-heal { 0% { transform: scale(1); background: #1e293b; } 50% { transform: scale(1.1); background: #10b981; color: #fff; box-shadow: 0 0 15px #10b981; z-index: 10; } 100% { transform: scale(1); } }
        
        .anim-atk { animation: anim-atk 0.4s ease-out; }
        .anim-def { animation: anim-def 0.4s ease-out; }
        .anim-heal { animation: anim-heal 0.4s ease-out; }

        .list-panel { flex: 1; overflow-y: auto; padding-right: 5px; }
        .log-panel { flex: 1.5; overflow-y: auto; background: #020617; font-family: var(--font-mono); font-size: 13px; line-height: 1.5; padding: 10px; border: 1px solid var(--panel-border); }
        
        .unit-card { background: #0f172a; border-left: 3px solid #475569; padding: 8px; margin-bottom: 8px; border-radius: 4px; font-size: 12px; position: relative; }
        .unit-card.a { border-left-color: var(--cyan); } .unit-card.b { border-left-color: var(--red); }
        
        .bar-wrap { height: 12px; background: #000; border-radius: 2px; margin-top: 4px; position: relative; display: flex; overflow: hidden; }
        .bar-hp { background: var(--green); transition: width 0.3s; }
        .bar-faint { background: var(--yellow); transition: width 0.3s; }
        .bar-dead { background: var(--red); transition: width 0.3s; }
        .bar-morale { background: var(--blue); transition: width 0.3s; }
        .bar-text { position: absolute; width: 100%; text-align: center; font-size: 9px; line-height: 12px; font-weight: bold; color: #fff; text-shadow: 1px 1px 1px #000; }

        .log-turn { color: var(--yellow); font-weight: bold; margin-top: 10px; border-bottom: 1px dashed #334155; padding-bottom: 4px; }
        .log-atk { color: #c084fc; } .log-dmg { color: #cbd5e1; } .log-fatal { color: var(--red); font-weight: bold; }
        .log-route { color: #fff; background: #9f1239; padding: 3px 6px; font-weight: bold; border-radius: 2px; display: inline-block; margin-top: 4px; border: 1px solid #f43f5e; }
        .controls { display: flex; gap: 8px; margin-top: 10px; justify-content: center; }
        .controls button { padding: 10px 15px; font-size: 13px; }
    </style>
</head>
<body>

    <h1>TACTICAL COMMAND DUAL - Ver 11.0 (é‰„ã®è¦å¾‹)</h1>

    <div class="top-section">
        <div class="panel setup-panel">
            <div class="panel-title">â–¼ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (è£…å‚™ï¼†æ‰€å±)</div>
            <div id="setup-list"></div>
        </div>

        <div class="panel map-panel">
            <div class="panel-title">ğŸ“¡ æˆ¦è¡“ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒƒãƒ—</div>
            <div class="battlefield" id="battlefield">
                <div class="map-zone" id="zone-a-back"></div>
                <div class="map-zone" id="zone-a-front"></div>
                <div class="map-center"></div>
                <div class="map-zone" id="zone-b-front"></div>
                <div class="map-zone" id="zone-b-back"></div>
            </div>
            <div class="controls">
                <button id="btn-start" onclick="startBattle()" style="background: var(--green);">âš”ï¸ æˆ¦é—˜é–‹å§‹</button>
                <button id="btn-next" onclick="runTurn()" disabled>â­ æ¬¡ã‚¿ãƒ¼ãƒ³</button>
                <button id="btn-auto" onclick="toggleAuto()" disabled>â© è‡ªå‹•å®Ÿè¡Œ</button>
                <button onclick="resetGame()" style="background: transparent; color: var(--red); border: 1px solid var(--red);">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
        </div>
    </div>

    <div class="bottom-section">
        <div class="panel list-panel" id="panel-a">
            <div class="panel-title" id="title-a" style="color:var(--cyan)">[A] æ”»æ’ƒè» <span style="font-size:11px; color:var(--text-muted);">(ç”Ÿå­˜:0 / æ°—çµ¶:0 / æ­»è€…:0)</span></div>
            <div id="list-a"></div>
        </div>
        <div class="panel log-panel" id="log-area"><div style="color:var(--text-muted)">SYSTEM: è²«å¾¹æ­¦å™¨ã¨é‡è£…ç”²ãƒ¦ãƒ‹ãƒƒãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚</div></div>
        <div class="panel list-panel" id="panel-b">
            <div class="panel-title" id="title-b" style="color:var(--red)">[B] é˜²è¡›è» <span style="font-size:11px; color:var(--text-muted);">(ç”Ÿå­˜:0 / æ°—çµ¶:0 / æ­»è€…:0)</span></div>
            <div id="list-b"></div>
        </div>
    </div>

    <script>
        const roll = (sides) => Math.floor(Math.random() * sides) + 1;
        const roll100 = () => Math.floor(Math.random() * 100) + 1;
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // éŸ³å£°
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(freq, type, duration, vol=0.1) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        }
        const sfx = {
            hit: () => playSound(150, 'square', 0.1, 0.05),
            heal: () => { playSound(800, 'sine', 0.1, 0.05); setTimeout(()=>playSound(1200, 'sine', 0.1, 0.03), 50); },
            route: () => playSound(60, 'sawtooth', 0.5, 0.1),
            purge: () => { playSound(40, 'sawtooth', 0.3, 0.15); playSound(44, 'sawtooth', 0.3, 0.15); },
            win: () => { [523, 659, 783, 1046].forEach((f,i) => setTimeout(()=>playSound(f,'sine',0.4,0.05), i*150)); }
        };

        const TRAIT_DESCRIPTIONS = {
            "é©å‘½ä¸‡æ­³": "ç„¡è¬€ãªæ”»æ’ƒã®è‡ªå‚·ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒ4å‰²ã€‚å£«æ°—ä½ä¸‹ã‚’30%ã§ç„¡åŠ¹åŒ–ã€‚",
            "çš‡å¸é™›ä¸‹ä¸‡æ­³": "å£«æ°—ä½ä¸‹ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å¸¸ã«åŠæ¸›ã™ã‚‹ã€‚",
            "ç²›æ¸…": "å‘³æ–¹ãŒæ•—èµ°ã—ãŸéš›ã€åŠæ•°ã‚’å‡¦åˆ‘ã—ã¦å¾¹åº•æŠ—æˆ¦(å£«æ°—ç„¡é™)ã‚’å¼·ã„ã‚‹ã€‚",
            "è¡›ç”Ÿå…µ": "æ”»æ’ƒã›ãšå‘³æ–¹ã‚’æ²»ç™‚ã€‚ãŸã ã—è¡›ç”Ÿå…µåŒå£«ã®æ²»ç™‚ã¯ä¸å¯ã€‚",
            "è²«å¾¹": "æ•µã®è£…ç”²ã‚’ç„¡è¦–ã—ã¦ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‹ã€‚",
            "é‡éˆ": "ã©ã‚Œã ã‘æ©Ÿå‹•ãŒé«˜ãã¦ã‚‚ã€å…¨ãƒ¦ãƒ‹ãƒƒãƒˆã®æœ€å¾Œã«è¡Œå‹•ã™ã‚‹ã€‚"
        };

        const DATABASE = {
            "ãƒ©ãƒ«ã‚­ã‚¢å›½å®¶ç¤¾ä¼šä¸»ç¾©äººæ°‘å…±å’Œå›½": {
                "ç¬¬ã€‡æ­©å…µå¤§éšŠ": { desc: "ç‹‚ä¿¡çš„ãªæ­©å…µå¤§éšŠã€‚è£…ç”²ã¯ãªã„ãŒçªæ’ƒã‚’ç¹°ã‚Šè¿”ã™ã€‚", size: 600, cat: "æœ€å‰è¡›éƒ¨éšŠ", morale: 50, agi: 30, arm: 0, hp: 10, fail: 40, gen: [1, 1], spc: [1, 3], reck: [1, 3], traits: ["é©å‘½ä¸‡æ­³"] },
                "ç¬¬ã€‡æ”¿æ²»ç›£æŸ»å§”å“¡ä¸­éšŠ": { desc: "é€ƒäº¡ã‚’è¨±ã•ãªã„ã€‚æ•—èµ°éƒ¨éšŠã®åŠæ•°ã‚’å‡¦åˆ‘ã™ã‚‹ã€‚", size: 100, cat: "å¾Œæ´éƒ¨éšŠ", morale: 200, agi: 30, arm: 0, hp: 10, fail: 30, gen: [1, 1], spc: [1, 2], reck: [1, 2], traits: ["é©å‘½ä¸‡æ­³", "ç²›æ¸…"] },
                "ç¬¬ã€‡æ©Ÿå‹•è£…ç”²ä¸­éšŠ": { desc: "é«˜æ©Ÿå‹•ã¨é‡è£…ç”²ã‚’å…¼ã­å‚™ãˆãŸç‰¹æ®Šè£…ç”²éƒ¨éšŠã€‚", size: 100, cat: "ç‰¹æ®Šéƒ¨éšŠ", morale: 100, agi: 80, arm: 3, hp: 10, fail: 50, gen: [1, 4], spc: [2, 3], reck: [3, 3], traits: ["é©å‘½ä¸‡æ­³"] },
                "ç¬¬ã€‡è¡›ç”Ÿä¸­éšŠ": { desc: "æ•‘è­·éƒ¨éšŠã€‚è¡›ç”Ÿå…µåŒå£«ã®æ•‘è­·ã¯ç¦ã˜ã‚‰ã‚Œã¦ã„ã‚‹ã€‚", size: 100, cat: "å¾Œæ´éƒ¨éšŠ", morale: 100, agi: 80, arm: 3, hp: 10, fail: 10, gen: [2, 2], spc: [3, 3], reck: [4, 5], traits: ["è¡›ç”Ÿå…µ"] },
                "ç¬¬ã€‡æ”¯æ´ç ²å…µä¸­éšŠ": { desc: "è£…ç”²ã‚’è²«ãå¼·åŠ›ãªç ²ç«ã€‚æ•µã®é˜²è­·ã‚’ç„¡åŠ›åŒ–ã™ã‚‹ã€‚", size: 100, cat: "æœ€å¾Œè¡›éƒ¨éšŠ", morale: 60, agi: 0, arm: 0, hp: 10, fail: 60, gen: [1, 6], spc: [1, 8], reck: [1, 4], traits: ["è²«å¾¹"] }
            },
            "å…¨åœŸã‚«ãƒ«ãƒ´ã‚§ãƒŠé©å‘½æˆ¦ç·š": {
                "ç¬¬ã€‡é©å‘½ãƒ‘ãƒ«ãƒã‚¶ãƒ³å¤§éšŠ": { desc: "ç¥–å›½è§£æ”¾ã‚’æ²ã’ã‚‹æ°‘å…µå¤§éšŠã€‚è£…ç”²ã¯ãªã„ãŒæ•°ã§æŠ¼ã™ã€‚", size: 600, cat: "æœ€å‰è¡›éƒ¨éšŠ", morale: 200, agi: 0, arm: 0, hp: 10, fail: 60, gen: [1, 2], spc: [1, 2], reck: [1, 5], traits: ["é©å‘½ä¸‡æ­³"] }
            },
            "ã‚«ãƒ«ãƒ´ã‚§ãƒŠå¸å›½": {
                "ç¬¬ã€‡æ­£è¦æ­©å…µå¤§éšŠ": { desc: "è¦å¾‹æ­£ã—ã„æ­£è¦æ­©å…µã€‚çš‡å¸ã¸ã®çµ¶å¯¾ã®å¿ èª ã€‚", size: 600, cat: "æœ€å‰è¡›éƒ¨éšŠ", morale: 100, agi: 20, arm: 0, hp: 10, fail: 30, gen: [1, 2], spc: [1, 2], reck: [1, 3], traits: ["çš‡å¸é™›ä¸‹ä¸‡æ­³"] },
                "ç¬¬ã€‡å¸ç«‹é‡è£…ç”²ä¸­éšŠ": { desc: "å¸å›½ã®èª‡ã‚‹é‰„ã®å£ã€‚é‡ã™ãã¦æœ€å¾Œã«è¡Œå‹•ã™ã‚‹ãŒã€æ”»æ’ƒã¯è£…ç”²ã‚’è²«ãã€‚", size: 100, cat: "ç‰¹æ®Šéƒ¨éšŠ", morale: 250, agi: 10, arm: 6, hp: 10, fail: 30, gen: [1, 5], spc: [1, 6], reck: [1, 3], traits: ["çš‡å¸é™›ä¸‹ä¸‡æ­³", "è²«å¾¹", "é‡éˆ"] },
                "ç‰¹æ®Šæš—æ®ºéƒ¨éšŠ å½±": { desc: "é—‡ã«ç´›ã‚Œã¦æ•µå°†ã®é¦–ã‚’ç‹™ã†æ¥µç§˜éƒ¨éšŠã€‚", size: 20, cat: "ç‰¹æ®Šéƒ¨éšŠ", morale: 150, agi: 80, arm: 1, hp: 25, fail: 10, gen: [2, 6], spc: [3, 6], reck: [1, 10], traits: [] }
            }
        };

        class Unit {
            constructor(name, preset, affiliation, team, id) {
                this.id = id; this.name = name; this.affiliation = affiliation; this.team = team; 
                this.category = preset.cat; this.size = preset.size; 
                this.morale = preset.morale; this.max_morale = preset.morale;
                this.agi = preset.agi; this.arm = preset.arm; this.hp = preset.hp || 10; this.fail = preset.fail;
                this.dice = { "é€šå¸¸æ”»æ’ƒ": [...preset.gen], "ç‰¹æ®Šæ”»æ’ƒ": [...preset.spc], "ç„¡è¬€ãªæ”»æ’ƒ": [...preset.reck] };
                this.traits = preset.traits || [];
                this.hpList = new Array(this.size).fill(this.hp);
                this.statusList = new Array(this.size).fill(0); 
                this.isRouted = false;
                this.turnStartDead = 0; 
            }
            getActive() { return this.statusList.filter(s => s === 0).length; }
            getFaint() { return this.statusList.filter(s => s === 1 || s === 2).length; }
            getDead() { return this.statusList.filter(s => s === -1).length; }
            isAlive() { 
                if (this.max_morale === "/") return this.statusList.some(s => s !== -1);
                return !this.isRouted && this.statusList.some(s => s !== -1); 
            }
            takeDamage(dmg, isPiercing = false) {
                if (!this.isAlive() || roll100() <= this.fail) return { hit: false, killed: false };
                let armorValue = isPiercing ? 0 : this.arm;
                let actualDmg = Math.min(Math.max(0, dmg - armorValue), this.hp);
                let targets = [];
                for(let i=0; i<this.size; i++) if(this.statusList[i] >= 0) targets.push(i);
                if(targets.length === 0) return { hit: false, killed: false };
                let idx = targets[Math.floor(Math.random() * targets.length)];
                let oldHp = this.hpList[idx];
                this.hpList[idx] -= actualDmg;
                if (oldHp > 1 && this.hpList[idx] <= 0) this.hpList[idx] = 1;
                let killed = false;
                if (this.hpList[idx] <= this.hp / 2 && this.statusList[idx] === 0) this.statusList[idx] = 1;
                if (this.hpList[idx] <= 0) { this.statusList[idx] = -1; killed = true; }
                return { hit: true, killed: killed };
            }
            receiveHealing(amount) {
                let targets = [];
                for(let i=0; i<this.size; i++) if(this.statusList[i] === 1 || this.statusList[i] === 2) targets.push(i);
                if(targets.length === 0) {
                    for(let i=0; i<this.size; i++) if(this.statusList[i] === 0 && this.hpList[i] < this.hp) targets.push(i);
                }
                if(targets.length === 0) return false;
                let idx = targets[Math.floor(Math.random() * targets.length)];
                let oldStatus = this.statusList[idx];
                this.hpList[idx] += amount;
                if(this.hpList[idx] > this.hp) this.hpList[idx] = this.hp;
                if(this.hpList[idx] > this.hp / 2 && (oldStatus === 1 || oldStatus === 2)) {
                    this.statusList[idx] = 0;
                    return true; 
                }
                return false;
            }
            applyMoraleDamage(deathsThisTurn) {
                if (this.max_morale === "/" || this.isRouted || deathsThisTurn <= 0) return false;
                let baseDmg = deathsThisTurn + roll(20);
                if (this.traits.includes("çš‡å¸é™›ä¸‹ä¸‡æ­³")) baseDmg = Math.floor(baseDmg / 2);
                if (this.traits.includes("é©å‘½ä¸‡æ­³") && roll100() <= 30) baseDmg = 0;
                if (baseDmg > 0) {
                    this.morale -= baseDmg;
                    logHTML(`<span class="log-sys"> â”” [å£«æ°—å¤‰å‹•] ${this.name}: -${baseDmg} (æ®‹:${this.morale})</span>`);
                }
                if (this.morale <= 0) return true; 
                return false;
            }
        }

        let teams = { "A": [], "B": [] };
        let turn = 1; let isBattling = false; let autoMode = false; let unitCounter = 0; let isProcessingTurn = false;

        function initSetup() {
            const setupList = document.getElementById("setup-list");
            setupList.innerHTML = "";
            for (let [faction, units] of Object.entries(DATABASE)) {
                let factionHTML = `<details class="faction-group"><summary class="faction-summary">ğŸŒ ${faction}</summary>`;
                for (let [key, data] of Object.entries(units)) {
                    let traitsHtml = `<div>[ç‰¹æ€§] ãªã—</div>`;
                    if (data.traits && data.traits.length > 0) {
                        let traitItems = data.traits.map(t => `<li><span class="trait-name">${t}</span>: ${TRAIT_DESCRIPTIONS[t]}</li>`).join('');
                        traitsHtml = `<div class="trait-box"><span style="color:var(--cyan); font-weight:bold;">â—† ç‰¹æ€§è§£èª¬</span><ul>${traitItems}</ul></div>`;
                    }
                    let safeIdStr = `${faction}_${key}`.replace(/[^a-zA-Z0-9]/g, '_') + unitCounter++;
                    factionHTML += `
                        <details class="unit-details">
                            <summary class="unit-summary">${key}</summary>
                            <div class="preset-info">
                                <div class="flavor-text">"${data.desc}"</div>
                                <div class="stat-grid">
                                    <div>[å…µç§‘] ${data.cat}</div><div>[è¦æ¨¡] ${data.size}å</div>
                                    <div>[å£«æ°—] ${data.morale}</div><div>[è£…ç”²] ${data.arm} / [æ©Ÿå‹•] ${data.agi}</div>
                                    <div>[HP] ${data.hp || 10} / [å¤±æ•—ç‡] ${data.fail}%</div>
                                    ${traitsHtml}
                                </div>
                                <div class="action-btns">
                                    <div class="btn-row">
                                        <span style="font-size:11px;">è£…å‚™:</span>
                                        <select id="equip-${safeIdStr}" style="flex:1;">
                                            <option value="none">ãªã—</option>
                                            <option value="machinegun">æ©Ÿé–¢éŠƒ (+2D1ç‰¹æ®Š / æ­©å…µå¤§éšŠç”¨)</option>
                                            <option value="armor">å¡¹å£•ã‚¹ã‚³ãƒƒãƒ— (+1è£…ç”² -50æ©Ÿå‹• / ç„¡è£…ç”²ç”¨)</option>
                                        </select>
                                    </div>
                                    <div class="btn-row">
                                        <span style="font-size:11px;">æ•°:</span>
                                        <input type="number" id="cnt-${safeIdStr}" value="1" min="1" max="5" style="width:35px; text-align:center;">
                                        <button class="btn-a" onclick="addUnitBySafeId('${faction}', '${key}', '${safeIdStr}', 'A')">â—€ Aè»ã¸</button>
                                        <button class="btn-b" onclick="addUnitBySafeId('${faction}', '${key}', '${safeIdStr}', 'B')">Bè»ã¸ â–¶</button>
                                    </div>
                                </div>
                            </div>
                        </details>
                    `;
                }
                factionHTML += `</details>`;
                setupList.innerHTML += factionHTML;
            }
        }

        function logHTML(html) {
            const area = document.getElementById("log-area");
            area.innerHTML += `<div>${html}</div>`;
            area.scrollTop = area.scrollHeight;
        }

        function addUnitBySafeId(faction, key, safeIdStr, team) {
            if(isBattling) return;
            let data = DATABASE[faction][key];
            let count = parseInt(document.getElementById(`cnt-${safeIdStr}`).value);
            let equip = document.getElementById(`equip-${safeIdStr}`).value;

            if (equip === "machinegun") {
                if (data.size !== 600 || !key.includes("æ­©å…µ")) { alert("æ©Ÿé–¢éŠƒã¯æ­©å…µå¤§éšŠå°‚ç”¨ã§ã™ã€‚"); return; }
            } else if (equip === "armor") {
                if (data.arm > 0) { alert("å¡¹å£•ã‚¹ã‚³ãƒƒãƒ—ã¯ç„¡è£…ç”²ãƒ¦ãƒ‹ãƒƒãƒˆå°‚ç”¨ã§ã™ã€‚"); return; }
            }

            for(let i=0; i<count; i++) {
                let id = `u_${team}_${unitCounter++}`;
                let rndNum = Math.floor(Math.random() * 84) + 1;
                let deployedName = key.replace(/ã€‡/g, rndNum);
                let unit = new Unit(deployedName, data, faction, team, id);

                if (equip === "machinegun") { unit.name += " (æ©Ÿé–¢éŠƒ)"; unit.dice["ç‰¹æ®Šæ”»æ’ƒ"][0] += 2; unit.dice["ç‰¹æ®Šæ”»æ’ƒ"][1] += 1; } 
                else if (equip === "armor") { unit.name += " (å¡¹å£•ã‚¹ã‚³ãƒƒãƒ—)"; unit.agi -= 50; unit.arm += 1; }
                teams[team].push(unit);
            }
            updateUI();
        }

        function removeUnit(team, id) {
            if(isBattling) return;
            teams[team] = teams[team].filter(u => u.id !== id);
            updateUI();
        }

        function renderTeamList(teamId, teamArray) {
            const list = document.getElementById(`list-${teamId.toLowerCase()}`);
            list.innerHTML = "";
            let stats = { active: 0, faint: 0, dead: 0 };
            let grouped = {};
            teamArray.forEach(u => { if(!grouped[u.affiliation]) grouped[u.affiliation] = []; grouped[u.affiliation].push(u); });

            for (let [faction, units] of Object.entries(grouped)) {
                list.innerHTML += `<div class="faction-header">${faction}</div>`;
                units.forEach(u => {
                    let a = u.getActive(), f = u.getFaint(), d = u.getDead();
                    stats.active += a; stats.faint += f; stats.dead += d;
                    let aPct = (a/u.size)*100, fPct = (f/u.size)*100, dPct = (d/u.size)*100;
                    let mPct = u.max_morale === "/" ? 100 : Math.max(0, (u.morale/u.max_morale)*100);
                    let st = u.isRouted ? "æ•—èµ°" : (d >= u.size ? "å…¨æ»…" : "æˆ¦é—˜ä¸­");
                    let nameColor = u.max_morale === "/" ? "#dc2626" : (u.isRouted ? "var(--red)" : "var(--green)");
                    let delBtn = !isBattling ? `<button class="btn-del" onclick="removeUnit('${teamId}', '${u.id}')">âœ–</button>` : '';
                    list.innerHTML += `<div class="unit-card ${teamId.toLowerCase()}" style="${u.isRouted || d>=u.size ? 'opacity:0.5' : ''}">
                        <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:4px; align-items:center;">
                            <span style="font-size:13px;">${u.name}</span>
                            <div><span style="color:${nameColor}; font-size:11px; margin-right:5px;">${st}</span>${delBtn}</div>
                        </div>
                        <div class="bar-wrap"><div class="bar-hp" style="width:${aPct}%"></div><div class="bar-faint" style="width:${fPct}%"></div><div class="bar-dead" style="width:${dPct}%"></div><div class="bar-text">ç”Ÿå­˜:${a} / æ°—çµ¶:${f} / æ­»è€…:${d}</div></div>
                        <div class="bar-wrap"><div class="bar-morale" style="width:${mPct}%"></div><div class="bar-text">å£«æ°—: ${u.max_morale === "/" ? "ç„¡é™" : u.morale}</div></div>
                    </div>`;
                });
            }
            return stats;
        }

        function updateUI() {
            let statsA = renderTeamList("A", teams.A);
            let statsB = renderTeamList("B", teams.B);
            document.getElementById("title-a").innerHTML = `[A] æ”»æ’ƒè» <span style="font-size:11px; color:var(--text-muted);">(ç”Ÿå­˜:${statsA.active} / æ°—çµ¶:${statsA.faint} / æ­»è€…:${statsA.dead})</span>`;
            document.getElementById("title-b").innerHTML = `[B] é˜²è¡›è» <span style="font-size:11px; color:var(--text-muted);">(ç”Ÿå­˜:${statsB.active} / æ°—çµ¶:${statsB.faint} / æ­»è€…:${statsB.dead})</span>`;
            document.querySelectorAll('.map-zone').forEach(el => el.innerHTML = '');
            const placeOnMap = (u, cl) => {
                let zone = (u.category === "å¾Œæ´éƒ¨éšŠ" || u.category === "æœ€å¾Œè¡›éƒ¨éšŠ") ? `zone-${cl}-back` : `zone-${cl}-front`;
                let stateCl = u.isAlive() ? cl : "dead";
                let shortName = u.name.replace('å¤§éšŠ', '').replace('ä¸­éšŠ', '').replace('å°éšŠ', '');
                document.getElementById(zone).innerHTML += `<div class="map-unit ${stateCl}" id="map-${u.id}">${shortName} <br>(${u.getActive()}å)</div>`;
            };
            teams.A.forEach(u => placeOnMap(u, 'a'));
            teams.B.forEach(u => placeOnMap(u, 'b'));
        }

        function getTarget(enemyTeam, category) {
            let enemies = teams[enemyTeam].filter(u => u.isAlive());
            if(!enemies.length) return null;
            let possible = enemies.filter(u => u.category === category);
            if(!possible.length) return enemies[Math.floor(Math.random() * enemies.length)];
            possible.sort((a,b) => a.agi - b.agi);
            return possible[Math.floor(Math.random() * possible.length)];
        }

        function startBattle() {
            if(!teams.A.length || !teams.B.length) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            isBattling = true;
            document.getElementById("btn-start").disabled = true;
            document.getElementById("btn-next").disabled = false;
            document.getElementById("btn-auto").disabled = false;
            updateUI(); 
        }

        async function playAnimation(id, animClass, duration) {
            let el = document.getElementById(`map-${id}`);
            if(!el) return;
            el.classList.remove(animClass); void el.offsetWidth; el.classList.add(animClass);
            await sleep(duration);
            el.classList.remove(animClass);
        }

        function toggleAuto() {
            let btn = document.getElementById("btn-auto");
            if (autoMode) { autoMode = false; btn.innerHTML = "â© è‡ªå‹•å®Ÿè¡Œ"; btn.style.background = ""; document.getElementById("btn-next").disabled = false; }
            else { autoMode = true; btn.innerHTML = "â¸ ä¸€æ™‚åœæ­¢"; btn.style.background = "#eab308"; btn.style.color = "#000"; document.getElementById("btn-next").disabled = true; runTurn(); }
        }

        async function runTurn() {
            if(isProcessingTurn) return;
            isProcessingTurn = true; 
            logHTML(`<div class="log-turn">â–¼ TURN ${turn} â–¼</div>`);
            [...teams.A, ...teams.B].forEach(u => u.turnStartDead = u.getDead());

            // è¡Œå‹•é †åºã®æ±ºå®šï¼šé€šå¸¸ãƒ¦ãƒ‹ãƒƒãƒˆ -> é‡éˆãƒ¦ãƒ‹ãƒƒãƒˆ
            let normalUnits = [];
            let slowUnits = [];
            [...teams.A, ...teams.B].forEach(u => {
                if(u.traits.includes("é‡éˆ")) slowUnits.push(u);
                else normalUnits.push(u);
            });

            // ã‚«ãƒ†ã‚´ãƒªãƒ¼é †åº
            let cats = ["ç‰¹æ®Šéƒ¨éšŠ", "æœ€å¾Œè¡›éƒ¨éšŠ", "æœ€å‰è¡›éƒ¨éšŠ", "å¾Œæ´éƒ¨éšŠ"];
            
            // é€šå¸¸è¡Œå‹•ãƒ•ã‚§ãƒ¼ã‚º
            for (let cat of cats) {
                let unitsInCat = normalUnits.filter(u => u.category === cat);
                // å„ãƒ¦ãƒ‹ãƒƒãƒˆãŒé †ç•ªã«å‹•ã
                for (let atk of unitsInCat) {
                    await processUnitAction(atk);
                }
            }

            // é‡éˆãƒ•ã‚§ãƒ¼ã‚º (æœ€å¾Œã«è¡Œå‹•)
            logHTML(`<div class="log-sys" style="color:var(--text-muted)">>>> é‡éˆãƒ¦ãƒ‹ãƒƒãƒˆèµ·å‹•ãƒ•ã‚§ãƒ¼ã‚º <<<</div>`);
            for (let atk of slowUnits) {
                await processUnitAction(atk);
            }

            // ã‚¿ãƒ¼ãƒ³çµ‚äº†å‡¦ç†
            ["A", "B"].forEach(side => {
                teams[side].forEach(u => {
                    for(let i=0; i<u.size; i++) {
                        if (u.statusList[i] === 1) u.statusList[i] = 2;
                        else if (u.statusList[i] === 2) { u.statusList[i] = -1; u.hpList[i] = 0; }
                    }
                });
            });

            [...teams.A, ...teams.B].forEach(u => {
                if (!u.isAlive()) return;
                let deathsThisTurn = u.getDead() - u.turnStartDead;
                if(u.applyMoraleDamage(deathsThisTurn)) {
                    let commissars = teams[u.team].filter(ally => ally.traits.includes("ç²›æ¸…") && ally.isAlive() && ally !== u);
                    if (commissars.length > 0) {
                        u.isRouted = false; u.max_morale = "/"; u.morale = "/";
                        let nonDead = []; for(let i=0; i<u.size; i++) if (u.statusList[i] !== -1) nonDead.push(i);
                        let killCount = Math.floor(nonDead.length / 2); nonDead.sort(() => Math.random() - 0.5); 
                        for(let i=0; i<killCount; i++) { u.statusList[nonDead[i]] = -1; u.hpList[nonDead[i]] = 0; }
                        sfx.purge();
                        logHTML(`<span class="log-route" style="background:#b91c1c; font-size:14px;">ğŸ’¥ã€ç²›æ¸…ç™ºå‹•ã€‘ é€ƒäº¡å…µã‚’å‡¦åˆ‘ï¼æ­»ã¬ã¾ã§æˆ¦ãˆï¼</span>`);
                    } else {
                        u.isRouted = true; for(let i=0; i<u.size; i++) if(u.statusList[i] > 0) u.statusList[i] = -1; 
                        sfx.route();
                        logHTML(`<span class="log-route">âš ï¸ã€æˆ¦ç·šå´©å£Šã€‘ ${u.name} ã¯æ•—èµ°ã—ãŸï¼ï¼</span>`);
                    }
                }
            });

            turn++; updateUI(); isProcessingTurn = false;
            let aAlive = teams.A.some(u => u.isAlive()); let bAlive = teams.B.some(u => u.isAlive());
            if (!aAlive || !bAlive) {
                if(autoMode) toggleAuto(); sfx.win();
                document.getElementById("btn-auto").disabled = true;
                let winner = aAlive ? "æ”»æ’ƒè»(A)" : (bAlive ? "é˜²è¡›è»(B)" : "å¼•ãåˆ†ã‘");
                logHTML(`<div class="log-turn" style="font-size:18px; color:var(--cyan);">ğŸ† æˆ¦é—˜çµ‚äº†ï¼ å‹è€…: ${winner} ğŸ†</div>`);
                return;
            }
            if (autoMode) setTimeout(runTurn, 400); else document.getElementById("btn-next").disabled = false;
        }

        async function processUnitAction(atk) {
            if (!atk.isAlive()) return;
            let isMedic = atk.traits.includes("è¡›ç”Ÿå…µ");
            let isPiercing = atk.traits.includes("è²«å¾¹");
            let enemySide = atk.team === "A" ? "B" : "A";
            let target;

            if(isMedic) {
                // è¡›ç”Ÿå…µã¯ã€Œè¡›ç”Ÿå…µç‰¹æ€§ã‚’æŒãŸãªã„ã€å‘³æ–¹ã‚’å„ªå…ˆ
                let allies = teams[atk.team].filter(u => u.isAlive() && !u.traits.includes("è¡›ç”Ÿå…µ") && u.getFaint() > 0);
                if(allies.length === 0) allies = teams[atk.team].filter(u => u.isAlive() && !u.traits.includes("è¡›ç”Ÿå…µ") && u.getActive() > 0 && u !== atk);
                if(allies.length === 0) return; // æ²»ã™ç›¸æ‰‹ãŒã„ãªã‘ã‚Œã°ãƒ‘ã‚¹
                target = allies[Math.floor(Math.random() * allies.length)];
            } else {
                let r = roll100();
                let tgtCat = r === 1 ? "ç‰¹æ®Šéƒ¨éšŠ" : (r === 2 ? "æœ€å¾Œè¡›éƒ¨éšŠ" : (r <= 13 ? "å¾Œæ´éƒ¨éšŠ" : "æœ€å‰è¡›éƒ¨éšŠ"));
                target = getTarget(enemySide, tgtCat);
            }
            if (!target) return;

            await Promise.all([playAnimation(atk.id, 'anim-atk', 400), playAnimation(target.id, isMedic ? 'anim-heal' : 'anim-def', 400)]);
            if(isMedic) sfx.heal(); else sfx.hit();

            let actRoll = roll(6);
            let atkType = actRoll === 1 ? "ç‰¹æ®Šæ”»æ’ƒ" : (actRoll === 6 ? "ç„¡è¬€ãªæ”»æ’ƒ" : "é€šå¸¸æ”»æ’ƒ");
            let [dNum, dSide] = atk.dice[atkType];
            let hits = 0, kills = 0, selfKills = 0, revives = 0;
            let activeMen = atk.getActive();

            for (let i=0; i<activeMen; i++) {
                let dmg = 0; for(let d=0; d<dNum; d++) dmg += roll(dSide);
                if (isMedic) {
                    if (atkType === "ç„¡è¬€ãªæ”»æ’ƒ") {
                        let selfDmg = Math.floor(dmg * 0.3);
                        if(target.receiveHealing(dmg - selfDmg)) revives++;
                        if(atk.takeDamage(selfDmg).killed) selfKills++;
                    } else { if(target.receiveHealing(dmg)) revives++; }
                } else {
                    if (atkType === "ç„¡è¬€ãªæ”»æ’ƒ") {
                        let res = target.takeDamage(dmg - Math.floor(dmg * 0.3), isPiercing);
                        if(res.hit) hits++; if(res.killed) kills++;
                        if(atk.takeDamage(Math.floor(dmg * 0.3)).killed) selfKills++;
                    } else { let res = target.takeDamage(dmg, isPiercing); if(res.hit) hits++; if(res.killed) kills++; }
                }
            }

            let logTxt = `<span class="log-atk">[${atk.name}] ${atkType} -> [${target.name}]${isPiercing?' (è²«å¾¹)':''}</span><br>`;
            if (isMedic) {
                logTxt += `<span class="log-dmg"> â”” æˆ¦ç·šå¾©å¸°: <span style="color:var(--green); font-weight:bold;">${revives}å</span></span>`;
            } else {
                logTxt += `<span class="log-dmg"> â”” æœ‰åŠ¹æ‰“: ${hits} / æ­»è€…: <span class="log-fatal">${kills}å</span></span>`;
            }
            if (selfKills > 0) logTxt += `<span class="log-fatal"> | è‡ªæ: ${selfKills}å</span>`;
            logHTML(logTxt);
            updateUI(); await sleep(50);
        }

        function resetGame() {
            teams = { "A": [], "B": [] }; turn = 1; isBattling = false; autoMode = false; unitCounter = 0; isProcessingTurn = false;
            let btnAuto = document.getElementById("btn-auto"); btnAuto.disabled = true; btnAuto.innerHTML = "â© è‡ªå‹•å®Ÿè¡Œ"; btnAuto.style.background = "";
            document.getElementById("btn-start").disabled = false; document.getElementById("btn-next").disabled = true;
            document.getElementById("log-area").innerHTML = '<div style="color:var(--text-muted)">SYSTEM: é…å‚™ãƒªã‚»ãƒƒãƒˆå®Œäº†ã€‚</div>';
            updateUI();
        }

        document.addEventListener('DOMContentLoaded', initSetup);
    </script>
</body>
</html>
