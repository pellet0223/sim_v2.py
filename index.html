<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TACTICAL COMMAND DUAL - Ver15.0</title>
    <style>
        :root {
            --bg-dark: #020617; --panel-bg: #0f172a; --panel-border: #1e293b;
            --cyan: #22d3ee; --red: #fb7185; --green: #4ade80; --yellow: #fbbf24; --blue: #3b82f6;
            --text-main: #f1f5f9; --text-muted: #94a3b8;
        }
        * { box-sizing: border-box; outline: none; }
        body { margin: 0; padding: 12px; background: var(--bg-dark); color: var(--text-main); font-family: 'Consolas', 'Meiryo', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        h1 { text-align: center; margin: 0 0 12px 0; font-size: 18px; color: var(--cyan); text-shadow: 0 0 8px rgba(34,211,238,0.4); letter-spacing: 3px; border-bottom: 1px solid var(--panel-border); padding-bottom: 5px; }

        .layout { display: flex; flex: 1; gap: 12px; min-height: 0; }
        .side-panel { width: 300px; display: flex; flex-direction: column; gap: 12px; }
        .main-panel { flex: 1; display: flex; flex-direction: column; gap: 12px; min-width: 0; }

        .panel { background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: 8px; padding: 12px; position: relative; display: flex; flex-direction: column; }
        .panel-title { font-size: 12px; font-weight: bold; color: var(--text-muted); margin-bottom: 10px; text-transform: uppercase; border-left: 3px solid var(--cyan); padding-left: 8px; display: flex; justify-content: space-between; }

        /* „É¨„Éº„ÉÄ„Éº„Éû„ÉÉ„ÉóÂà∑Êñ∞ */
        #battlefield-container { flex: 1.5; min-height: 300px; position: relative; overflow: hidden; background: #000; border: 1px solid #334155; border-radius: 8px; }
        #attack-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
        .battlefield { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: space-between; padding: 15px; }
        
        .map-zone { display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); grid-auto-rows: min-content; gap: 6px; width: 22%; align-content: center; }
        .map-center { width: 4%; border-left: 1px dashed rgba(251,113,133,0.2); border-right: 1px dashed rgba(34,211,238,0.2); }

        .map-unit { 
            background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(255,255,255,0.3); padding: 4px; 
            border-radius: 4px; font-size: 9px; text-align: center; color: #fff;
            display: flex; flex-direction: column; gap: 2px; transition: all 0.2s; position: relative;
        }
        .map-unit.a { border-color: var(--cyan); color: var(--cyan); }
        .map-unit.b { border-color: var(--red); color: var(--red); }
        .map-unit.dead { opacity: 0.1; transform: scale(0.9); }
        .map-unit span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
        
        .m-bar { height: 3px; background: #000; border-radius: 1px; width: 100%; overflow: hidden; }
        .m-fill-hp { height: 100%; background: var(--green); }
        .m-fill-mor { height: 100%; background: var(--blue); }

        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes pulse-atk { 0% { transform: scale(1); border-color: #fff; } 50% { transform: scale(1.1); border-color: var(--cyan); box-shadow: 0 0 15px var(--cyan); } 100% { transform: scale(1); } }
        .anim-atk { animation: pulse-atk 0.3s ease-out; z-index: 10; }

        /* „É™„Çπ„Éà„Éª„É≠„Ç∞ */
        .log-panel { flex: 1; background: #010409; overflow-y: auto; padding: 10px; font-size: 11px; line-height: 1.5; color: #c9d1d9; border: 1px solid #30363d; }
        .list-area { flex: 1; overflow-y: auto; padding-right: 4px; }
        .unit-card { background: #161b22; border-radius: 6px; padding: 8px; margin-bottom: 8px; border-left: 4px solid #30363d; font-size: 12px; }
        .unit-card.a { border-left-color: var(--cyan); } .unit-card.b { border-left-color: var(--red); }
        
        .setup-area { overflow-y: auto; flex: 1; }
        details { background: #161b22; border: 1px solid #30363d; border-radius: 4px; margin-bottom: 6px; }
        summary { padding: 8px; font-size: 12px; cursor: pointer; color: var(--yellow); }
        .unit-info-box { padding: 8px; background: #0d1117; font-size: 11px; color: var(--text-muted); }
        
        .ctrl-row { display: flex; gap: 5px; margin-top: 8px; }
        select, input { background: #0d1117; color: #fff; border: 1px solid #30363d; border-radius: 4px; padding: 4px; font-size: 11px; }
        button { cursor: pointer; border: none; border-radius: 4px; padding: 6px 12px; font-weight: bold; transition: 0.2s; font-family: inherit; }
        button:hover { opacity: 0.8; }
        .btn-main { background: var(--green); color: #000; width: 100%; padding: 10px; margin-top: 5px; }
        
        .log-turn { color: var(--yellow); font-weight: bold; border-bottom: 1px dashed #334155; margin: 10px 0 5px 0; }
        .log-route { background: var(--red); color: #fff; padding: 2px 4px; border-radius: 2px; font-weight: bold; }
    </style>
</head>
<body>

    <h1>TACTICAL COMMAND DUAL Ver15.0</h1>

    <div class="layout">
        <div class="side-panel">
            <div class="panel" style="flex: 1;">
                <div class="panel-title">DATABASE</div>
                <div class="setup-area" id="setup-list"></div>
                <div class="panel" style="padding: 8px; background: #0d1117; border-color: var(--cyan); margin-top: 10px;">
                    <div class="toggle-row" style="display: flex; align-items:center; justify-content:space-between; font-size:11px;">
                        <span>Âä¥ÂÉçËÄÖ„ÅÆÊâáÂãï(Èù©ÂëΩÊà¶Á∑ö)</span>
                        <input type="checkbox" id="trait-incite-workers">
                    </div>
                </div>
                <button id="btn-start" class="btn-main" onclick="startBattle()">‚öî MISSION START</button>
                <div class="ctrl-row">
                    <button style="background:var(--blue); color:#fff; flex:1;" id="btn-next" onclick="runTurn()" disabled>NEXT TURN</button>
                    <button style="background:var(--yellow); color:#000; flex:1;" id="btn-auto" onclick="toggleAuto()" disabled>AUTO</button>
                </div>
                <button style="background:transparent; border:1px solid var(--red); color:var(--red); margin-top:5px;" onclick="resetGame()">SYSTEM RESET</button>
            </div>
        </div>

        <div class="main-panel">
            <div id="battlefield-container">
                <canvas id="attack-canvas"></canvas>
                <div class="battlefield">
                    <div class="map-zone" id="zone-a-back"></div>
                    <div class="map-zone" id="zone-a-front"></div>
                    <div class="map-center"></div>
                    <div class="map-zone" id="zone-b-front"></div>
                    <div class="map-zone" id="zone-b-back"></div>
                </div>
            </div>
            
            <div style="display:flex; gap:12px; flex: 1.2; min-height:0;">
                <div class="panel" style="flex:1;">
                    <div class="panel-title" id="title-a">FORCE A</div>
                    <div class="list-area" id="list-a"></div>
                </div>
                <div class="log-panel" id="log-area"></div>
                <div class="panel" style="flex:1;">
                    <div class="panel-title" id="title-b">FORCE B</div>
                    <div class="list-area" id="list-b"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const roll = (sides) => Math.floor(Math.random() * sides) + 1;
        const roll100 = () => Math.floor(Math.random() * 100) + 1;
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // --- „Çµ„Ç¶„É≥„Éâ„Ç®„É≥„Ç∏„É≥ÊîπÂñÑ ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSfx(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            
            switch(type) {
                case 'hit': // ÊîªÊíÉÈü≥
                    o.type = 'square'; o.frequency.setValueAtTime(150, now);
                    o.frequency.exponentialRampToValueAtTime(40, now + 0.1);
                    g.gain.setValueAtTime(0.05, now); g.gain.linearRampToValueAtTime(0, now + 0.1);
                    break;
                case 'pierce': // Ë≤´ÂæπÊîªÊíÉ
                    o.type = 'sawtooth'; o.frequency.setValueAtTime(400, now);
                    o.frequency.linearRampToValueAtTime(800, now + 0.05);
                    g.gain.setValueAtTime(0.03, now); g.gain.linearRampToValueAtTime(0, now + 0.15);
                    break;
                case 'heal': // ÂõûÂæ©ÂíåÈü≥
                    const o2 = audioCtx.createOscillator(); const g2 = audioCtx.createGain();
                    o2.connect(g2); g2.connect(audioCtx.destination);
                    o.type = 'sine'; o.frequency.setValueAtTime(523, now); // C5
                    o2.type = 'sine'; o2.frequency.setValueAtTime(659, now); // E5
                    g.gain.setValueAtTime(0.05, now); g.gain.linearRampToValueAtTime(0, now + 0.3);
                    g2.gain.setValueAtTime(0.05, now); g2.gain.linearRampToValueAtTime(0, now + 0.3);
                    o2.start(); o2.stop(now + 0.3);
                    break;
                case 'purge': // Á≤õÊ∏ÖÔºà‰ΩéÈü≥Ôºâ
                    o.type = 'sawtooth'; o.frequency.setValueAtTime(40, now);
                    g.gain.setValueAtTime(0.2, now); g.gain.linearRampToValueAtTime(0, now + 0.5);
                    break;
                case 'win': // ÂãùÂà©
                    o.type = 'triangle'; o.frequency.setValueAtTime(440, now);
                    [554, 659, 880].forEach((f, i) => {
                        setTimeout(() => playSfx('heal'), i * 150);
                    });
                    break;
            }
            o.start(); o.stop(now + 0.5);
        }

        const DATABASE = {
            "„É©„É´„Ç≠„Ç¢ÂõΩÂÆ∂Á§æ‰ºö‰∏ªÁæ©‰∫∫Ê∞ëÂÖ±ÂíåÂõΩ": {
                "Á¨¨„ÄáÊ≠©ÂÖµÂ§ßÈöä": { size: 600, cat: "ÊúÄÂâçË°õÈÉ®Èöä", morale: 50, agi: 30, arm: 0, hp: 10, fail: 40, gen: [1, 1], spc: [1, 3], reck: [1, 3], traits: ["Èù©ÂëΩ‰∏áÊ≠≥"] },
                "Á¨¨„ÄáÊîøÊ≤ªÁõ£ÊüªÂßîÂì°‰∏≠Èöä": { size: 100, cat: "ÂæåÊè¥ÈÉ®Èöä", morale: 200, agi: 30, arm: 0, hp: 10, fail: 30, gen: [1, 1], spc: [1, 2], reck: [1, 2], traits: ["Èù©ÂëΩ‰∏áÊ≠≥", "Á≤õÊ∏Ö"] },
                "Á¨¨„ÄáË°õÁîü‰∏≠Èöä": { size: 100, cat: "ÂæåÊè¥ÈÉ®Èöä", morale: 100, agi: 80, arm: 3, hp: 10, fail: 10, gen: [2, 2], spc: [3, 3], reck: [4, 5], traits: ["Ë°õÁîüÂÖµ"] },
                "Á¨¨„ÄáÊîØÊè¥Á†≤ÂÖµ‰∏≠Èöä": { size: 100, cat: "ÊúÄÂæåË°õÈÉ®Èöä", morale: 60, agi: 0, arm: 0, hp: 10, fail: 60, gen: [1, 6], spc: [1, 8], reck: [1, 4], traits: ["Ë≤´Âæπ"] }
            },
            "ÂÖ®Âúü„Ç´„É´„É¥„Çß„ÉäÈù©ÂëΩÊà¶Á∑ö": {
                "Á¨¨„ÄáÈù©ÂëΩ„Éë„É´„ÉÅ„Ç∂„É≥Â§ßÈöä": { size: 600, cat: "ÊúÄÂâçË°õÈÉ®Èöä", morale: 200, agi: 0, arm: 0, hp: 10, fail: 60, gen: [1, 2], spc: [1, 2], reck: [1, 5], traits: ["Èù©ÂëΩ‰∏áÊ≠≥"] }
            },
            "„Ç´„É´„É¥„Çß„ÉäÂ∏ùÂõΩ": {
                "Á¨¨„ÄáÊ≠£Ë¶èÊ≠©ÂÖµÂ§ßÈöä": { size: 600, cat: "ÊúÄÂâçË°õÈÉ®Èöä", morale: 100, agi: 20, arm: 0, hp: 10, fail: 30, gen: [1, 2], spc: [1, 2], reck: [1, 3], traits: ["ÁöáÂ∏ùÈôõ‰∏ã‰∏áÊ≠≥"] },
                "Á¨¨„ÄáÂ∏ùÁ´ãÈáçË£ÖÁî≤‰∏≠Èöä": { size: 100, cat: "ÁâπÊÆäÈÉ®Èöä", morale: 250, agi: 10, arm: 6, hp: 10, fail: 30, gen: [1, 5], spc: [1, 6], reck: [1, 3], traits: ["ÁöáÂ∏ùÈôõ‰∏ã‰∏áÊ≠≥", "Ë≤´Âæπ", "ÈáçÈàç"] }
            }
        };

        const WORKER_PRESET = { size: 100, cat: "ÊúÄÂâçË°õÈÉ®Èöä", morale: 50, agi: 0, arm: 0, hp: 7, fail: 65, gen: [1, 1], spc: [1, 1], reck: [2, 3], traits: ["Èù©ÂëΩ‰∏áÊ≠≥"] };

        class Unit {
            constructor(name, preset, affiliation, team, id) {
                this.id = id; this.name = name; this.affiliation = affiliation; this.team = team; 
                this.category = preset.cat; this.size = preset.size; 
                this.morale = preset.morale; this.max_morale = preset.morale;
                this.agi = preset.agi; this.arm = preset.arm; this.hp = preset.hp || 10; this.fail = preset.fail;
                this.dice = { "ÈÄöÂ∏∏ÊîªÊíÉ": [...preset.gen], "ÁâπÊÆäÊîªÊíÉ": [...preset.spc], "ÁÑ°Ë¨Ä„Å™ÊîªÊíÉ": [...preset.reck] };
                this.traits = preset.traits || [];
                this.hpList = new Array(this.size).fill(this.hp);
                this.statusList = new Array(this.size).fill(0); 
                this.isRouted = false;
            }
            getActive() { return this.statusList.filter(s => s === 0).length; }
            getFaint() { return this.statusList.filter(s => s === 1 || s === 2).length; }
            getDead() { return this.statusList.filter(s => s === -1).length; }
            isAlive() { return (this.max_morale === "/" || !this.isRouted) && this.statusList.some(s => s !== -1); }
            takeDamage(dmg, isPiercing = false) {
                if (!this.isAlive() || roll100() <= this.fail) return { hit: false, killed: false };
                let actualDmg = Math.min(Math.max(0, dmg - (isPiercing ? 0 : this.arm)), this.hp);
                let targets = []; for(let i=0; i<this.size; i++) if(this.statusList[i] >= 0) targets.push(i);
                if(targets.length === 0) return { hit: false, killed: false };
                let idx = targets[Math.floor(Math.random() * targets.length)];
                let oldHp = this.hpList[idx]; this.hpList[idx] -= actualDmg;
                if (oldHp > 1 && this.hpList[idx] <= 0) this.hpList[idx] = 1;
                if (this.hpList[idx] <= this.hp / 2 && this.statusList[idx] === 0) this.statusList[idx] = 1;
                let killed = false; if (this.hpList[idx] <= 0) { this.statusList[idx] = -1; killed = true; }
                return { hit: true, killed: killed };
            }
            receiveHealing(amount) {
                let targets = []; for(let i=0; i<this.size; i++) if(this.statusList[i] === 1 || this.statusList[i] === 2) targets.push(i);
                if(targets.length === 0) return false;
                let idx = targets[Math.floor(Math.random() * targets.length)];
                this.hpList[idx] = Math.min(this.hp, this.hpList[idx] + amount);
                if(this.hpList[idx] > this.hp / 2) { this.statusList[idx] = 0; return true; }
                return false;
            }
            applyMoraleDamage(deaths) {
                if(this.max_morale==="/" || this.isRouted || deaths<=0) return false;
                let d = deaths + roll(20);
                if(this.traits.includes("ÁöáÂ∏ùÈôõ‰∏ã‰∏áÊ≠≥")) d = Math.floor(d/2);
                if(this.traits.includes("Èù©ÂëΩ‰∏áÊ≠≥") && roll100()<=30) d=0;
                if(d>0) this.morale -= d;
                return this.morale <= 0;
            }
        }

        let teams = { A: [], B: [] };
        let turn = 1; let isBattling = false; let autoMode = false; let unitCounter = 0; let isProcessing = false;

        // --- ÂàùÊúüÂåñ ---
        function initSetup() {
            const list = document.getElementById("setup-list");
            list.innerHTML = "";
            for (let [faction, units] of Object.entries(DATABASE)) {
                let html = `<details><summary>${faction}</summary><div class="unit-info-box">`;
                for (let [key, data] of Object.entries(units)) {
                    let sid = `s-${unitCounter++}`;
                    html += `<div style="margin-bottom:10px; border-bottom:1px solid #334155; padding-bottom:5px;">
                        <div style="font-weight:bold; color:#fff;">${key}</div>
                        <div class="stat-grid"><div>ÂÖµÁßë: ${data.cat}</div><div>Â£´Ê∞ó: ${data.morale}</div><div>Ë£ÖÁî≤: ${data.arm}</div></div>
                        <div class="ctrl-row">
                            <select id="eq-${sid}"><option value="none">„Å™„Åó</option><option value="mg">Ê©üÈäÉ</option><option value="sp">„Çπ„Ç≥„ÉÉ„Éó</option></select>
                            <input type="number" id="ct-${sid}" value="1" min="1" max="5" style="width:35px">
                            <button class="btn-a" onclick="addUnit('${faction}','${key}','${sid}','A')">A</button>
                            <button class="btn-b" onclick="addUnit('${faction}','${key}','${sid}','B')">B</button>
                        </div>
                    </div>`;
                }
                list.innerHTML += html + `</div></details>`;
            }
        }

        function addUnit(fac, key, sid, team) {
            if(isBattling) return;
            let d = DATABASE[fac][key], c = parseInt(document.getElementById(`ct-${sid}`).value), eq = document.getElementById(`eq-${sid}`).value;
            for(let i=0; i<c; i++){
                let name = key.replace('„Äá', Math.floor(Math.random()*84)+1);
                let u = new Unit(name, d, fac, team, `u${unitCounter++}`);
                if(eq==='mg' && d.size===600) { u.name+='(Ê©üÈäÉ)'; u.dice["ÁâπÊÆäÊîªÊíÉ"][0]+=2; u.dice["ÁâπÊÆäÊîªÊíÉ"][1]+=1; }
                if(eq==='sp' && d.arm===0) { u.name+='(Êéò)'; u.arm+=1; u.agi-=50; }
                teams[team].push(u);
            }
            updateUI();
        }

        function updateUI() {
            ["A", "B"].forEach(tid => {
                const list = document.getElementById(`list-${tid.toLowerCase()}`);
                list.innerHTML = ""; let stats = { a:0, f:0, d:0 };
                let grouped = {};
                teams[tid].forEach(u => { if(!grouped[u.affiliation]) grouped[u.affiliation]=[]; grouped[u.affiliation].push(u); });
                for(let [fac, units] of Object.entries(grouped)){
                    list.innerHTML += `<div class="faction-header">${fac}</div>`;
                    units.forEach(u => {
                        let active = u.getActive(), faint = u.getFaint(), dead = u.getDead();
                        stats.a+=active; stats.f+=faint; stats.d+=dead;
                        let hpP = ((active+faint)/u.size)*100, mP = u.max_morale==="/"?100:Math.max(0,(u.morale/u.max_morale)*100);
                        list.innerHTML += `<div class="unit-card ${tid.toLowerCase()}" style="${u.isAlive()?'':'opacity:0.3'}">
                            <div style="display:flex; justify-content:space-between;"><span>${u.name}</span><button style="display:${isBattling?'none':'block'}; color:red; background:none;" onclick="removeUnit('${tid}','${u.id}')">‚úñ</button></div>
                            <div class="bar-wrap"><div class="bar-hp" style="width:${hpP}%"></div><div class="bar-text">ÁîüÂ≠ò:${active}</div></div>
                            <div class="bar-wrap"><div class="bar-morale" style="width:${mP}%"></div><div class="bar-text">Â£´Ê∞ó:${u.morale}</div></div>
                        </div>`;
                    });
                }
                document.getElementById(`title-${tid.toLowerCase()}`).innerHTML = `FORCE ${tid} (${stats.a}/${stats.f}/${stats.d})`;
            });

            // „Éû„ÉÉ„ÉóÊèèÁîªÔºà„Ç∞„É™„ÉÉ„ÉâËá™ÂãïË™øÊï¥Ôºâ
            document.querySelectorAll('.map-zone').forEach(z => z.innerHTML='');
            [...teams.A, ...teams.B].forEach(u => {
                let s = u.team.toLowerCase();
                let z = (u.category.includes('ÂæåÊè¥') || u.category.includes('ÊúÄÂæåË°õ')) ? `zone-${s}-back` : `zone-${s}-front`;
                let hpP = ((u.getActive()+u.getFaint())/u.size)*100;
                let mP = u.max_morale==="/"?100:Math.max(0,(u.morale/u.max_morale)*100);
                document.getElementById(z).innerHTML += `
                    <div class="map-unit ${s} ${u.isAlive()?'':'dead'}" id="map-${u.id}">
                        <span>${u.name.split(' ')[0]}</span>
                        <div class="m-bar"><div class="m-fill-hp" style="width:${hpP}%"></div></div>
                        <div class="m-bar"><div class="m-fill-mor" style="width:${mP}%"></div></div>
                    </div>`;
            });
        }

        // --- Ë¶ñË¶öÁöÑ„Ç®„Éï„Çß„ÇØ„Éà: „É¨„Éº„Ç∂„Éº„Éù„Ç§„É≥„Çø„Éº ---
        function drawAttackLine(atkId, tgtId, type) {
            const canvas = document.getElementById('attack-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
            
            const el1 = document.getElementById(`map-${atkId}`);
            const el2 = document.getElementById(`map-${tgtId}`);
            if(!el1 || !el2) return;

            const rect1 = el1.getBoundingClientRect();
            const rect2 = el2.getBoundingClientRect();
            const parent = canvas.getBoundingClientRect();

            const x1 = rect1.left - parent.left + rect1.width/2;
            const y1 = rect1.top - parent.top + rect1.height/2;
            const x2 = rect2.left - parent.left + rect2.width/2;
            const y2 = rect2.top - parent.top + rect2.height/2;

            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.lineWidth = 2;
            ctx.strokeStyle = type === 'heal' ? 'rgba(74, 222, 128, 0.8)' : 'rgba(251, 113, 133, 0.8)';
            ctx.setLineDash([5, 5]);
            ctx.stroke();

            setTimeout(() => ctx.clearRect(0, 0, canvas.width, canvas.height), 300);
        }

        function removeUnit(t, id) { teams[t] = teams[t].filter(u => u.id !== id); updateUI(); }
        function toggleAuto() { autoMode = !autoMode; document.getElementById("btn-auto").innerHTML = autoMode?"PAUSE":"AUTO"; if(autoMode && !isProcessing) runTurn(); }

        async function runTurn() {
            if(isProcessing) return; isProcessing = true;
            document.getElementById("btn-next").disabled = true;
            const logArea = document.getElementById("log-area");
            const log = (msg, cls='') => { logArea.innerHTML+=`<div class="${cls}">${msg}</div>`; logArea.scrollTop=logArea.scrollHeight; };
            log(`‚ñº TURN ${turn} ‚ñº`, 'log-turn');

            if (document.getElementById('trait-incite-workers').checked && turn % 2 === 0) {
                ["A", "B"].forEach(side => {
                    if (teams[side].some(u => u.affiliation === "ÂÖ®Âúü„Ç´„É´„É¥„Çß„ÉäÈù©ÂëΩÊà¶Á∑ö")) {
                        let name = `Á¨¨${Math.floor(Math.random()*84)+1}Âä¥ÂÉçËÄÖ‰∏≠Èöä`;
                        teams[side].push(new Unit(name, WORKER_PRESET, "ÂÖ®Âúü„Ç´„É´„É¥„Çß„ÉäÈù©ÂëΩÊà¶Á∑ö", side, `u_i_${unitCounter++}`));
                        log(`üì¢ Â¢óÊè¥: ${name} Âà∞ÁùÄÔºÅ`); playSfx('heal');
                    }
                });
                updateUI();
            }

            let all = [...teams.A, ...teams.B];
            all.forEach(u => u.turnStartDead = u.getDead());

            let cats = ["ÁâπÊÆäÈÉ®Èöä", "ÊúÄÂæåË°õÈÉ®Èöä", "ÊúÄÂâçË°õÈÉ®Èöä", "ÂæåÊè¥ÈÉ®Èöä"];
            let actionList = [];
            cats.forEach(c => all.filter(u => u.category === c && !u.traits.includes('ÈáçÈàç')).forEach(u => actionList.push(u)));
            cats.forEach(c => all.filter(u => u.category === c && u.traits.includes('ÈáçÈàç')).forEach(u => actionList.push(u)));

            for (let atk of actionList) {
                if(!atk.isAlive()) continue;
                let isM = atk.traits.includes('Ë°õÁîüÂÖµ'), target;
                if(isM) {
                    let allies = teams[atk.team].filter(u => u.isAlive() && !u.traits.includes('Ë°õÁîüÂÖµ') && u.getFaint() > 0);
                    if(!allies.length) allies = teams[atk.team].filter(u => u.isAlive() && !u.traits.includes('Ë°õÁîüÂÖµ') && u !== atk);
                    target = allies[Math.floor(Math.random()*allies.length)];
                } else {
                    let enemies = teams[atk.team==='A'?'B':'A'].filter(u => u.isAlive());
                    target = enemies[Math.floor(Math.random()*enemies.length)];
                }
                if(!target) continue;

                // Ë¶ñË¶öÊºîÂá∫
                const aEl = document.getElementById(`map-${atk.id}`);
                if(aEl) aEl.classList.add('anim-atk');
                drawAttackLine(atk.id, target.id, isM ? 'heal' : 'atk');
                
                // „Çµ„Ç¶„É≥„ÉâÊºîÂá∫
                if(isM) playSfx('heal'); 
                else if(atk.traits.includes('Ë≤´Âæπ')) playSfx('pierce');
                else playSfx('hit');

                await sleep(350);
                if(aEl) aEl.classList.remove('anim-atk');

                let rollV = roll(6), type = rollV===1?"ÁâπÊÆä":(rollV===6?"ÁÑ°Ë¨Ä":"ÈÄöÂ∏∏");
                let [dN, dS] = atk.dice[type==="ÈÄöÂ∏∏"?"ÈÄöÂ∏∏ÊîªÊíÉ":(type==="ÁâπÊÆä"?"ÁâπÊÆäÊîªÊíÉ":"ÁÑ°Ë¨Ä„Å™ÊîªÊíÉ")];
                let hits = 0, kills = 0, revs = 0, selfK = 0, count = atk.getActive();

                for(let i=0; i<count; i++){
                    let d = 0; for(let j=0; j<dN; j++) d += roll(dS);
                    if(isM){ if(target.receiveHealing(d)) revs++; if(type==="ÁÑ°Ë¨Ä" && atk.takeDamage(Math.floor(d*0.3)).killed) selfK++; }
                    else {
                        let res = target.takeDamage(d, atk.traits.includes('Ë≤´Âæπ'));
                        if(res.hit) hits++; if(res.killed) kills++;
                        if(type==="ÁÑ°Ë¨Ä" && atk.takeDamage(Math.floor(d*0.3)).killed) selfK++;
                    }
                }
                log(`[${atk.name}] ${type} -> [${target.name}]`);
                updateUI();
            }

            // „Çø„Éº„É≥„Ç®„É≥„Éâ
            all.forEach(u => {
                for(let i=0; i<u.size; i++) if(u.statusList[i]===1) u.statusList[i]=2; else if(u.statusList[i]===2){ u.statusList[i]=-1; u.hpList[i]=0; }
                if(u.isAlive() && u.applyMoraleDamage(u.getDead()-u.turnStartDead)){
                    let commissar = teams[u.team].find(c => c.traits.includes('Á≤õÊ∏Ö') && c.isAlive() && c !== u);
                    if(commissar){
                        let aliveIds = []; u.statusList.forEach((s,idx)=>{ if(s!==-1) aliveIds.push(idx); });
                        let killC = Math.floor(aliveIds.length/2);
                        for(let i=0; i<killC; i++) { let rIdx = aliveIds.splice(Math.floor(Math.random()*aliveIds.length),1)[0]; u.statusList[rIdx]=-1; u.hpList[rIdx]=0; }
                        u.max_morale="/"; u.morale="/"; playSfx('purge'); log(`üí•„ÄêÁ≤õÊ∏Ö„Äë${u.name} „ÇíÂÜçÁ∑®ÊàêÔºÅ`, 'log-route');
                    } else { u.isRouted=true; u.statusList.forEach((s,idx)=>{ if(s>0) u.statusList[idx]=-1; }); playSfx('route'); log(`‚ö†Ô∏è„ÄêÊïóËµ∞„Äë${u.name} Â¥©Â£äÔºÅ`, 'log-route'); }
                }
            });

            turn++; updateUI(); isProcessing = false;
            let winA = teams.B.every(u => !u.isAlive()), winB = teams.A.every(u => !u.isAlive());
            if(winA || winB){ autoMode = false; playSfx('win'); log(`üèÜ ÁµÇÁµê: ${winA?'AËªç':'BËªç'}ÂãùÂà©ÔºÅ`, 'log-turn'); return; }
            if(autoMode) setTimeout(runTurn, 400); else document.getElementById("btn-next").disabled = false;
        }

        function startBattle(){ if(!teams.A.length||!teams.B.length) return; audioCtx.resume(); isBattling=true; document.getElementById("btn-start").disabled=true; document.getElementById("btn-next").disabled=false; document.getElementById("btn-auto").disabled=false; updateUI(); }
        function resetGame(){ location.reload(); }
        initSetup();
    </script>
</body>
</html>
