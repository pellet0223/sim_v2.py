<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TACTICAL COMMAND DUAL - Ver4.0</title>
    <style>
        :root {
            --bg-dark: #050b14; --panel-bg: #0f172a; --panel-border: #1e293b;
            --cyan: #06b6d4; --red: #ef4444; --green: #10b981; --yellow: #eab308; --blue: #3b82f6;
            --text-main: #f8fafc; --text-muted: #64748b;
        }
        * { box-sizing: border-box; }
        body { margin: 0; padding: 10px; background: var(--bg-dark); color: var(--text-main); font-family: 'Segoe UI', Meiryo, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        h1 { text-align: center; margin: 0 0 10px 0; font-size: 20px; color: var(--cyan); text-shadow: 0 0 10px rgba(6,182,212,0.5); letter-spacing: 2px; }

        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .top-section { display: flex; gap: 10px; height: 40%; min-height: 280px; margin-bottom: 10px; }
        .bottom-section { display: flex; gap: 10px; flex: 1; min-height: 0; }
        .panel { background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: 6px; padding: 10px; display: flex; flex-direction: column; overflow: hidden; }
        .panel-title { font-size: 14px; font-weight: bold; border-bottom: 1px solid var(--panel-border); padding-bottom: 5px; margin-bottom: 10px; color: #fff; }

        /* ç·¨æˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ (æ‰€å±ã‚°ãƒ«ãƒ¼ãƒ—) */
        .setup-panel { flex: 1.2; overflow-y: auto; padding-right: 5px; }
        .faction-group { background: #020617; border: 1px solid var(--panel-border); border-radius: 4px; margin-bottom: 10px; overflow: hidden; }
        .faction-summary { padding: 10px; font-weight: bold; color: var(--yellow); background: #1e293b; cursor: pointer; outline: none; border-bottom: 1px solid #000; }
        .faction-summary:hover { background: #334155; }
        
        .unit-details { background: #0f172a; border-top: 1px solid #000; margin: 5px; border: 1px solid var(--panel-border); border-radius: 4px; }
        .unit-summary { padding: 8px; cursor: pointer; color: #fff; font-size: 13px; font-weight: bold; }
        .unit-summary:hover { background: #1e293b; }
        .preset-info { padding: 10px; background: #020617; border-top: 1px solid var(--panel-border); font-size: 12px; }
        .flavor-text { color: var(--cyan); font-style: italic; margin-bottom: 8px; border-left: 3px solid var(--cyan); padding-left: 8px; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; color: var(--text-muted); margin-bottom: 10px; }
        .action-btns { display: flex; gap: 5px; justify-content: space-between; }
        
        button { background: var(--blue); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { filter: brightness(1.2); }
        button:disabled { background: #475569; color: #94a3b8; cursor: not-allowed; }
        .btn-a { background: var(--cyan); color: #000; } .btn-b { background: var(--red); }

        /* æˆ¦è¡“ãƒãƒƒãƒ— & ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .map-panel { flex: 2; position: relative; display: flex; flex-direction: column; }
        .battlefield { flex: 1; display: flex; justify-content: space-between; background: repeating-linear-gradient(0deg, #050b14, #050b14 20px, #0a1120 20px, #0a1120 40px); border: 1px solid #334155; border-radius: 4px; padding: 10px; overflow: hidden; }
        .map-zone { display: flex; flex-direction: column; justify-content: center; gap: 5px; width: 22%; }
        .map-center { width: 6%; border-left: 2px dashed #ef4444; border-right: 2px dashed #06b6d4; opacity: 0.5; }
        .map-unit { background: #1e293b; border: 1px solid #fff; padding: 6px; text-align: center; border-radius: 4px; font-size: 11px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; position: relative; }
        .map-unit.a { border-color: var(--cyan); color: var(--cyan); box-shadow: 0 0 5px rgba(6,182,212,0.3); }
        .map-unit.b { border-color: var(--red); color: var(--red); box-shadow: 0 0 5px rgba(239,68,68,0.3); }
        .map-unit.dead { opacity: 0.2; border-color: #475569; box-shadow: none; color: #475569; }
        
        /* CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾© */
        @keyframes anim-atk {
            0% { transform: scale(1); background: #1e293b; }
            50% { transform: scale(1.15); background: #fff; color: #000; box-shadow: 0 0 15px #fff; z-index: 10; }
            100% { transform: scale(1); }
        }
        @keyframes anim-def {
            0% { transform: translateX(0); background: #9f1239; color: #fff; }
            20% { transform: translateX(-4px) rotate(-2deg); }
            40% { transform: translateX(4px) rotate(2deg); }
            60% { transform: translateX(-4px) rotate(-2deg); }
            80% { transform: translateX(4px) rotate(2deg); }
            100% { transform: translateX(0); }
        }
        .anim-atk { animation: anim-atk 0.4s ease-out; }
        .anim-def { animation: anim-def 0.4s ease-out; }

        /* ãƒªã‚¹ãƒˆã¨ãƒ­ã‚° */
        .list-panel { flex: 1; overflow-y: auto; padding-right: 5px; }
        .log-panel { flex: 1.5; overflow-y: auto; background: #020617; font-family: var(--font-mono); font-size: 13px; line-height: 1.5; padding: 10px; border: 1px solid var(--panel-border); }
        
        /* ãƒ¦ãƒ‹ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ */
        .unit-card { background: #0f172a; border-left: 3px solid #475569; padding: 8px; margin-bottom: 8px; border-radius: 4px; font-size: 12px; }
        .unit-card.a { border-left-color: var(--cyan); } .unit-card.b { border-left-color: var(--red); }
        .affiliation-tag { font-size: 9px; color: var(--text-muted); display: block; margin-bottom: 2px; }
        
        .bar-wrap { height: 12px; background: #000; border-radius: 2px; margin-top: 4px; position: relative; display: flex; overflow: hidden; }
        .bar-hp { background: var(--green); transition: width 0.3s; }
        .bar-faint { background: var(--yellow); transition: width 0.3s; }
        .bar-dead { background: var(--red); transition: width 0.3s; }
        .bar-morale { background: var(--blue); transition: width 0.3s; }
        .bar-text { position: absolute; width: 100%; text-align: center; font-size: 9px; line-height: 12px; font-weight: bold; color: #fff; text-shadow: 1px 1px 1px #000; }

        .log-turn { color: var(--yellow); font-weight: bold; margin-top: 10px; border-bottom: 1px dashed #334155; padding-bottom: 4px; }
        .log-atk { color: #c084fc; } .log-dmg { color: #cbd5e1; } .log-fatal { color: var(--red); font-weight: bold; }
        .log-route { color: #fff; background: #9f1239; padding: 2px 4px; font-weight: bold; border-radius: 2px; display: inline-block; margin-top: 2px; }
        .controls { display: flex; gap: 5px; margin-top: 10px; justify-content: center; }
    </style>
</head>
<body>

    <h1>TACTICAL COMMAND DUAL - Ver 4.0</h1>

    <div class="top-section">
        <div class="panel setup-panel">
            <div class="panel-title">â–¼ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ (æ‰€å±åˆ¥)</div>
            <div id="setup-list"></div>
        </div>

        <div class="panel map-panel">
            <div class="panel-title">ğŸ“¡ æˆ¦è¡“ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒƒãƒ—</div>
            <div class="battlefield" id="battlefield">
                <div class="map-zone" id="zone-a-back"></div>
                <div class="map-zone" id="zone-a-front"></div>
                <div class="map-center"></div>
                <div class="map-zone" id="zone-b-front"></div>
                <div class="map-zone" id="zone-b-back"></div>
            </div>
            <div class="controls">
                <button id="btn-start" onclick="startBattle()" style="background: var(--green);">âš”ï¸ æˆ¦é—˜é–‹å§‹</button>
                <button id="btn-next" onclick="runTurn()" disabled>â­ æ¬¡ã‚¿ãƒ¼ãƒ³</button>
                <button id="btn-auto" onclick="runAuto()" disabled>â© è‡ªå‹•å®Ÿè¡Œ</button>
                <button onclick="resetGame()" style="background: var(--red);">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
        </div>
    </div>

    <div class="bottom-section">
        <div class="panel list-panel" id="panel-a"><div class="panel-title" style="color:var(--cyan)">[A] æ”»æ’ƒè»</div><div id="list-a"></div></div>
        <div class="panel log-panel" id="log-area"><div style="color:var(--text-muted)">SYSTEM: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰èµ·å‹•ã€‚éƒ¨éšŠã‚’é…å‚™ã›ã‚ˆã€‚</div></div>
        <div class="panel list-panel" id="panel-b"><div class="panel-title" style="color:var(--red)">[B] é˜²è¡›è»</div><div id="list-b"></div></div>
    </div>

    <script>
        const roll = (sides) => Math.floor(Math.random() * sides) + 1;
        const roll100 = () => Math.floor(Math.random() * 100) + 1;
        // éåŒæœŸå¾…æ©Ÿç”¨é–¢æ•°ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Œäº†ã‚’å¾…ã¤é­”æ³•ï¼‰
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // â˜… æ–°è¦ï¼šæ‰€å±ï¼ˆAffiliationï¼‰ã”ã¨ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
        const DATABASE = {
            "å…¨åœŸã‚«ãƒ«ãƒ´ã‚§ãƒŠé©å‘½æˆ¦ç·š": {
                "ç¬¬13é©å‘½ãƒ‘ãƒ«ãƒã‚¶ãƒ³å¤§éšŠ": { desc: "ç¥–å›½è§£æ”¾ã‚’æ²ã’ã‚‹æ°‘å…µå¤§éšŠã€‚è£…ç”²ã¯çš†ç„¡ã ãŒã€æ­»ã‚’æã‚Œã¬æ³¢çŠ¶æ”»æ’ƒã§æ•µã‚’åœ§å€’ã™ã‚‹ã€‚", size: 600, cat: "æœ€å‰è¡›éƒ¨éšŠ", morale: 200, agi: 0, arm: 0, hp: 10, fail: 60, gen: [1, 2], spc: [1, 2], reck: [1, 5], traits: ["é©å‘½ä¸‡æ­³"] },
                "å¾Œæ–¹æ”¯æ´ç ²å…µä¸­éšŠ": { desc: "å®‰å…¨ãªå¾Œæ–¹ã‹ã‚‰è‡´å‘½çš„ãªç ²æ’ƒã‚’è¡Œã†ã€‚æ¥è¿‘æˆ¦ã«ã¯å¼±ã„ãŒã€æˆ¦å±€ã‚’è¦†ã™ç«åŠ›ã‚’èª‡ã‚‹ã€‚", size: 100, cat: "å¾Œæ´éƒ¨éšŠ", morale: 80, agi: 10, arm: 0, hp: 15, fail: 40, gen: [2, 4], spc: [3, 6], reck: [1, 6], traits: [] }
            },
            "ã‚«ãƒ«ãƒ´ã‚§ãƒŠå¸å›½": {
                "ç¬¬22æ­©å…µå¤§éšŠ": { desc: "ã‚«ãƒ«ãƒ´ã‚§ãƒŠå¸å›½ã®æ­£è¦æ­©å…µã€‚è¦å¾‹æ­£ã—ãã€çš‡å¸ã¸ã®çµ¶å¯¾ã®å¿ èª ã‚’èƒ¸ã«æˆ¦ç·šã‚’ç¶­æŒã™ã‚‹ã€‚", size: 600, cat: "æœ€å‰è¡›éƒ¨éšŠ", morale: 100, agi: 20, arm: 0, hp: 10, fail: 30, gen: [1, 2], spc: [1, 2], reck: [1, 3], traits: ["çš‡å¸é™›ä¸‹ä¸‡æ­³"] },
                "é‡è£…ç”²é˜²è¡›ä¸­éšŠ": { desc: "åˆ†åšã„è£…ç”²æœã‚’ç€è¾¼ã‚“ã é˜²è¡›ç‰¹åŒ–éƒ¨éšŠã€‚æ•µã®æ”»æ’ƒã‚’å¼¾ãè¿”ã—ã€ã˜ã‚ã˜ã‚ã¨å‰ç·šã‚’æŠ¼ã—ä¸Šã’ã‚‹ã€‚", size: 100, cat: "æœ€å‰è¡›éƒ¨éšŠ", morale: 120, agi: 5, arm: 3, hp: 20, fail: 30, gen: [1, 3], spc: [1, 4], reck: [1, 5], traits: [] },
                "ç‰¹æ®Šæš—æ®ºéƒ¨éšŠ 'å½±'": { desc: "é—‡ã«ç´›ã‚Œã¦æ•µå°†ã®é¦–ã‚’ç‹™ã†æ¥µç§˜éƒ¨éšŠã€‚æ¥µã‚ã¦é«˜ã„æ©Ÿå‹•åŠ›ã§å¥‡è¥²ã‚’æ›ã‘ã‚‹ã€‚", size: 20, cat: "ç‰¹æ®Šéƒ¨éšŠ", morale: 150, agi: 80, arm: 1, hp: 25, fail: 10, gen: [2, 6], spc: [3, 6], reck: [1, 10], traits: [] }
            }
        };

        class Unit {
            constructor(name, preset, affiliation, team, id) {
                this.id = id; this.name = name; this.affiliation = affiliation; this.team = team; 
                this.category = preset.cat; this.size = preset.size; 
                this.morale = preset.morale; this.max_morale = preset.morale;
                this.agi = preset.agi; this.arm = preset.arm; this.hp = preset.hp; this.fail = preset.fail;
                this.dice = { "é€šå¸¸æ”»æ’ƒ": preset.gen, "ç‰¹æ®Šæ”»æ’ƒ": preset.spc, "ç„¡è¬€ãªæ”»æ’ƒ": preset.reck };
                this.traits = preset.traits;
                
                this.hpList = new Array(this.size).fill(this.hp);
                this.statusList = new Array(this.size).fill(0); // 0:ç”Ÿå­˜, 1-2:æ°—çµ¶, -1:æ­»äº¡
                this.isRouted = false;
            }

            getActive() { return this.statusList.filter(s => s === 0).length; }
            getFaint() { return this.statusList.filter(s => s === 1 || s === 2).length; }
            getDead() { return this.statusList.filter(s => s === -1).length; }
            isAlive() { return !this.isRouted && this.statusList.some(s => s !== -1); }

            takeDamage(dmg) {
                if (!this.isAlive() || roll100() <= this.fail) return { hit: false, killed: false };
                
                let actualDmg = Math.min(Math.max(0, dmg - this.arm), this.hp);
                let targets = [];
                for(let i=0; i<this.size; i++) if(this.statusList[i] >= 0) targets.push(i);
                if(targets.length === 0) return { hit: false, killed: false };

                let idx = targets[Math.floor(Math.random() * targets.length)];
                let oldHp = this.hpList[idx];
                this.hpList[idx] -= actualDmg;
                if (oldHp > 0 && this.hpList[idx] <= 0) this.hpList[idx] = 1;

                let killed = false;
                if (this.hpList[idx] <= this.hp / 2 && this.statusList[idx] === 0) {
                    this.statusList[idx] = 1;
                } else if (this.hpList[idx] <= 0) {
                    this.statusList[idx] = -1;
                    killed = true;
                }
                return { hit: true, killed: killed };
            }

            applyMoraleDamage(deathsThisTurn) {
                if (this.max_morale === "/" || this.isRouted || deathsThisTurn === 0) return false;
                
                let baseDmg = deathsThisTurn + roll(20);
                if (this.traits.includes("çš‡å¸é™›ä¸‹ä¸‡æ­³")) baseDmg = Math.floor(baseDmg / 2);
                if (this.traits.includes("é©å‘½ä¸‡æ­³") && roll100() < 30) baseDmg = 0;
                
                this.morale -= baseDmg;
                logHTML(`<span class="log-sys"> â”” [å£«æ°—å¤‰å‹•] ${this.name}: -${baseDmg} (æ®‹:${this.morale})</span>`);
                
                if (this.morale <= 0) {
                    this.isRouted = true;
                    for(let i=0; i<this.size; i++) if(this.statusList[i] > 0) this.statusList[i] = -1;
                    return true;
                }
                return false;
            }
        }

        let teams = { "A": [], "B": [] };
        let turn = 1; let isBattling = false; let autoMode = false; let unitCounter = 0;

        // --- åˆæœŸåŒ–ï¼†UIæ›´æ–° ---
        function initSetup() {
            const setupList = document.getElementById("setup-list");
            for (let [faction, units] of Object.entries(DATABASE)) {
                let factionHTML = `<details class="faction-group"><summary class="faction-summary">ğŸŒ ${faction}</summary>`;
                
                for (let [key, data] of Object.entries(units)) {
                    // å„ãƒ¦ãƒ‹ãƒƒãƒˆã®æƒ…å ±ã‚’JSONæ–‡å­—åˆ—ã«ã—ã¦ãƒœã‚¿ãƒ³ã®onclickã«æ¸¡ã™
                    let safeData = JSON.stringify(data).replace(/"/g, '&quot;');
                    factionHTML += `
                        <details class="unit-details">
                            <summary class="unit-summary">${key}</summary>
                            <div class="preset-info">
                                <div class="flavor-text">"${data.desc}"</div>
                                <div class="stat-grid">
                                    <div>[å…µç§‘] ${data.cat}</div>
                                    <div>[è¦æ¨¡] ${data.size}å</div>
                                    <div>[å£«æ°—] ${data.morale}</div>
                                    <div>[è£…ç”²] ${data.arm} / [æ©Ÿå‹•] ${data.agi}</div>
                                    <div>[HP] ${data.hp} / [å¤±æ•—ç‡] ${data.fail}%</div>
                                    <div>[ç‰¹æ€§] ${data.traits.length > 0 ? data.traits.join(',') : 'ãªã—'}</div>
                                </div>
                                <div class="action-btns">
                                    <input type="number" id="cnt-${key}" value="1" min="1" max="5" style="width:40px;">
                                    <button class="btn-a" onclick="addUnit('${key}', '${faction}', ${safeData}, 'A')">Aã«é…å‚™</button>
                                    <button class="btn-b" onclick="addUnit('${key}', '${faction}', ${safeData}, 'B')">Bã«é…å‚™</button>
                                </div>
                            </div>
                        </details>
                    `;
                }
                factionHTML += `</details>`;
                setupList.innerHTML += factionHTML;
            }
        }

        function logHTML(html) {
            const area = document.getElementById("log-area");
            area.innerHTML += `<div>${html}</div>`;
            area.scrollTop = area.scrollHeight;
        }

        function addUnit(key, faction, data, team) {
            if(isBattling) return;
            let count = parseInt(document.getElementById(`cnt-${key}`).value);
            for(let i=0; i<count; i++) {
                let id = `u_${team}_${unitCounter++}`;
                teams[team].push(new Unit(key, data, faction, team, id));
            }
            updateUI();
        }

        function updateUI() {
            ["A", "B"].forEach(t => {
                const list = document.getElementById(`list-${t.toLowerCase()}`);
                list.innerHTML = "";
                teams[t].forEach(u => {
                    let a = u.getActive(), f = u.getFaint(), d = u.getDead();
                    let aPct = (a/u.size)*100, fPct = (f/u.size)*100, dPct = (d/u.size)*100;
                    let mPct = u.max_morale === "/" ? 100 : Math.max(0, (u.morale/u.max_morale)*100);
                    let st = u.isRouted ? "æ•—èµ°" : (d >= u.size ? "å…¨æ»…" : "æˆ¦é—˜ä¸­");
                    
                    list.innerHTML += `
                        <div class="unit-card ${t.toLowerCase()}" style="${u.isRouted || d>=u.size ? 'opacity:0.5' : ''}">
                            <span class="affiliation-tag">${u.affiliation}</span>
                            <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:4px;">
                                <span>${u.name}</span><span style="color:${u.isRouted?'var(--red)':'var(--green)'}">${st}</span>
                            </div>
                            <div class="bar-wrap">
                                <div class="bar-hp" style="width:${aPct}%"></div>
                                <div class="bar-faint" style="width:${fPct}%"></div>
                                <div class="bar-dead" style="width:${dPct}%"></div>
                                <div class="bar-text">ç”Ÿå­˜:${a} / æ°—çµ¶:${f} / æ­»è€…:${d}</div>
                            </div>
                            <div class="bar-wrap">
                                <div class="bar-morale" style="width:${mPct}%"></div>
                                <div class="bar-text">å£«æ°—: ${u.morale}</div>
                            </div>
                        </div>
                    `;
                });
            });

            // ãƒãƒƒãƒ—ã®æ›´æ–° (è¦ç´ ã‚’å†ç”Ÿæˆ)
            document.querySelectorAll('.map-zone').forEach(el => el.innerHTML = '');
            const placeOnMap = (u, cl) => {
                let zone = (u.category === "å¾Œæ´éƒ¨éšŠ" || u.category === "æœ€å¾Œè¡›éƒ¨éšŠ") ? `zone-${cl}-back` : `zone-${cl}-front`;
                let stateCl = u.isAlive() ? cl : "dead";
                document.getElementById(zone).innerHTML += `<div class="map-unit ${stateCl}" id="map-${u.id}">${u.name} <br>(${u.getActive()}å)</div>`;
            };
            teams.A.forEach(u => placeOnMap(u, 'a'));
            teams.B.forEach(u => placeOnMap(u, 'b'));
        }

        // --- ãƒãƒˆãƒ«ãƒ­ã‚¸ãƒƒã‚¯ ---
        function getTarget(enemyTeam, category) {
            let enemies = teams[enemyTeam].filter(u => u.isAlive());
            if(!enemies.length) return null;
            let possible = enemies.filter(u => u.category === category);
            if(!possible.length) return enemies[Math.floor(Math.random() * enemies.length)];
            possible.sort((a,b) => a.agi - b.agi);
            let minAgi = possible[0].agi;
            let candidates = possible.filter(u => u.agi === minAgi);
            return candidates[Math.floor(Math.random() * candidates.length)];
        }

        function startBattle() {
            if(!teams.A.length || !teams.B.length) return;
            isBattling = true;
            document.getElementById("btn-start").disabled = true;
            document.getElementById("btn-next").disabled = false;
            document.getElementById("btn-auto").disabled = false;
            logHTML(`<div class="log-turn" style="font-size:16px;">âš”ï¸ BATTLE START âš”ï¸</div>`);
        }

        // â˜… å®Œå…¨éåŒæœŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
        async function playAnimation(id, animClass, duration) {
            let el = document.getElementById(`map-${id}`);
            if(!el) return;
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç¢ºå®Ÿã«ãƒªã‚»ãƒƒãƒˆã—ã¦å†é©ç”¨ã™ã‚‹ãƒˆãƒªãƒƒã‚¯
            el.classList.remove(animClass);
            void el.offsetWidth; // DOMã®ãƒªãƒ•ãƒ­ãƒ¼ã‚’å¼·åˆ¶
            el.classList.add(animClass);
            await sleep(duration); // æŒ‡å®šæ™‚é–“å¾…æ©Ÿ
            el.classList.remove(animClass);
        }

        // â˜… Async/Await ã‚’ä½¿ã£ãŸã‚¿ãƒ¼ãƒ³é€²è¡Œ
        async function runTurn() {
            // é€£æ‰“é˜²æ­¢
            document.getElementById("btn-next").disabled = true;
            document.getElementById("btn-auto").disabled = true;

            logHTML(`<div class="log-turn">â–¼ TURN ${turn} â–¼</div>`);
            
            let deathsThisTurn = {};
            [...teams.A, ...teams.B].forEach(u => deathsThisTurn[u.id] = 0);

            let cats = ["ç‰¹æ®Šéƒ¨éšŠ", "æœ€å¾Œè¡›éƒ¨éšŠ", "æœ€å‰è¡›éƒ¨éšŠ", "å¾Œæ´éƒ¨éšŠ"];
            for (let cat of cats) {
                for (let side of ["A", "B"]) {
                    let enemySide = side === "A" ? "B" : "A";
                    
                    for (let atk of teams[side]) {
                        if (atk.category !== cat || !atk.isAlive()) continue;
                        
                        let r = roll100();
                        let tgtCat = r === 1 ? "ç‰¹æ®Šéƒ¨éšŠ" : (r === 2 ? "æœ€å¾Œè¡›éƒ¨éšŠ" : (r <= 13 ? "å¾Œæ´éƒ¨éšŠ" : "æœ€å‰è¡›éƒ¨éšŠ"));
                        let target = getTarget(enemySide, tgtCat);
                        if (!target) continue;

                        // â˜… ã“ã“ã§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã€Œå¾…æ©Ÿã€ã™ã‚‹
                        let p1 = playAnimation(atk.id, 'anim-atk', 400);
                        let p2 = playAnimation(target.id, 'anim-def', 400);
                        await Promise.all([p1, p2]);

                        let actRoll = roll(6);
                        let atkType = actRoll === 1 ? "ç‰¹æ®Šæ”»æ’ƒ" : (actRoll === 6 ? "ç„¡è¬€ãªæ”»æ’ƒ" : "é€šå¸¸æ”»æ’ƒ");
                        let [dNum, dSide] = atk.dice[atkType];
                        
                        let hits = 0, kills = 0, selfKills = 0;
                        let activeMen = atk.getActive();

                        for (let i=0; i<activeMen; i++) {
                            let dmg = 0; for(let d=0; d<dNum; d++) dmg += roll(dSide);
                            
                            if (atkType === "ç„¡è¬€ãªæ”»æ’ƒ") {
                                let ratio = atk.traits.includes("é©å‘½ä¸‡æ­³") ? 0.4 : 0.3;
                                let res = target.takeDamage(dmg - Math.floor(dmg * ratio));
                                if(res.hit) hits++; if(res.killed) kills++;
                                if(atk.takeDamage(Math.floor(dmg * ratio)).killed) selfKills++;
                            } else {
                                let res = target.takeDamage(dmg);
                                if(res.hit) hits++; if(res.killed) kills++;
                            }
                        }

                        deathsThisTurn[target.id] += kills;
                        deathsThisTurn[atk.id] += selfKills;

                        let logTxt = `<span class="log-atk">[${atk.name}] ãŒ ${atkType} -> [${target.name}]</span><br>`;
                        logTxt += `<span class="log-dmg"> â”” æœ‰åŠ¹æ‰“: ${hits} / æ–°ãŸãªæ­»è€…: <span class="log-fatal">${kills}å</span></span>`;
                        if (atkType === "ç„¡è¬€ãªæ”»æ’ƒ") logTxt += `<span class="log-fatal"> | è‡ªè»çŠ ç‰²: ${selfKills}å</span>`;
                        logHTML(logTxt);
                        
                        updateUI(); // æ”»æ’ƒã”ã¨ã®HPãƒãƒ¼æ›´æ–°
                        await sleep(100); // é€£ç¶šæ”»æ’ƒã®åˆé–“ã«å°‘ã—é–“ã‚’ç½®ã
                    }
                }
            }

            [...teams.A, ...teams.B].forEach(u => {
                if(u.applyMoraleDamage(deathsThisTurn[u.id])) {
                    logHTML(`<span class="log-route">âš ï¸ã€æˆ¦ç·šå´©å£Šã€‘ ${u.name} ã¯ææ€–ã«è€ãˆãã‚Œãšæ•—èµ°ã—ãŸï¼ï¼</span>`);
                }
            });

            ["A", "B"].forEach(side => {
                teams[side].forEach(u => {
                    for(let i=0; i<u.size; i++) {
                        if (u.statusList[i] === 1) u.statusList[i] = 2;
                        else if (u.statusList[i] === 2) u.statusList[i] = -1;
                    }
                });
            });

            turn++;
            updateUI();

            let aAlive = teams.A.some(u => u.isAlive());
            let bAlive = teams.B.some(u => u.isAlive());

            if (!aAlive || !bAlive) {
                autoMode = false;
                let winner = aAlive ? "æ”»æ’ƒè»(A)" : (bAlive ? "é˜²è¡›è»(B)" : "å¼•ãåˆ†ã‘(ä¸¡è»å…¨æ»…)");
                logHTML(`<div class="log-turn" style="font-size:18px; color:var(--cyan);">ğŸ† æˆ¦é—˜çµ‚äº†ï¼ å‹è€…: ${winner} ğŸ†</div>`);
                return false;
            }
            
            // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™ã‹ã€ã‚ªãƒ¼ãƒˆç¶™ç¶šã‹
            if (autoMode) {
                setTimeout(runTurn, 500);
            } else {
                document.getElementById("btn-next").disabled = false;
                document.getElementById("btn-auto").disabled = false;
            }
            return true;
        }

        function runAuto() {
            autoMode = true;
            runTurn();
        }

        function resetGame() {
            teams = { "A": [], "B": [] }; turn = 1; isBattling = false; autoMode = false; unitCounter = 0;
            document.getElementById("btn-start").disabled = false;
            document.getElementById("btn-next").disabled = true;
            document.getElementById("btn-auto").disabled = true;
            document.getElementById("log-area").innerHTML = '<div style="color:var(--text-muted)">SYSTEM: é…å‚™ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚</div>';
            updateUI();
        }

        initSetup();
    </script>
</body>
</html>
