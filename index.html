<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TACTICAL COMMAND DUAL - Ver14.0</title>
    <style>
        :root {
            --bg-dark: #050b14; --panel-bg: #0f172a; --panel-border: #1e293b;
            --cyan: #06b6d4; --red: #ef4444; --green: #10b981; --yellow: #eab308; --blue: #3b82f6;
            --text-main: #f8fafc; --text-muted: #64748b;
        }
        * { box-sizing: border-box; }
        body { margin: 0; padding: 10px; background: var(--bg-dark); color: var(--text-main); font-family: 'Segoe UI', Meiryo, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        h1 { text-align: center; margin: 0 0 10px 0; font-size: 20px; color: var(--cyan); text-shadow: 0 0 10px rgba(6,182,212,0.5); letter-spacing: 2px; }

        .top-section { display: flex; gap: 10px; height: 50%; min-height: 350px; margin-bottom: 10px; }
        .bottom-section { display: flex; gap: 10px; flex: 1; min-height: 0; }
        .panel { background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: 6px; padding: 10px; display: flex; flex-direction: column; overflow: hidden; }
        .panel-title { font-size: 14px; font-weight: bold; border-bottom: 1px solid var(--panel-border); padding-bottom: 5px; margin-bottom: 10px; color: #fff; display: flex; justify-content: space-between; align-items: center; }

        .setup-panel { flex: 1.2; overflow-y: auto; padding-right: 5px; }
        .faction-group { background: #020617; border: 1px solid var(--panel-border); border-radius: 4px; margin-bottom: 10px; overflow: hidden; }
        .faction-summary { padding: 10px; font-weight: bold; color: var(--yellow); background: #1e293b; cursor: pointer; outline: none; border-bottom: 1px solid #000; }
        .unit-details { background: #0f172a; border-top: 1px solid #000; margin: 5px; border: 1px solid var(--panel-border); border-radius: 4px; }
        .unit-summary { padding: 8px; cursor: pointer; color: #fff; font-size: 12px; font-weight: bold; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; color: var(--text-muted); margin-bottom: 8px; font-size: 10px; }
        
        .trait-toggle-panel { background: #1e293b; padding: 8px; border-radius: 4px; margin-bottom: 10px; border: 1px solid var(--cyan); }
        .toggle-row { display: flex; align-items: center; justify-content: space-between; font-size: 11px; color: var(--cyan); }
        .switch { position: relative; display: inline-block; width: 30px; height: 16px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 16px; }
        .slider:before { position: absolute; content: ""; height: 10px; width: 10px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--cyan); }
        input:checked + .slider:before { transform: translateX(14px); }

        .action-btns { display: flex; flex-direction: column; gap: 5px; background: #1e293b; padding: 8px; border-radius: 4px; }
        .btn-row { display: flex; gap: 5px; align-items: center; width: 100%; }
        button { background: var(--blue); color: white; border: none; padding: 5px 8px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 11px; }
        .btn-a { background: var(--cyan); color: #000; flex: 1; } .btn-b { background: var(--red); color: #fff; flex: 1; }

        /* --- „É¨„Éº„ÉÄ„Éº„Éû„ÉÉ„ÉóÊîπÂñÑ --- */
        .map-panel { flex: 2.2; position: relative; display: flex; flex-direction: column; }
        .battlefield { 
            flex: 1; display: flex; justify-content: space-between; 
            background: radial-gradient(circle, #1e293b 1px, transparent 1px), #050b14;
            background-size: 30px 30px; border: 1px solid #334155; border-radius: 4px; 
            padding: 10px; overflow-y: auto; position: relative;
        }
        .map-zone { display: flex; flex-wrap: wrap; align-content: center; justify-content: center; gap: 4px; width: 23%; z-index: 1; }
        .map-center { width: 4%; border-left: 1px dashed rgba(239,68,68,0.3); border-right: 1px dashed rgba(6,182,212,0.3); }

        .map-unit { 
            background: rgba(15, 23, 42, 0.95); border: 1px solid #fff; padding: 2px; 
            text-align: center; border-radius: 3px; font-size: 8px; font-weight: bold; 
            width: 45%; max-width: 70px; min-height: 42px; position: relative; transition: 0.2s;
        }
        .map-unit.a { border-color: var(--cyan); color: var(--cyan); }
        .map-unit.b { border-color: var(--red); color: var(--red); }
        .map-unit.dead { opacity: 0.2; filter: grayscale(1); }
        
        /* ÊîπÂñÑÔºö„Éá„É•„Ç¢„É´„Çπ„ÉÜ„Éº„Çø„Çπ„Éê„Éº */
        .map-bar-container { position: absolute; bottom: 2px; left: 2px; right: 2px; display: flex; flex-direction: column; gap: 1px; }
        .map-mini-bar { height: 2px; background: #000; border-radius: 1px; overflow: hidden; width: 100%; }
        .map-fill-hp { height: 100%; background: var(--green); transition: width 0.3s; }
        .map-fill-morale { height: 100%; background: var(--blue); transition: width 0.3s; }

        @keyframes anim-atk { 0% { transform: scale(1); border-color: #fff; box-shadow: 0 0 15px #fff; } 100% { transform: scale(1); } }
        @keyframes anim-def { 0% { background: #9f1239; } 100% { background: rgba(15, 23, 42, 0.95); } }
        .anim-atk { animation: anim-atk 0.3s; z-index: 10; }
        .anim-def { animation: anim-def 0.3s; }

        .list-panel { flex: 1; overflow-y: auto; }
        .log-panel { flex: 1.6; overflow-y: auto; background: #020617; font-family: Consolas, monospace; font-size: 12px; line-height: 1.4; padding: 10px; border: 1px solid var(--panel-border); }
        .unit-card { background: #0f172a; border-left: 3px solid #475569; padding: 6px; margin-bottom: 6px; border-radius: 4px; font-size: 11px; }
        .unit-card.a { border-left-color: var(--cyan); } .unit-card.b { border-left-color: var(--red); }
        .bar-wrap { height: 10px; background: #000; border-radius: 2px; margin-top: 3px; position: relative; display: flex; overflow: hidden; }
        .bar-hp { background: var(--green); } .bar-dead { background: var(--red); } .bar-morale { background: var(--blue); }
        .bar-text { position: absolute; width: 100%; text-align: center; font-size: 8px; line-height: 10px; font-weight: bold; color: #fff; }
        .log-turn { color: var(--yellow); font-weight: bold; margin-top: 8px; border-bottom: 1px dashed #334155; }
        .log-atk { color: #c084fc; } .log-fatal { color: var(--red); font-weight: bold; }
        .faction-header { background: #1e293b; color: var(--yellow); font-size: 10px; padding: 3px 6px; margin: 8px 0 4px 0; border-left: 2px solid var(--yellow); }
    </style>
</head>
<body>

    <h1>TACTICAL COMMAND DUAL - Ver 14.0</h1>

    <div class="top-section">
        <div class="panel setup-panel">
            <div class="panel-title">‚ñº „Éá„Éº„Çø„Éô„Éº„Çπ</div>
            <div class="trait-toggle-panel">
                <div class="toggle-row">
                    <span>Âä¥ÂÉçËÄÖ„ÅÆÊâáÂãï (Èù©ÂëΩÊà¶Á∑ö)</span>
                    <label class="switch">
                        <input type="checkbox" id="trait-incite-workers">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <div id="setup-list"></div>
        </div>

        <div class="panel map-panel">
            <div class="panel-title">üì° „É¨„Éº„ÉÄ„Éº„É¢„Éã„Çø„Éº (HP:Á∑ë / Â£´Ê∞ó:Èùí)</div>
            <div class="battlefield" id="battlefield">
                <div class="map-zone" id="zone-a-back"></div>
                <div class="map-zone" id="zone-a-front"></div>
                <div class="map-center"></div>
                <div class="map-zone" id="zone-b-front"></div>
                <div class="map-zone" id="zone-b-back"></div>
            </div>
            <div class="controls" style="display:flex; gap:5px; margin-top:8px; justify-content:center;">
                <button id="btn-start" onclick="startBattle()" style="background: var(--green); padding:8px 15px;">‚öîÔ∏è ÈñãÂßã</button>
                <button id="btn-next" onclick="runTurn()" disabled>‚è≠ Ê¨°T</button>
                <button id="btn-auto" onclick="toggleAuto()" disabled>‚è© „Ç™„Éº„Éà</button>
                <button onclick="resetGame()" style="background:transparent; border:1px solid var(--red); color:var(--red);">üîÑ „É™„Çª„ÉÉ„Éà</button>
            </div>
        </div>
    </div>

    <div class="bottom-section">
        <div class="panel list-panel" id="panel-a"><div class="panel-title" id="title-a" style="color:var(--cyan)">[A] ÊîªÊíÉËªç</div><div id="list-a"></div></div>
        <div id="log-area" class="panel log-panel"><div style="color:var(--text-muted)">SYSTEM ONLINE...</div></div>
        <div class="panel list-panel" id="panel-b"><div class="panel-title" id="title-b" style="color:var(--red)">[B] Èò≤Ë°õËªç</div><div id="list-b"></div></div>
    </div>

    <script>
        const roll = (sides) => Math.floor(Math.random() * sides) + 1;
        const roll100 = () => Math.floor(Math.random() * 100) + 1;
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // Èü≥Â£∞„Ç®„É≥„Ç∏„É≥
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(f, t, d, v=0.05) {
            try { const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type=t; o.frequency.setValueAtTime(f, audioCtx.currentTime); g.gain.setValueAtTime(v, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+d); o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+d); } catch(e){}
        }
        const sfx = { hit:()=>playSound(150,'square',0.1), heal:()=>playSound(900,'sine',0.2), route:()=>playSound(60,'sawtooth',0.5), win:()=>playSound(500,'sine',0.5), rein:()=>playSound(300,'sine',0.4) };

        const DATABASE = {
            "„É©„É´„Ç≠„Ç¢ÂõΩÂÆ∂Á§æ‰ºö‰∏ªÁæ©‰∫∫Ê∞ëÂÖ±ÂíåÂõΩ": {
                "Á¨¨„ÄáÊ≠©ÂÖµÂ§ßÈöä": { size: 600, cat: "ÊúÄÂâçË°õÈÉ®Èöä", morale: 50, agi: 30, arm: 0, hp: 10, fail: 40, gen: [1, 1], spc: [1, 3], reck: [1, 3], traits: ["Èù©ÂëΩ‰∏áÊ≠≥"] },
                "Á¨¨„ÄáÊîøÊ≤ªÁõ£ÊüªÂßîÂì°‰∏≠Èöä": { size: 100, cat: "ÂæåÊè¥ÈÉ®Èöä", morale: 200, agi: 30, arm: 0, hp: 10, fail: 30, gen: [1, 1], spc: [1, 2], reck: [1, 2], traits: ["Èù©ÂëΩ‰∏áÊ≠≥", "Á≤õÊ∏Ö"] },
                "Á¨¨„ÄáË°õÁîü‰∏≠Èöä": { size: 100, cat: "ÂæåÊè¥ÈÉ®Èöä", morale: 100, agi: 80, arm: 3, hp: 10, fail: 10, gen: [2, 2], spc: [3, 3], reck: [4, 5], traits: ["Ë°õÁîüÂÖµ"] },
                "Á¨¨„ÄáÊîØÊè¥Á†≤ÂÖµ‰∏≠Èöä": { size: 100, cat: "ÊúÄÂæåË°õÈÉ®Èöä", morale: 60, agi: 0, arm: 0, hp: 10, fail: 60, gen: [1, 6], spc: [1, 8], reck: [1, 4], traits: ["Ë≤´Âæπ"] }
            },
            "ÂÖ®Âúü„Ç´„É´„É¥„Çß„ÉäÈù©ÂëΩÊà¶Á∑ö": {
                "Á¨¨„ÄáÈù©ÂëΩ„Éë„É´„ÉÅ„Ç∂„É≥Â§ßÈöä": { size: 600, cat: "ÊúÄÂâçË°õÈÉ®Èöä", morale: 200, agi: 0, arm: 0, hp: 10, fail: 60, gen: [1, 2], spc: [1, 2], reck: [1, 5], traits: ["Èù©ÂëΩ‰∏áÊ≠≥"] }
            },
            "„Ç´„É´„É¥„Çß„ÉäÂ∏ùÂõΩ": {
                "Á¨¨„ÄáÊ≠£Ë¶èÊ≠©ÂÖµÂ§ßÈöä": { size: 600, cat: "ÊúÄÂâçË°õÈÉ®Èöä", morale: 100, agi: 20, arm: 0, hp: 10, fail: 30, gen: [1, 2], spc: [1, 2], reck: [1, 3], traits: ["ÁöáÂ∏ùÈôõ‰∏ã‰∏áÊ≠≥"] },
                "Á¨¨„ÄáÂ∏ùÁ´ãÈáçË£ÖÁî≤‰∏≠Èöä": { size: 100, cat: "ÁâπÊÆäÈÉ®Èöä", morale: 250, agi: 10, arm: 6, hp: 10, fail: 30, gen: [1, 5], spc: [1, 6], reck: [1, 3], traits: ["ÁöáÂ∏ùÈôõ‰∏ã‰∏áÊ≠≥", "Ë≤´Âæπ", "ÈáçÈàç"] }
            }
        };

        const WORKER_PRESET = { size: 100, cat: "ÊúÄÂâçË°õÈÉ®Èöä", morale: 50, agi: 0, arm: 0, hp: 7, fail: 65, gen: [1, 1], spc: [1, 1], reck: [2, 3], traits: ["Èù©ÂëΩ‰∏áÊ≠≥"] };

        class Unit {
            constructor(name, preset, affiliation, team, id) {
                this.id = id; this.name = name; this.affiliation = affiliation; this.team = team; 
                this.category = preset.cat; this.size = preset.size; 
                this.morale = preset.morale; this.max_morale = preset.morale;
                this.agi = preset.agi; this.arm = preset.arm; this.hp = preset.hp || 10; this.fail = preset.fail;
                this.dice = { "ÈÄöÂ∏∏ÊîªÊíÉ": [...preset.gen], "ÁâπÊÆäÊîªÊíÉ": [...preset.spc], "ÁÑ°Ë¨Ä„Å™ÊîªÊíÉ": [...preset.reck] };
                this.traits = preset.traits || [];
                this.hpList = new Array(this.size).fill(this.hp);
                this.statusList = new Array(this.size).fill(0); 
                this.isRouted = false; this.turnStartDead = 0; 
            }
            getActive() { return this.statusList.filter(s => s === 0).length; }
            getFaint() { return this.statusList.filter(s => s === 1 || s === 2).length; }
            getDead() { return this.statusList.filter(s => s === -1).length; }
            isAlive() { return (this.max_morale === "/" || !this.isRouted) && this.statusList.some(s => s !== -1); }
            takeDamage(dmg, isPiercing = false) {
                if (!this.isAlive() || roll100() <= this.fail) return { hit: false, killed: false };
                let actualDmg = Math.min(Math.max(0, dmg - (isPiercing ? 0 : this.arm)), this.hp);
                let targets = []; for(let i=0; i<this.size; i++) if(this.statusList[i] >= 0) targets.push(i);
                if(targets.length === 0) return { hit: false, killed: false };
                let idx = targets[Math.floor(Math.random() * targets.length)];
                let oldHp = this.hpList[idx]; this.hpList[idx] -= actualDmg;
                if (oldHp > 1 && this.hpList[idx] <= 0) this.hpList[idx] = 1;
                if (this.hpList[idx] <= this.hp / 2 && this.statusList[idx] === 0) this.statusList[idx] = 1;
                let killed = false; if (this.hpList[idx] <= 0) { this.statusList[idx] = -1; killed = true; }
                return { hit: true, killed: killed };
            }
            receiveHealing(amount) {
                let targets = []; for(let i=0; i<this.size; i++) if(this.statusList[i] === 1 || this.statusList[i] === 2) targets.push(i);
                if(targets.length === 0) return false;
                let idx = targets[Math.floor(Math.random() * targets.length)];
                this.hpList[idx] = Math.min(this.hp, this.hpList[idx] + amount);
                if(this.hpList[idx] > this.hp / 2) { this.statusList[idx] = 0; return true; }
                return false;
            }
            applyMoraleDamage(deaths) {
                if(this.max_morale==="/" || this.isRouted || deaths<=0) return false;
                let d = deaths + roll(20);
                if(this.traits.includes("ÁöáÂ∏ùÈôõ‰∏ã‰∏áÊ≠≥")) d = Math.floor(d/2);
                if(this.traits.includes("Èù©ÂëΩ‰∏áÊ≠≥") && roll100()<=30) d=0;
                if(d>0) this.morale -= d;
                return this.morale <= 0;
            }
        }

        let teams = { A: [], B: [] };
        let turn = 1; let isBattling = false; let autoMode = false; let unitCounter = 0; let isProcessing = false;

        function initSetup() {
            const list = document.getElementById("setup-list");
            list.innerHTML = "";
            for (let [faction, units] of Object.entries(DATABASE)) {
                let html = `<details class="faction-group"><summary class="faction-summary">üéå ${faction}</summary>`;
                for (let [key, data] of Object.entries(units)) {
                    let sid = `set-${unitCounter++}`;
                    html += `<details class="unit-details"><summary class="unit-summary">${key}</summary>
                        <div class="preset-info">
                            <div class="stat-grid"><div>ÂÖµÁßë: ${data.cat}</div><div>Ë¶èÊ®°: ${data.size}</div><div>Â£´Ê∞ó: ${data.morale}</div><div>Ë£ÖÁî≤: ${data.arm}</div></div>
                            <div class="action-btns">
                                <div class="btn-row"><span>Ë£ÖÂÇô:</span><select id="eq-${sid}"><option value="none">„Å™„Åó</option><option value="mg">Ê©üÈñ¢ÈäÉ (+2D1ÁâπÊÆä)</option><option value="sp">Â°πÂ£ï„Çπ„Ç≥„ÉÉ„Éó (+1Ë£ÖÁî≤)</option></select></div>
                                <div class="btn-row"><span>Êï∞:</span><input type="number" id="ct-${sid}" value="1" min="1" max="5" style="width:35px">
                                <button class="btn-a" onclick="addUnit('${faction}','${key}','${sid}','A')">‚óÄ A</button><button class="btn-b" onclick="addUnit('${faction}','${key}','${sid}','B')">B ‚ñ∂</button></div>
                            </div>
                        </div></details>`;
                }
                list.innerHTML += html + `</details>`;
            }
        }

        function addUnit(fac, key, sid, team) {
            if(isBattling) return;
            let d = DATABASE[fac][key], c = parseInt(document.getElementById(`ct-${sid}`).value), eq = document.getElementById(`eq-${sid}`).value;
            for(let i=0; i<c; i++){
                let name = key.replace('„Äá', Math.floor(Math.random()*84)+1);
                let u = new Unit(name, d, fac, team, `u${unitCounter++}`);
                if(eq==='mg' && d.size===600) { u.name+='(Ê©üÈäÉ)'; u.dice["ÁâπÊÆäÊîªÊíÉ"][0]+=2; u.dice["ÁâπÊÆäÊîªÊíÉ"][1]+=1; }
                if(eq==='sp' && d.arm===0) { u.name+='(Êéò)'; u.arm+=1; u.agi-=50; }
                teams[team].push(u);
            }
            updateUI();
        }

        function updateUI() {
            ["A", "B"].forEach(teamId => {
                const list = document.getElementById(`list-${teamId.toLowerCase()}`);
                list.innerHTML = "";
                let stats = { a:0, f:0, d:0 };
                let grouped = {};
                teams[teamId].forEach(u => { if(!grouped[u.affiliation]) grouped[u.affiliation]=[]; grouped[u.affiliation].push(u); });
                for(let [fac, units] of Object.entries(grouped)){
                    list.innerHTML += `<div class="faction-header">${fac}</div>`;
                    units.forEach(u => {
                        let active = u.getActive(), faint = u.getFaint(), dead = u.getDead();
                        stats.a+=active; stats.f+=faint; stats.d+=dead;
                        let hpP = ((active+faint)/u.size)*100, mP = u.max_morale==="/"?100:Math.max(0,(u.morale/u.max_morale)*100);
                        list.innerHTML += `<div class="unit-card ${teamId.toLowerCase()}" style="${u.isAlive()?'':'opacity:0.5'}">
                            <div style="display:flex; justify-content:space-between; font-weight:bold;"><span>${u.name}</span><button style="display:${isBattling?'none':'block'}; background:none; color:red; border:none; cursor:pointer;" onclick="removeUnit('${teamId}','${u.id}')">‚úñ</button></div>
                            <div class="bar-wrap"><div class="bar-hp" style="width:${hpP}%"></div><div class="bar-text">Áîü:${active} / Ê∞ó:${faint} / Ê≠ª:${dead}</div></div>
                            <div class="bar-wrap"><div class="bar-morale" style="width:${mP}%"></div><div class="bar-text">Â£´Ê∞ó: ${u.morale}</div></div>
                        </div>`;
                    });
                }
                document.getElementById(`title-${teamId.toLowerCase()}`).innerHTML = `[${teamId}] ${teamId==="A"?'ÊîªÊíÉ':'Èò≤Ë°õ'} <span style="font-size:9px;">(Áîü:${stats.a} Ê∞ó:${stats.f} Ê≠ª:${stats.d})</span>`;
            });

            // „Éû„ÉÉ„ÉóÊèèÁîªÊîπÂñÑÔºö„Ç¢„Ç§„Ç≥„É≥„ÅÆÁ∏ÆÂ∞è„Å®„Çπ„ÉÜ„Éº„Çø„Çπ„Éê„Éº
            document.querySelectorAll('.map-zone').forEach(z => z.innerHTML='');
            [...teams.A, ...teams.B].forEach(u => {
                let s = u.team.toLowerCase();
                let z = (u.category.includes('ÂæåÊè¥') || u.category.includes('ÊúÄÂæåË°õ')) ? `zone-${s}-back` : `zone-${s}-front`;
                let hpP = ((u.getActive()+u.getFaint())/u.size)*100;
                let mP = u.max_morale==="/"?100:Math.max(0,(u.morale/u.max_morale)*100);
                
                // „Ç¢„Ç§„Ç≥„É≥„Çµ„Ç§„Ç∫„ÅÆÂãïÁöÑË™øÊï¥ (ÈÉ®ÈöäÊï∞„ÅåÂ§ö„ÅÑ„Å®„Çà„ÇäÂ∞è„Åï„Åè)
                let unitCount = teams[u.team].length;
                let fontSize = unitCount > 10 ? '7px' : '8px';
                
                document.getElementById(z).innerHTML += `
                    <div class="map-unit ${s} ${u.isAlive()?'':'dead'}" id="map-${u.id}" style="font-size:${fontSize}">
                        ${u.name.split(' ')[0]}<br>
                        <span style="opacity:0.6">${u.getActive()}</span>
                        <div class="map-bar-container">
                            <div class="map-mini-bar"><div class="map-fill-hp" style="width:${hpP}%"></div></div>
                            <div class="map-mini-bar"><div class="map-fill-morale" style="width:${mP}%"></div></div>
                        </div>
                    </div>`;
            });
        }

        function removeUnit(t, id) { teams[t] = teams[t].filter(u => u.id !== id); updateUI(); }
        function toggleAuto() { autoMode = !autoMode; document.getElementById("btn-auto").innerHTML = autoMode?"‚è∏ ÂÅúÊ≠¢":"‚è© „Ç™„Éº„Éà"; if(autoMode && !isProcessing) runTurn(); }

        async function runTurn() {
            if(isProcessing) return; isProcessing = true;
            document.getElementById("btn-next").disabled = true;
            const log = (msg, cls='') => { const a=document.getElementById("log-area"); a.innerHTML+=`<div class="${cls}">${msg}</div>`; a.scrollTop=a.scrollHeight; };
            log(`‚ñº TURN ${turn} ‚ñº`, 'log-turn');

            if (document.getElementById('trait-incite-workers').checked && turn % 2 === 0) {
                ["A", "B"].forEach(side => {
                    if (teams[side].some(u => u.affiliation === "ÂÖ®Âúü„Ç´„É´„É¥„Çß„ÉäÈù©ÂëΩÊà¶Á∑ö")) {
                        let name = `Á¨¨${Math.floor(Math.random()*84)+1}Âä¥ÂÉçËÄÖ‰∏≠Èöä`;
                        teams[side].push(new Unit(name, WORKER_PRESET, "ÂÖ®Âúü„Ç´„É´„É¥„Çß„ÉäÈù©ÂëΩÊà¶Á∑ö", side, `u_i_${unitCounter++}`));
                        log(`üì¢„ÄêÊâáÂãï„Äë${side}Ëªç„Å´ ${name} Âà∞ÁùÄÔºÅ`, 'log-atk'); sfx.rein();
                    }
                });
                updateUI();
            }

            let all = [...teams.A, ...teams.B];
            all.forEach(u => u.turnStartDead = u.getDead());

            // ‰øÆÊ≠£ÔºöÈáçÈàç„É¶„Éã„ÉÉ„Éà„ÇÇ„Ç´„ÉÜ„Ç¥„É™„ÉºÈ†Ü„ÇíÂÆà„Çã
            let cats = ["ÁâπÊÆäÈÉ®Èöä", "ÊúÄÂæåË°õÈÉ®Èöä", "ÊúÄÂâçË°õÈÉ®Èöä", "ÂæåÊè¥ÈÉ®Èöä"];
            let actionList = [];
            cats.forEach(c => all.filter(u => u.category === c && !u.traits.includes('ÈáçÈàç')).forEach(u => actionList.push(u)));
            cats.forEach(c => all.filter(u => u.category === c && u.traits.includes('ÈáçÈàç')).forEach(u => actionList.push(u)));

            for (let atk of actionList) {
                if(!atk.isAlive()) continue;
                let isM = atk.traits.includes('Ë°õÁîüÂÖµ'), target;
                if(isM) {
                    let allies = teams[atk.team].filter(u => u.isAlive() && !u.traits.includes('Ë°õÁîüÂÖµ') && u.getFaint() > 0);
                    if(!allies.length) allies = teams[atk.team].filter(u => u.isAlive() && !u.traits.includes('Ë°õÁîüÂÖµ') && u !== atk);
                    target = allies[Math.floor(Math.random()*allies.length)];
                } else {
                    let enemies = teams[atk.team==='A'?'B':'A'].filter(u => u.isAlive());
                    target = enemies[Math.floor(Math.random()*enemies.length)];
                }
                if(!target) continue;

                const aEl = document.getElementById(`map-${atk.id}`), tEl = document.getElementById(`map-${target.id}`);
                if(aEl) aEl.classList.add('anim-atk'); if(tEl) tEl.classList.add('anim-def');
                if(isM) sfx.heal(); else sfx.hit();
                await sleep(300);
                if(aEl) aEl.classList.remove('anim-atk'); if(tEl) tEl.classList.remove('anim-def');

                let rollV = roll(6), type = rollV===1?"ÁâπÊÆä":(rollV===6?"ÁÑ°Ë¨Ä":"ÈÄöÂ∏∏");
                let [dN, dS] = atk.dice[type==="ÈÄöÂ∏∏"?"ÈÄöÂ∏∏ÊîªÊíÉ":(type==="ÁâπÊÆä"?"ÁâπÊÆäÊîªÊíÉ":"ÁÑ°Ë¨Ä„Å™ÊîªÊíÉ")];
                let hits = 0, kills = 0, revs = 0, selfK = 0, count = atk.getActive();

                for(let i=0; i<count; i++){
                    let d = 0; for(let j=0; j<dN; j++) d += roll(dS);
                    if(isM){ if(target.receiveHealing(d)) revs++; if(type==="ÁÑ°Ë¨Ä" && atk.takeDamage(Math.floor(d*0.3)).killed) selfK++; }
                    else {
                        let res = target.takeDamage(d, atk.traits.includes('Ë≤´Âæπ'));
                        if(res.hit) hits++; if(res.killed) kills++;
                        if(type==="ÁÑ°Ë¨Ä" && atk.takeDamage(Math.floor(d*0.3)).killed) selfK++;
                    }
                }
                updateUI();
            }

            all.forEach(u => {
                for(let i=0; i<u.size; i++) if(u.statusList[i]===1) u.statusList[i]=2; else if(u.statusList[i]===2){ u.statusList[i]=-1; u.hpList[i]=0; }
                if(u.isAlive() && u.applyMoraleDamage(u.getDead()-u.turnStartDead)){
                    let commissar = teams[u.team].find(c => c.traits.includes('Á≤õÊ∏Ö') && c.isAlive() && c !== u);
                    if(commissar){
                        let aliveIds = []; u.statusList.forEach((s,idx)=>{ if(s!==-1) aliveIds.push(idx); });
                        let killC = Math.floor(aliveIds.length/2);
                        for(let i=0; i<killC; i++) { let rIdx = aliveIds.splice(Math.floor(Math.random()*aliveIds.length),1)[0]; u.statusList[rIdx]=-1; u.hpList[rIdx]=0; }
                        u.max_morale="/"; u.morale="/"; sfx.purge; log(`üí•„ÄêÁ≤õÊ∏Ö„Äë${u.name} ÂÜçÁ∑®ÔºÅ`, 'log-fatal');
                    } else { u.isRouted=true; u.statusList.forEach((s,idx)=>{ if(s>0) u.statusList[idx]=-1; }); sfx.route(); log(`‚ö†Ô∏è„ÄêÊïóËµ∞„Äë${u.name} Â¥©Â£äÔºÅ`, 'log-fatal'); }
                }
            });

            turn++; updateUI(); isProcessing = false;
            let winA = teams.B.every(u => !u.isAlive()), winB = teams.A.every(u => !u.isAlive());
            if(winA || winB){ autoMode = false; sfx.win(); log(`üèÜ Êà¶ÈóòÁµÇ‰∫Ü: ${winA?'AËªç':'BËªç'}ÂãùÂà©ÔºÅ`, 'log-turn'); return; }
            if(autoMode) setTimeout(runTurn, 400); else document.getElementById("btn-next").disabled = false;
        }

        function startBattle(){ if(!teams.A.length||!teams.B.length) return; audioCtx.resume(); isBattling=true; document.getElementById("btn-start").disabled=true; document.getElementById("btn-next").disabled=false; document.getElementById("btn-auto").disabled=false; updateUI(); }
        function resetGame(){ teams={A:[],B:[]}; turn=1; isBattling=false; autoMode=false; unitCounter=0; isProcessing=false; document.getElementById("btn-start").disabled=false; document.getElementById("btn-next").disabled=true; document.getElementById("btn-auto").innerHTML="‚è© „Ç™„Éº„Éà"; updateUI(); }
        initSetup();
    </script>
</body>
</html>
