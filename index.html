<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TACTICAL COMMAND DUAL</title>
    <style>
        /* ãƒ¢ãƒ€ãƒ³ãƒ»ã‚µã‚¤ãƒãƒ¼ãƒ‘ãƒ³ã‚¯é¢¨ã®CSS */
        :root {
            --bg-color: #0b1120; --panel-bg: #1e293b; --panel-border: #334155;
            --accent-cyan: #22d3ee; --accent-red: #f43f5e; --accent-green: #10b981;
            --text-main: #f8fafc; --text-sub: #94a3b8;
            --font-main: 'Segoe UI', Meiryo, sans-serif; --font-mono: Consolas, monospace;
        }
        * { box-sizing: border-box; }
        body { margin: 0; padding: 15px; background: var(--bg-color); color: var(--text-main); font-family: var(--font-main); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        h1 { text-align: center; margin: 0 0 15px 0; color: #fff; text-shadow: 0 0 10px var(--accent-cyan); letter-spacing: 2px; font-size: 22px; }
        
        /* ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .container { display: flex; flex: 1; gap: 15px; min-height: 0; }
        .side-col { width: 320px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; padding-right: 5px; }
        .center-col { flex: 1; display: flex; flex-direction: column; gap: 15px; min-width: 0; }
        
        /* ãƒ‘ãƒãƒ«å…±é€š */
        .panel { background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: 6px; padding: 15px; display: flex; flex-direction: column; }
        .panel-header { font-size: 14px; font-weight: bold; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid var(--panel-border); }
        
        /* éƒ¨éšŠç·¨æˆã‚¨ãƒªã‚¢ */
        .setup-area { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        select, input { background: #0f172a; color: #fff; border: 1px solid #475569; padding: 6px; border-radius: 4px; font-family: var(--font-main); }
        button { background: #3b82f6; color: #fff; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { background: #60a5fa; box-shadow: 0 0 8px #3b82f6; }
        button:disabled { background: #475569; color: #94a3b8; cursor: not-allowed; box-shadow: none; }
        .btn-red { background: var(--accent-red); } .btn-red:hover { background: #fb7185; box-shadow: 0 0 8px var(--accent-red); }
        .btn-green { background: var(--accent-green); } .btn-green:hover { background: #34d399; box-shadow: 0 0 8px var(--accent-green); }
        
        /* ãƒ¦ãƒ‹ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ */
        .unit-card { background: #0f172a; border-left: 4px solid #475569; padding: 10px; border-radius: 4px; margin-bottom: 10px; transition: 0.3s; }
        .unit-card.team-a { border-left-color: var(--accent-cyan); }
        .unit-card.team-b { border-left-color: var(--accent-red); }
        .unit-card.routed { opacity: 0.5; border-left-color: #64748b; filter: grayscale(80%); }
        .unit-header { display: flex; justify-content: space-between; font-size: 14px; font-weight: bold; margin-bottom: 8px; }
        .unit-stats { font-size: 11px; color: var(--text-sub); display: flex; justify-content: space-between; margin-top: 5px; }
        
        /* ã‚²ãƒ¼ã‚¸ãƒãƒ¼ */
        .bar-wrap { background: #000; height: 14px; border-radius: 3px; position: relative; margin-bottom: 4px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.3s; }
        .bar-fill.hp { background: linear-gradient(90deg, #047857, #10b981); }
        .bar-fill.morale { background: linear-gradient(90deg, #1d4ed8, #3b82f6); }
        .bar-text { position: absolute; top: 0; left: 5px; font-size: 10px; line-height: 14px; font-weight: bold; color: #fff; text-shadow: 1px 1px 1px #000; }
        
        /* ãƒ­ã‚°ã‚¨ãƒªã‚¢ */
        .log-area { flex: 1; background: #020617; border: 1px solid var(--panel-border); border-radius: 6px; padding: 15px; overflow-y: auto; font-family: var(--font-mono); font-size: 13px; line-height: 1.6; }
        .log-turn { color: #facc15; font-weight: bold; margin-top: 15px; border-bottom: 1px dashed #334155; padding-bottom: 5px; }
        .log-atk { color: #c084fc; }
        .log-dmg { color: #cbd5e1; }
        .log-fatal { color: #f87171; }
        .log-route { color: #fff; background: #9f1239; padding: 2px 5px; font-weight: bold; display: inline-block; margin: 2px 0; border-radius: 2px; }
        .log-sys { color: var(--text-sub); }
        
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼è£…é£¾ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body>

    <h1>TACTICAL COMMAND DUAL - Web UI Edition</h1>

    <div class="panel" style="margin-bottom: 15px;">
        <div class="setup-area">
            <select id="sel-preset">
                <option value="ç¬¬13é©å‘½ãƒ‘ãƒ«ãƒã‚¶ãƒ³å¤§éšŠ">ç¬¬13é©å‘½ãƒ‘ãƒ«ãƒã‚¶ãƒ³å¤§éšŠ</option>
                <option value="ç¬¬22æ­©å…µå¤§éšŠ">ç¬¬22æ­©å…µå¤§éšŠ</option>
                <option value="å¾Œæ–¹æ”¯æ´ä¸­éšŠ">å¾Œæ–¹æ”¯æ´ä¸­éšŠ (100äºº)</option>
                <option value="ç‰¹æ®Šæš—æ®ºå°éšŠ">ç‰¹æ®Šæš—æ®ºå°éšŠ (20äºº)</option>
            </select>
            <span>é…å‚™æ•°:</span>
            <input type="number" id="inp-count" value="1" min="1" max="10" style="width: 60px;">
            <button onclick="addUnit('A')" style="background: var(--accent-cyan); color: #000;">â—€ æ”»æ’ƒ(A)ã«é…å‚™</button>
            <button onclick="addUnit('B')" style="background: var(--accent-red); color: #fff;">é˜²è¡›(B)ã«é…å‚™ â–¶</button>
            <span style="flex:1;"></span>
            <button id="btn-start" onclick="startBattle()" class="btn-green">âš”ï¸ æˆ¦é—˜é–‹å§‹</button>
            <button id="btn-next" onclick="runTurn()" disabled>â­ æ¬¡ã‚¿ãƒ¼ãƒ³</button>
            <button id="btn-auto" onclick="runAuto()" disabled>â© è‡ªå‹•å®Ÿè¡Œ</button>
            <button onclick="resetGame()" class="btn-red">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    </div>

    <div class="container">
        <div class="side-col">
            <div class="panel" style="flex:1; padding-right:5px;">
                <div class="panel-header" style="color: var(--accent-cyan);">[A] æ”»æ’ƒè»é…å‚™çŠ¶æ³</div>
                <div id="list-a" style="overflow-y: auto;"></div>
            </div>
        </div>

        <div class="center-col">
            <div id="log" class="log-area">
                <div class="log-sys">SYSTEM: å¸ä»¤å®˜ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãŒã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«ãªã‚Šã¾ã—ãŸã€‚éƒ¨éšŠã‚’é…å‚™ã—ã¦ãã ã•ã„ã€‚</div>
            </div>
        </div>

        <div class="side-col">
            <div class="panel" style="flex:1; padding-right:5px;">
                <div class="panel-header" style="color: var(--accent-red);">[B] é˜²è¡›è»é…å‚™çŠ¶æ³</div>
                <div id="list-b" style="overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <script>
        // --- ä¹±æ•°ãƒ„ãƒ¼ãƒ« ---
        const roll = (sides) => Math.floor(Math.random() * sides) + 1;
        const roll100 = () => Math.floor(Math.random() * 100) + 1;

        // --- ãƒ¦ãƒ‹ãƒƒãƒˆãƒ—ãƒªã‚»ãƒƒãƒˆ ---
        const PRESETS = {
            "ç¬¬13é©å‘½ãƒ‘ãƒ«ãƒã‚¶ãƒ³å¤§éšŠ": { size: 600, cat: "æœ€å‰è¡›éƒ¨éšŠ", morale: 200, agi: 0, arm: 0, hp: 10, fail: 60, gen: [1, 2], spc: [1, 2], reck: [1, 5], traits: ["é©å‘½ä¸‡æ­³"] },
            "ç¬¬22æ­©å…µå¤§éšŠ": { size: 600, cat: "æœ€å‰è¡›éƒ¨éšŠ", morale: 100, agi: 20, arm: 0, hp: 10, fail: 30, gen: [1, 2], spc: [1, 2], reck: [1, 3], traits: ["çš‡å¸é™›ä¸‹ä¸‡æ­³"] },
            "å¾Œæ–¹æ”¯æ´ä¸­éšŠ": { size: 100, cat: "å¾Œæ´éƒ¨éšŠ", morale: 80, agi: 10, arm: 1, hp: 15, fail: 40, gen: [1, 3], spc: [1, 4], reck: [1, 6], traits: [] },
            "ç‰¹æ®Šæš—æ®ºå°éšŠ": { size: 20, cat: "ç‰¹æ®Šéƒ¨éšŠ", morale: 150, agi: 50, arm: 0, hp: 20, fail: 10, gen: [2, 6], spc: [3, 6], reck: [1, 10], traits: [] }
        };

        // --- ã‚¯ãƒ©ã‚¹å®šç¾© ---
        class Unit {
            constructor(name, preset, team, id) {
                this.id = id;
                this.name = `${team}: ${name}`;
                this.team = team;
                this.category = preset.cat;
                this.size = preset.size;
                this.morale = preset.morale;
                this.max_morale = preset.morale;
                this.agi = preset.agi;
                this.arm = preset.arm;
                this.hp = preset.hp;
                this.fail = preset.fail;
                this.dice = { "é€šå¸¸æ”»æ’ƒ": preset.gen, "ç‰¹æ®Šæ”»æ’ƒ": preset.spc, "ç„¡è¬€ãªæ”»æ’ƒ": preset.reck };
                this.traits = preset.traits;
                
                // å‹•çš„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
                this.hpList = new Array(this.size).fill(this.hp);
                this.statusList = new Array(this.size).fill(0); // 0:ç”Ÿå­˜, 1-2:æ°—çµ¶, -1:æ­»äº¡
                this.isRouted = false;
                this.turnDeaths = 0;
            }

            getActive() { return this.statusList.filter(s => s === 0).length; }
            getFaint() { return this.statusList.filter(s => s === 1 || s === 2).length; }
            getDead() { return this.statusList.filter(s => s === -1).length; }
            isAlive() { 
                if (this.max_morale === "/") return this.statusList.some(s => s !== -1);
                return !this.isRouted && this.statusList.some(s => s !== -1); 
            }

            takeDamage(dmg) {
                if (!this.isAlive() || roll100() <= this.fail) return false;
                
                let actualDmg = Math.min(Math.max(0, dmg - this.arm), this.hp);
                let targets = [];
                for(let i=0; i<this.size; i++) if(this.statusList[i] >= 0) targets.push(i);
                if(targets.length === 0) return false;

                let idx = targets[Math.floor(Math.random() * targets.length)];
                let oldHp = this.hpList[idx];
                this.hpList[idx] -= actualDmg;

                // 1è€ãˆãƒ«ãƒ¼ãƒ«
                if (oldHp > 0 && this.hpList[idx] <= 0) this.hpList[idx] = 1;

                if (this.hpList[idx] <= this.hp / 2 && this.statusList[idx] === 0) {
                    this.statusList[idx] = 1; // æ°—çµ¶
                } else if (this.hpList[idx] <= 0) {
                    this.statusList[idx] = -1; // æ­»äº¡
                    this.turnDeaths++;
                    
                    // å£«æ°—ãƒã‚§ãƒƒã‚¯ï¼ˆæ­»äº¡ã™ã‚‹ã”ã¨ã«æ¯å›åˆ¤å®šï¼‰
                    if (this.max_morale !== "/" && !this.isRouted) {
                        let threshold = this.traits.includes("çš‡å¸é™›ä¸‹ä¸‡æ­³") ? 49 : 45;
                        if (roll100() <= threshold) {
                            this.morale--;
                            if (this.morale <= 0) {
                                this.isRouted = true;
                                logHTML(`<span class="log-route">âš ï¸ã€æˆ¦ç·šå´©å£Šã€‘ ${this.name} ã¯å£«æ°—ãŒå°½ãã€æ•—èµ°ã—ãŸï¼</span>`);
                                // æ•—èµ°æ™‚ã€æ®‹ã‚Šã®æ°—çµ¶è€…ã¯æ­»äº¡
                                for(let i=0; i<this.size; i++) {
                                    if(this.statusList[i] > 0) this.statusList[i] = -1;
                                }
                            }
                        }
                    }
                }
                return true;
            }
        }

        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        let teams = { "A": [], "B": [] };
        let turn = 1;
        let isBattling = false;
        let autoInterval = null;
        let unitCounter = 0;

        // --- UIé–¢æ•° ---
        function logHTML(html) {
            const logArea = document.getElementById("log");
            let div = document.createElement("div");
            div.innerHTML = html;
            logArea.appendChild(div);
            logArea.scrollTop = logArea.scrollHeight;
        }

        function renderRoster() {
            ["A", "B"].forEach(t => {
                const container = document.getElementById(`list-${t.toLowerCase()}`);
                container.innerHTML = "";
                teams[t].forEach(u => {
                    let active = u.getActive(), faint = u.getFaint(), dead = u.getDead();
                    let hpPct = Math.max(0, (active + faint) / u.size * 100);
                    let morPct = u.max_morale === "/" ? 100 : Math.max(0, u.morale / u.max_morale * 100);
                    let status = u.isRouted ? "æ•—èµ°" : (dead >= u.size ? "å…¨æ»…" : "æˆ¦é—˜ä¸­");
                    let stateClass = u.isRouted || dead >= u.size ? "routed" : "";
                    
                    container.innerHTML += `
                        <div class="unit-card team-${t.toLowerCase()} ${stateClass}">
                            <div class="unit-header">
                                <span>${u.name}</span>
                                <span style="color:${u.isRouted?'#f87171':'#34d399'}; font-size:12px;">${status}</span>
                            </div>
                            <div class="bar-wrap">
                                <div class="bar-fill hp" style="width:${hpPct}%"></div>
                                <div class="bar-text">ç”Ÿå­˜: ${active} / æ°—çµ¶: ${faint}</div>
                            </div>
                            <div class="bar-wrap">
                                <div class="bar-fill morale" style="width:${morPct}%"></div>
                                <div class="bar-text">å£«æ°—: ${u.max_morale === "/" ? "ç„¡é™" : u.morale}</div>
                            </div>
                            <div class="unit-stats">
                                <span>[${u.category}]</span>
                                <span>æ©Ÿå‹•:${u.agi} å¤±æ•—:${u.fail}%</span>
                            </div>
                        </div>
                    `;
                });
            });
        }

        // --- ãƒ­ã‚¸ãƒƒã‚¯ ---
        function addUnit(team) {
            if(isBattling) return alert("æˆ¦é—˜ä¸­ã¯è¿½åŠ ã§ãã¾ã›ã‚“");
            let key = document.getElementById("sel-preset").value;
            let count = parseInt(document.getElementById("inp-count").value);
            for(let i=0; i<count; i++) {
                teams[team].push(new Unit(key, PRESETS[key], team, `u${unitCounter++}`));
            }
            renderRoster();
            logHTML(`<span class="log-sys">SYSTEM: [${team}è»] ã« ${key} ã‚’é…å‚™ã—ã¾ã—ãŸã€‚</span>`);
        }

        function resetGame() {
            teams = { "A": [], "B": [] };
            turn = 1; isBattling = false; unitCounter = 0;
            if(autoInterval) clearInterval(autoInterval);
            document.getElementById("btn-start").disabled = false;
            document.getElementById("btn-next").disabled = true;
            document.getElementById("btn-auto").disabled = true;
            document.getElementById("log").innerHTML = '<div class="log-sys">SYSTEM: é…å‚™ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚</div>';
            renderRoster();
        }

        function getTarget(attacker, enemyTeam) {
            let r = roll100();
            let cat = r === 1 ? "ç‰¹æ®Šéƒ¨éšŠ" : (r === 2 ? "æœ€å¾Œè¡›éƒ¨éšŠ" : (r <= 13 ? "å¾Œæ´éƒ¨éšŠ" : "æœ€å‰è¡›éƒ¨éšŠ"));
            
            let enemies = teams[enemyTeam].filter(u => u.isAlive());
            if(enemies.length === 0) return null;

            if (cat === "æœ€å¾Œè¡›éƒ¨éšŠ" && enemies.some(u => u.category === "æœ€å‰è¡›éƒ¨éšŠ")) {
                return getTarget(attacker, enemyTeam); // å†å¸°ã§å†ãƒ­ãƒ¼ãƒ«
            }

            let possible = enemies.filter(u => u.category === cat);
            if (possible.length === 0) {
                // å¯¾è±¡ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒã„ãªã„å ´åˆã¯ãƒ©ãƒ³ãƒ€ãƒ ãªæ•µã¸ï¼ˆè¶…éå‡¦ç†ã®ä»£æ›¿ï¼‰
                return enemies[Math.floor(Math.random() * enemies.length)];
            }

            possible.sort((a, b) => a.agi - b.agi);
            let minAgi = possible[0].agi;
            let candidates = possible.filter(u => u.agi === minAgi);
            return candidates[Math.floor(Math.random() * candidates.length)];
        }

        function startBattle() {
            if(teams.A.length === 0 || teams.B.length === 0) return alert("ä¸¡è»ã«éƒ¨éšŠã‚’é…å‚™ã—ã¦ãã ã•ã„");
            isBattling = true;
            document.getElementById("btn-start").disabled = true;
            document.getElementById("btn-next").disabled = false;
            document.getElementById("btn-auto").disabled = false;
            logHTML(`<div class="log-turn" style="font-size:16px;">âš”ï¸ MISSION START âš”ï¸</div>`);
        }

        function runTurn() {
            logHTML(`<div class="log-turn">â–¼ TURN ${turn} â–¼</div>`);
            
            let cats = ["ç‰¹æ®Šéƒ¨éšŠ", "æœ€å¾Œè¡›éƒ¨éšŠ", "æœ€å‰è¡›éƒ¨éšŠ", "å¾Œæ´éƒ¨éšŠ"];
            for (let cat of cats) {
                for (let side of ["A", "B"]) {
                    let enemySide = side === "A" ? "B" : "A";
                    
                    teams[side].forEach(atk => {
                        if (atk.category !== cat || !atk.isAlive()) return;
                        
                        let target = getTarget(atk, enemySide);
                        if (!target) return;

                        let actRoll = roll(6);
                        let atkType = actRoll === 1 ? "ç‰¹æ®Šæ”»æ’ƒ" : (actRoll === 6 ? "ç„¡è¬€ãªæ”»æ’ƒ" : "é€šå¸¸æ”»æ’ƒ");
                        let [dNum, dSide] = atk.dice[atkType];
                        
                        let hits = 0; target.turnDeaths = 0; atk.turnDeaths = 0;
                        let activeMen = atk.getActive();

                        for (let i=0; i<activeMen; i++) {
                            let dmg = 0; for(let d=0; d<dNum; d++) dmg += roll(dSide);
                            
                            if (atkType === "ç„¡è¬€ãªæ”»æ’ƒ") {
                                let ratio = atk.traits.includes("é©å‘½ä¸‡æ­³") ? 0.4 : 0.3;
                                let selfDmg = Math.floor(dmg * ratio);
                                if (target.takeDamage(dmg - selfDmg)) hits++;
                                atk.takeDamage(selfDmg);
                            } else {
                                if (target.takeDamage(dmg)) hits++;
                            }
                        }

                        let logTxt = `<span class="log-atk">[${atk.name}] ãŒ ${atkType} (${actRoll}) -> [${target.name}]</span><br>`;
                        logTxt += `<span class="log-dmg">&nbsp;&nbsp;â”” æœ‰åŠ¹æ‰“: ${hits} / æ•µæ­»å‚·: <span class="log-fatal">${target.turnDeaths}å</span></span>`;
                        if (atkType === "ç„¡è¬€ãªæ”»æ’ƒ") logTxt += `<span class="log-fatal"> | è‡ªè»çŠ ç‰²: ${atk.turnDeaths}å</span>`;
                        logHTML(logTxt);
                    });
                }
            }

            // æ°—çµ¶é€²è¡Œ
            ["A", "B"].forEach(side => {
                teams[side].forEach(u => {
                    for(let i=0; i<u.size; i++) {
                        if (u.statusList[i] === 1) u.statusList[i] = 2;
                        else if (u.statusList[i] === 2) u.statusList[i] = -1;
                    }
                });
            });

            turn++;
            renderRoster();

            let aAlive = teams.A.some(u => u.isAlive());
            let bAlive = teams.B.some(u => u.isAlive());

            if (!aAlive || !bAlive) {
                if(autoInterval) clearInterval(autoInterval);
                let winner = aAlive ? "æ”»æ’ƒè»(A)" : (bAlive ? "é˜²è¡›è»(B)" : "å¼•ãåˆ†ã‘(ä¸¡è»å…¨æ»…)");
                logHTML(`<div class="log-turn" style="font-size:18px; color:#10b981;">ğŸ† æˆ¦é—˜çµ‚äº†ï¼ å‹è€…: ${winner} ğŸ†</div>`);
                document.getElementById("btn-next").disabled = true;
                document.getElementById("btn-auto").disabled = true;
                return false;
            }
            return true;
        }

        function runAuto() {
            document.getElementById("btn-next").disabled = true;
            document.getElementById("btn-auto").disabled = true;
            autoInterval = setInterval(() => {
                if (!runTurn()) clearInterval(autoInterval);
            }, 300); // 0.3ç§’é–“éš”ã§è‡ªå‹•é€²è¡Œ
        }
    </script>
</body>
</html>
