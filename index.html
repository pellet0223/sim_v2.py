<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TACTICAL COMMAND DUAL - Ver13.0</title>
    <style>
        :root {
            --bg-dark: #050b14; --panel-bg: #0f172a; --panel-border: #1e293b;
            --cyan: #06b6d4; --red: #ef4444; --green: #10b981; --yellow: #eab308; --blue: #3b82f6;
            --text-main: #f8fafc; --text-muted: #64748b;
        }
        * { box-sizing: border-box; }
        body { margin: 0; padding: 10px; background: var(--bg-dark); color: var(--text-main); font-family: 'Segoe UI', Meiryo, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        h1 { text-align: center; margin: 0 0 10px 0; font-size: 20px; color: var(--cyan); text-shadow: 0 0 10px rgba(6,182,212,0.5); letter-spacing: 2px; }

        .top-section { display: flex; gap: 10px; height: 48%; min-height: 320px; margin-bottom: 10px; }
        .bottom-section { display: flex; gap: 10px; flex: 1; min-height: 0; }
        .panel { background: var(--panel-bg); border: 1px solid var(--panel-border); border-radius: 6px; padding: 10px; display: flex; flex-direction: column; overflow: hidden; }
        .panel-title { font-size: 14px; font-weight: bold; border-bottom: 1px solid var(--panel-border); padding-bottom: 5px; margin-bottom: 10px; color: #fff; display: flex; justify-content: space-between; align-items: center; }

        .setup-panel { flex: 1.2; overflow-y: auto; padding-right: 5px; }
        .faction-group { background: #020617; border: 1px solid var(--panel-border); border-radius: 4px; margin-bottom: 10px; overflow: hidden; }
        .faction-summary { padding: 10px; font-weight: bold; color: var(--yellow); background: #1e293b; cursor: pointer; outline: none; border-bottom: 1px solid #000; }
        .unit-details { background: #0f172a; border-top: 1px solid #000; margin: 5px; border: 1px solid var(--panel-border); border-radius: 4px; }
        .unit-summary { padding: 10px; cursor: pointer; color: #fff; font-size: 13px; font-weight: bold; }
        .preset-info { padding: 10px; background: #020617; border-top: 1px solid var(--panel-border); font-size: 12px; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; color: var(--text-muted); margin-bottom: 8px; font-size: 11px; }
        
        /* çµ„ç¹”ç‰¹æ€§ã‚¹ã‚¤ãƒƒãƒ */
        .trait-toggle-panel { background: #1e293b; padding: 8px; border-radius: 4px; margin-bottom: 10px; border: 1px solid var(--cyan); }
        .toggle-row { display: flex; align-items: center; justify-content: space-between; font-size: 11px; color: var(--cyan); }
        .switch { position: relative; display: inline-block; width: 34px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 18px; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--cyan); }
        input:checked + .slider:before { transform: translateX(16px); }

        .action-btns { display: flex; flex-direction: column; gap: 8px; background: #1e293b; padding: 8px; border-radius: 4px; margin-top: 10px; }
        .btn-row { display: flex; gap: 5px; align-items: center; width: 100%; }
        button { background: var(--blue); color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 11px; }
        button:hover { filter: brightness(1.2); }
        .btn-a { background: var(--cyan); color: #000; flex: 1; } .btn-b { background: var(--red); color: #fff; flex: 1; }

        /* ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒƒãƒ— */
        .map-panel { flex: 2; position: relative; display: flex; flex-direction: column; }
        .battlefield { 
            flex: 1; display: flex; justify-content: space-between; 
            background: radial-gradient(circle, #1e293b 1px, transparent 1px), #050b14;
            background-size: 40px 40px; border: 1px solid #334155; border-radius: 4px; 
            padding: 15px; overflow: hidden; position: relative;
        }
        .map-zone { display: flex; flex-direction: column; justify-content: center; gap: 8px; width: 22%; z-index: 1; }
        .map-center { width: 6%; border-left: 1px solid rgba(239,68,68,0.3); border-right: 1px solid rgba(6,182,212,0.3); }
        .map-unit { 
            background: rgba(15, 23, 42, 0.9); border: 1px solid #fff; padding: 4px; 
            text-align: center; border-radius: 4px; font-size: 9px; font-weight: bold; 
            width: 100%; min-height: 42px; position: relative; transition: 0.3s;
        }
        .map-unit.a { border-color: var(--cyan); color: var(--cyan); }
        .map-unit.b { border-color: var(--red); color: var(--red); }
        .map-unit.dead { opacity: 0.15; filter: grayscale(1); }
        .map-hp-bar { position: absolute; bottom: 3px; left: 4px; right: 4px; height: 3px; background: #000; border-radius: 1px; overflow: hidden; }
        .map-hp-fill { height: 100%; background: var(--green); transition: width 0.3s; }

        @keyframes anim-atk { 0% { transform: scale(1); border-color: #fff; box-shadow: 0 0 20px #fff; } 100% { transform: scale(1); } }
        @keyframes anim-def { 0% { transform: translate(2px, 0); background: #9f1239; } 25% { transform: translate(-2px, 0); } 50% { transform: translate(2px, 0); } 100% { transform: translate(0,0); } }
        .anim-atk { animation: anim-atk 0.4s; z-index: 10; }
        .anim-def { animation: anim-def 0.3s; }

        .list-panel { flex: 1; overflow-y: auto; padding-right: 5px; }
        .log-panel { flex: 1.5; overflow-y: auto; background: #020617; font-family: Consolas, monospace; font-size: 13px; line-height: 1.5; padding: 10px; border: 1px solid var(--panel-border); }
        .unit-card { background: #0f172a; border-left: 3px solid #475569; padding: 8px; margin-bottom: 8px; border-radius: 4px; font-size: 12px; position: relative; }
        .unit-card.a { border-left-color: var(--cyan); } .unit-card.b { border-left-color: var(--red); }
        .bar-wrap { height: 12px; background: #000; border-radius: 2px; margin-top: 4px; position: relative; display: flex; overflow: hidden; }
        .bar-hp { background: var(--green); transition: width 0.3s; }
        .bar-faint { background: var(--yellow); transition: width 0.3s; }
        .bar-dead { background: var(--red); transition: width 0.3s; }
        .bar-morale { background: var(--blue); transition: width 0.3s; }
        .bar-text { position: absolute; width: 100%; text-align: center; font-size: 9px; line-height: 12px; font-weight: bold; color: #fff; text-shadow: 1px 1px 1px #000; }
        .log-turn { color: var(--yellow); font-weight: bold; margin-top: 10px; border-bottom: 1px dashed #334155; }
        .log-atk { color: #c084fc; } .log-fatal { color: var(--red); font-weight: bold; }
        .faction-header { background: #1e293b; color: var(--yellow); font-size: 11px; padding: 4px 8px; margin: 10px 0 5px 0; border-left: 3px solid var(--yellow); }
    </style>
</head>
<body>

    <h1>TACTICAL COMMAND DUAL - Ver 13.0</h1>

    <div class="top-section">
        <div class="panel setup-panel">
            <div class="panel-title">â–¼ æˆ¦è¡“éƒ¨éšŠãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</div>
            
            <div class="trait-toggle-panel">
                <div class="toggle-row">
                    <span>ğŸš© çµ„ç¹”ç‰¹æ€§: åŠ´åƒè€…ã®æ‰‡å‹• (é©å‘½æˆ¦ç·š)</span>
                    <label class="switch">
                        <input type="checkbox" id="trait-incite-workers">
                        <span class="slider"></span>
                    </label>
                </div>
                <p style="font-size:9px; color:var(--text-muted); margin:4px 0 0 0;">ã‚ªãƒ³ã®å ´åˆã€å…¨åœŸã‚«ãƒ«ãƒ´ã‚§ãƒŠé©å‘½æˆ¦ç·šã¯2ã‚¿ãƒ¼ãƒ³æ¯ã«åŠ´åƒè€…ä¸­éšŠã‚’1å€‹è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚</p>
            </div>

            <div id="setup-list"></div>
        </div>

        <div class="panel map-panel">
            <div class="panel-title">ğŸ“¡ ã‚¿ã‚¯ãƒ†ã‚£ã‚«ãƒ«ãƒ»ã‚¹ã‚­ãƒ£ãƒ³</div>
            <div class="battlefield" id="battlefield">
                <div class="map-zone" id="zone-a-back"></div>
                <div class="map-zone" id="zone-a-front"></div>
                <div class="map-center"></div>
                <div class="map-zone" id="zone-b-front"></div>
                <div class="map-zone" id="zone-b-back"></div>
            </div>
            <div class="controls" style="display:flex; gap:8px; margin-top:10px; justify-content:center;">
                <button id="btn-start" onclick="startBattle()" style="background: var(--green); padding:10px 20px;">âš”ï¸ ä½œæˆ¦é–‹å§‹</button>
                <button id="btn-next" onclick="runTurn()" disabled>â­ æ¬¡ã‚¿ãƒ¼ãƒ³</button>
                <button id="btn-auto" onclick="toggleAuto()" disabled>â© ã‚ªãƒ¼ãƒˆ</button>
                <button onclick="resetGame()" style="background:transparent; border:1px solid var(--red); color:var(--red);">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
        </div>
    </div>

    <div class="bottom-section">
        <div class="panel list-panel" id="panel-a"><div class="panel-title" id="title-a" style="color:var(--cyan)">[A] æ”»æ’ƒè»</div><div id="list-a"></div></div>
        <div id="log-area" class="panel log-panel"><div style="color:var(--text-muted)">RADAR ONLINE...</div></div>
        <div class="panel list-panel" id="panel-b"><div class="panel-title" id="title-b" style="color:var(--red)">[B] é˜²è¡›è»</div><div id="list-b"></div></div>
    </div>

    <script>
        const roll = (sides) => Math.floor(Math.random() * sides) + 1;
        const roll100 = () => Math.floor(Math.random() * 100) + 1;
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // éŸ³å£°ã‚¨ãƒ³ã‚¸ãƒ³
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(freq, type, duration, vol=0.1) {
            try {
                const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
                osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                gain.gain.setValueAtTime(vol, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(); osc.stop(audioCtx.currentTime + duration);
            } catch(e){}
        }
        const sfx = { hit:()=>playSound(150,'square',0.1,0.05), heal:()=>playSound(900,'sine',0.2,0.05), route:()=>playSound(60,'sawtooth',0.5,0.1), win:()=>playSound(500,'sine',0.5,0.05), reinforce:()=>playSound(300,'sine',0.4,0.08) };

        const DATABASE = {
            "ãƒ©ãƒ«ã‚­ã‚¢å›½å®¶ç¤¾ä¼šä¸»ç¾©äººæ°‘å…±å’Œå›½": {
                "ç¬¬ã€‡æ­©å…µå¤§éšŠ": { desc: "çªæ’ƒæ­©å…µã€‚è£…ç”²ã¯ãªã„ãŒæ•°ã§æŠ¼ã™ã€‚", size: 600, cat: "æœ€å‰è¡›éƒ¨éšŠ", morale: 50, agi: 30, arm: 0, hp: 10, fail: 40, gen: [1, 1], spc: [1, 3], reck: [1, 3], traits: ["é©å‘½ä¸‡æ­³"] },
                "ç¬¬ã€‡æ”¿æ²»ç›£æŸ»å§”å“¡ä¸­éšŠ": { desc: "é€ƒäº¡ã‚’è¨±ã•ãªã„ã€‚æ•—èµ°éƒ¨éšŠã‚’ç²›æ¸…ã™ã‚‹ã€‚", size: 100, cat: "å¾Œæ´éƒ¨éšŠ", morale: 200, agi: 30, arm: 0, hp: 10, fail: 30, gen: [1, 1], spc: [1, 2], reck: [1, 2], traits: ["é©å‘½ä¸‡æ­³", "ç²›æ¸…"] },
                "ç¬¬ã€‡è¡›ç”Ÿä¸­éšŠ": { desc: "æ•‘è­·éƒ¨éšŠã€‚ãƒ€ã‚¤ã‚¹:2D2/3D3/4D5ã€‚è¡›ç”Ÿå…µåŒå£«ã¯æ•‘è­·ä¸å¯ã€‚", size: 100, cat: "å¾Œæ´éƒ¨éšŠ", morale: 100, agi: 80, arm: 3, hp: 10, fail: 10, gen: [2, 2], spc: [3, 3], reck: [4, 5], traits: ["è¡›ç”Ÿå…µ"] },
                "ç¬¬ã€‡æ”¯æ´ç ²å…µä¸­éšŠ": { desc: "æœ€å¾Œè¡›éƒ¨éšŠã€‚è£…ç”²ã‚’ç„¡è¦–ã—ã¦æ”»æ’ƒã™ã‚‹è²«å¾¹æŒã¡ã€‚", size: 100, cat: "æœ€å¾Œè¡›éƒ¨éšŠ", morale: 60, agi: 0, arm: 0, hp: 10, fail: 60, gen: [1, 6], spc: [1, 8], reck: [1, 4], traits: ["è²«å¾¹"] }
            },
            "å…¨åœŸã‚«ãƒ«ãƒ´ã‚§ãƒŠé©å‘½æˆ¦ç·š": {
                "ç¬¬ã€‡é©å‘½ãƒ‘ãƒ«ãƒã‚¶ãƒ³å¤§éšŠ": { desc: "ç¥–å›½è§£æ”¾ã‚’æ²ã’ã‚‹æ°‘å…µå¤§éšŠã€‚è£…ç”²ã¯ãªã„ãŒæ•°ã§æŠ¼ã™ã€‚", size: 600, cat: "æœ€å‰è¡›éƒ¨éšŠ", morale: 200, agi: 0, arm: 0, hp: 10, fail: 60, gen: [1, 2], spc: [1, 2], reck: [1, 5], traits: ["é©å‘½ä¸‡æ­³"] }
            },
            "ã‚«ãƒ«ãƒ´ã‚§ãƒŠå¸å›½": {
                "ç¬¬ã€‡æ­£è¦æ­©å…µå¤§éšŠ": { desc: "è¦å¾‹æ­£ã—ã„å¸å›½æ­©å…µã€‚å£«æ°—ã«å¼·ã„ã€‚", size: 600, cat: "æœ€å‰è¡›éƒ¨éšŠ", morale: 100, agi: 20, arm: 0, hp: 10, fail: 30, gen: [1, 2], spc: [1, 2], reck: [1, 3], traits: ["çš‡å¸é™›ä¸‹ä¸‡æ­³"] },
                "ç¬¬ã€‡å¸ç«‹é‡è£…ç”²ä¸­éšŠ": { desc: "é‰„å£ã®é‡è£…ç”²(6)ã€‚è²«å¾¹æ”»æ’ƒã‚’æŒã¡ã€å…¨ãƒ¦ãƒ‹ãƒƒãƒˆã®æœ€å¾Œã«è¡Œå‹•ã™ã‚‹ã€‚", size: 100, cat: "ç‰¹æ®Šéƒ¨éšŠ", morale: 250, agi: 10, arm: 6, hp: 10, fail: 30, gen: [1, 5], spc: [1, 6], reck: [1, 3], traits: ["çš‡å¸é™›ä¸‹ä¸‡æ­³", "è²«å¾¹", "é‡éˆ"] }
            }
        };

        // åŠ´åƒè€…ä¸­éšŠã®ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆéš ã—ãƒ‡ãƒ¼ã‚¿ï¼‰
        const WORKER_PRESET = { desc: "æ‰‡å‹•ã•ã‚ŒãŸåŠ´åƒè€…ã€‚è„†å¼±ã ãŒé©å‘½ã®ç²¾ç¥ã§æ­»ã«ç‰©ç‹‚ã„ã«æˆ¦ã†ã€‚", size: 100, cat: "æœ€å‰è¡›éƒ¨éšŠ", morale: 50, agi: 0, arm: 0, hp: 7, fail: 65, gen: [1, 1], spc: [1, 1], reck: [2, 3], traits: ["é©å‘½ä¸‡æ­³"] };

        class Unit {
            constructor(name, preset, affiliation, team, id) {
                this.id = id; this.name = name; this.affiliation = affiliation; this.team = team; 
                this.category = preset.cat; this.size = preset.size; 
                this.morale = preset.morale; this.max_morale = preset.morale;
                this.agi = preset.agi; this.arm = preset.arm; this.hp = preset.hp || 10; this.fail = preset.fail;
                this.dice = { "é€šå¸¸æ”»æ’ƒ": [...preset.gen], "ç‰¹æ®Šæ”»æ’ƒ": [...preset.spc], "ç„¡è¬€ãªæ”»æ’ƒ": [...preset.reck] };
                this.traits = preset.traits || [];
                this.hpList = new Array(this.size).fill(this.hp);
                this.statusList = new Array(this.size).fill(0); 
                this.isRouted = false;
            }
            getActive() { return this.statusList.filter(s => s === 0).length; }
            getFaint() { return this.statusList.filter(s => s === 1 || s === 2).length; }
            getDead() { return this.statusList.filter(s => s === -1).length; }
            isAlive() { return (this.max_morale === "/" || !this.isRouted) && this.statusList.some(s => s !== -1); }
            takeDamage(dmg, isPiercing = false) {
                if (!this.isAlive() || roll100() <= this.fail) return { hit: false, killed: false };
                let actualDmg = Math.min(Math.max(0, dmg - (isPiercing ? 0 : this.arm)), this.hp);
                let targets = [];
                for(let i=0; i<this.size; i++) if(this.statusList[i] >= 0) targets.push(i);
                if(targets.length === 0) return { hit: false, killed: false };
                let idx = targets[Math.floor(Math.random() * targets.length)];
                let oldHp = this.hpList[idx]; this.hpList[idx] -= actualDmg;
                if (oldHp > 1 && this.hpList[idx] <= 0) this.hpList[idx] = 1;
                let killed = false;
                if (this.hpList[idx] <= this.hp / 2 && this.statusList[idx] === 0) this.statusList[idx] = 1;
                if (this.hpList[idx] <= 0) { this.statusList[idx] = -1; killed = true; }
                return { hit: true, killed: killed };
            }
            receiveHealing(amount) {
                let targets = [];
                for(let i=0; i<this.size; i++) if(this.statusList[i] === 1 || this.statusList[i] === 2) targets.push(i);
                if(targets.length === 0) return false;
                let idx = targets[Math.floor(Math.random() * targets.length)];
                this.hpList[idx] = Math.min(this.hp, this.hpList[idx] + amount);
                if(this.hpList[idx] > this.hp / 2) { this.statusList[idx] = 0; return true; }
                return false;
            }
            applyMoraleDamage(deaths) {
                if(this.max_morale==="/" || this.isRouted || deaths<=0) return false;
                let d = deaths + roll(20);
                if(this.traits.includes("çš‡å¸é™›ä¸‹ä¸‡æ­³")) d = Math.floor(d/2);
                if(this.traits.includes("é©å‘½ä¸‡æ­³") && roll100()<=30) d=0;
                if(d>0) this.morale -= d;
                return this.morale <= 0;
            }
        }

        let teams = { A: [], B: [] };
        let turn = 1; let isBattling = false; let autoMode = false; let unitCounter = 0; let isProcessing = false;

        function initSetup() {
            const list = document.getElementById("setup-list");
            list.innerHTML = "";
            for (let [faction, units] of Object.entries(DATABASE)) {
                let html = `<details class="faction-group"><summary class="faction-summary">ğŸŒ ${faction}</summary>`;
                for (let [key, data] of Object.entries(units)) {
                    let sid = `set-${unitCounter++}`;
                    html += `<details class="unit-details"><summary class="unit-summary">${key}</summary>
                        <div class="preset-info">
                            <div class="stat-grid"><div>å…µç§‘: ${data.cat}</div><div>è¦æ¨¡: ${data.size}</div><div>å£«æ°—: ${data.morale}</div><div>è£…ç”²: ${data.arm}</div></div>
                            <div class="action-btns">
                                <div class="btn-row"><span>è£…å‚™:</span><select id="eq-${sid}"><option value="none">ãªã—</option><option value="mg">æ©Ÿé–¢éŠƒ (+2D1ç‰¹æ®Š)</option><option value="sp">å¡¹å£•ã‚¹ã‚³ãƒƒãƒ— (+1è£…ç”²)</option></select></div>
                                <div class="btn-row"><span>æ•°:</span><input type="number" id="ct-${sid}" value="1" min="1" max="5" style="width:40px">
                                <button class="btn-a" onclick="addUnit('${faction}','${key}','${sid}','A')">â—€ A</button><button class="btn-b" onclick="addUnit('${faction}','${key}','${sid}','B')">B â–¶</button></div>
                            </div>
                        </div></details>`;
                }
                list.innerHTML += html + `</details>`;
            }
        }

        function addUnit(fac, key, sid, team) {
            if(isBattling) return;
            let d = DATABASE[fac][key];
            let c = parseInt(document.getElementById(`ct-${sid}`).value);
            let eq = document.getElementById(`eq-${sid}`).value;
            for(let i=0; i<c; i++){
                let name = key.replace('ã€‡', Math.floor(Math.random()*84)+1);
                let u = new Unit(name, d, fac, team, `u${unitCounter++}`);
                if(eq==='mg' && d.size===600) { u.name+='(æ©ŸéŠƒ)'; u.dice["ç‰¹æ®Šæ”»æ’ƒ"][0]+=2; u.dice["ç‰¹æ®Šæ”»æ’ƒ"][1]+=1; }
                if(eq==='sp' && d.arm===0) { u.name+='(æ˜)'; u.arm+=1; u.agi-=50; }
                teams[team].push(u);
            }
            updateUI();
        }

        function updateUI() {
            ["A", "B"].forEach(teamId => {
                const list = document.getElementById(`list-${teamId.toLowerCase()}`);
                list.innerHTML = "";
                let stats = { a:0, f:0, d:0 };
                let grouped = {};
                teams[teamId].forEach(u => { if(!grouped[u.affiliation]) grouped[u.affiliation]=[]; grouped[u.affiliation].push(u); });
                for(let [fac, units] of Object.entries(grouped)){
                    list.innerHTML += `<div class="faction-header">${fac}</div>`;
                    units.forEach(u => {
                        let active = u.getActive(), faint = u.getFaint(), dead = u.getDead();
                        stats.a+=active; stats.f+=faint; stats.d+=dead;
                        let hpP = ((active+faint)/u.size)*100, mP = u.max_morale==="/"?100:(u.morale/u.max_morale)*100;
                        list.innerHTML += `<div class="unit-card ${teamId.toLowerCase()}" style="${u.isAlive()?'':'opacity:0.5'}">
                            <div style="display:flex; justify-content:space-between; font-weight:bold;"><span>${u.name}</span><button class="btn-del" style="display:${isBattling?'none':'block'}" onclick="removeUnit('${teamId}','${u.id}')">âœ–</button></div>
                            <div class="bar-wrap"><div class="bar-hp" style="width:${hpP}%"></div><div class="bar-text">ç”Ÿ:${active} / æ°—:${faint} / æ­»:${dead}</div></div>
                            <div class="bar-wrap"><div class="bar-morale" style="width:${mP}%"></div><div class="bar-text">å£«æ°—: ${u.morale}</div></div>
                        </div>`;
                    });
                }
                document.getElementById(`title-${teamId.toLowerCase()}`).innerHTML = `[${teamId}] ${teamId==="A"?'æ”»æ’ƒ':'é˜²è¡›'} <span style="font-size:10px;">(ç”Ÿ:${stats.a} æ°—:${stats.f} æ­»:${stats.d})</span>`;
            });

            document.querySelectorAll('.map-zone').forEach(z => z.innerHTML='');
            [...teams.A, ...teams.B].forEach(u => {
                let s = u.team.toLowerCase();
                let z = (u.category.includes('å¾Œæ´') || u.category.includes('æœ€å¾Œè¡›')) ? `zone-${s}-back` : `zone-${s}-front`;
                let hpP = ((u.getActive()+u.getFaint())/u.size)*100;
                document.getElementById(z).innerHTML += `<div class="map-unit ${s} ${u.isAlive()?'':'dead'}" id="map-${u.id}">${u.name.split(' ')[0]}<br><div class="map-hp-bar"><div class="map-hp-fill" style="width:${hpP}%"></div></div></div>`;
            });
        }

        function removeUnit(t, id) { teams[t] = teams[t].filter(u => u.id !== id); updateUI(); }
        function toggleAuto() { autoMode = !autoMode; document.getElementById("btn-auto").innerHTML = autoMode?"â¸ åœæ­¢":"â© ã‚ªãƒ¼ãƒˆ"; if(autoMode && !isProcessing) runTurn(); }

        async function runTurn() {
            if(isProcessing) return; isProcessing = true;
            document.getElementById("btn-next").disabled = true;
            const log = (msg, cls='') => { const a=document.getElementById("log-area"); a.innerHTML+=`<div class="${cls}">${msg}</div>`; a.scrollTop=a.scrollHeight; };
            log(`â–¼ TURN ${turn} â–¼`, 'log-turn');

            // --- çµ„ç¹”ç‰¹æ€§: åŠ´åƒè€…ã®æ‰‡å‹• ---
            if (document.getElementById('trait-incite-workers').checked && turn % 2 === 0) {
                ["A", "B"].forEach(side => {
                    // ãã®é™£å–¶ã«ã€Œå…¨åœŸã‚«ãƒ«ãƒ´ã‚§ãƒŠé©å‘½æˆ¦ç·šã€ã®éƒ¨éšŠãŒä¸€ã¤ã§ã‚‚ã„ã‚Œã°ç™ºå‹•
                    if (teams[side].some(u => u.affiliation === "å…¨åœŸã‚«ãƒ«ãƒ´ã‚§ãƒŠé©å‘½æˆ¦ç·š")) {
                        let name = `ç¬¬${Math.floor(Math.random()*84)+1}é©å‘½åŠ´åƒè€…ä¸­éšŠ`;
                        let worker = new Unit(name, WORKER_PRESET, "å…¨åœŸã‚«ãƒ«ãƒ´ã‚§ãƒŠé©å‘½æˆ¦ç·š", side, `u_incite_${unitCounter++}`);
                        teams[side].push(worker);
                        log(`ğŸ“¢ã€åŠ´åƒè€…ã®æ‰‡å‹•ã€‘${side}è»ã« ${name} ãŒåˆæµï¼`, 'log-atk');
                        sfx.reinforce();
                    }
                });
                updateUI();
            }

            let all = [...teams.A, ...teams.B];
            all.forEach(u => u.turnStartDead = u.getDead());

            let order = ["ç‰¹æ®Šéƒ¨éšŠ", "æœ€å¾Œè¡›éƒ¨éšŠ", "æœ€å‰è¡›éƒ¨éšŠ", "å¾Œæ´éƒ¨éšŠ"];
            let actionList = [];
            order.forEach(cat => all.filter(u => u.category === cat && !u.traits.includes('é‡éˆ')).forEach(u => actionList.push(u)));
            all.filter(u => u.traits.includes('é‡éˆ')).forEach(u => actionList.push(u));

            for (let atk of actionList) {
                if(!atk.isAlive()) continue;
                let isM = atk.traits.includes('è¡›ç”Ÿå…µ'), target;
                if(isM) {
                    let allies = teams[atk.team].filter(u => u.isAlive() && !u.traits.includes('è¡›ç”Ÿå…µ') && u.getFaint() > 0);
                    if(!allies.length) allies = teams[atk.team].filter(u => u.isAlive() && !u.traits.includes('è¡›ç”Ÿå…µ') && u !== atk);
                    target = allies[Math.floor(Math.random()*allies.length)];
                } else {
                    let enemies = teams[atk.team==='A'?'B':'A'].filter(u => u.isAlive());
                    target = enemies[Math.floor(Math.random()*enemies.length)];
                }
                if(!target) continue;

                const aEl = document.getElementById(`map-${atk.id}`), tEl = document.getElementById(`map-${target.id}`);
                if(aEl) aEl.classList.add('anim-atk'); if(tEl) tEl.classList.add('anim-def');
                if(isM) sfx.heal(); else sfx.hit();
                await sleep(350);
                if(aEl) aEl.classList.remove('anim-atk'); if(tEl) tEl.classList.remove('anim-def');

                let rollV = roll(6), type = rollV===1?"ç‰¹æ®Š":(rollV===6?"ç„¡è¬€":"é€šå¸¸");
                let [dN, dS] = atk.dice[type==="é€šå¸¸"?"é€šå¸¸æ”»æ’ƒ":(type==="ç‰¹æ®Š"?"ç‰¹æ®Šæ”»æ’ƒ":"ç„¡è¬€ãªæ”»æ’ƒ")];
                let hits = 0, kills = 0, revs = 0, selfK = 0, count = atk.getActive();

                for(let i=0; i<count; i++){
                    let d = 0; for(let j=0; j<dN; j++) d += roll(dS);
                    if(isM){ if(target.receiveHealing(d)) revs++; if(type==="ç„¡è¬€" && atk.takeDamage(Math.floor(d*0.3)).killed) selfK++; }
                    else {
                        let res = target.takeDamage(d, atk.traits.includes('è²«å¾¹'));
                        if(res.hit) hits++; if(res.killed) kills++;
                        if(type==="ç„¡è¬€" && atk.takeDamage(Math.floor(d*0.3)).killed) selfK++;
                    }
                }
                log(`[${atk.name}] ${type} -> [${target.name}]`);
                updateUI(); await sleep(50);
            }

            all.forEach(u => {
                for(let i=0; i<u.size; i++) if(u.statusList[i]===1) u.statusList[i]=2; else if(u.statusList[i]===2){ u.statusList[i]=-1; u.hpList[i]=0; }
                if(u.isAlive() && u.applyMoraleDamage(u.getDead()-u.turnStartDead)){
                    let commissar = teams[u.team].find(c => c.traits.includes('ç²›æ¸…') && c.isAlive() && c !== u);
                    if(commissar){
                        let aliveIds = []; u.statusList.forEach((s,idx)=>{ if(s!==-1) aliveIds.push(idx); });
                        let killC = Math.floor(aliveIds.length/2);
                        for(let i=0; i<killC; i++) { let rIdx = aliveIds.splice(Math.floor(Math.random()*aliveIds.length),1)[0]; u.statusList[rIdx]=-1; u.hpList[rIdx]=0; }
                        u.max_morale="/"; u.morale="/"; sfx.purge; log(`ğŸ’¥ã€ç²›æ¸…ã€‘${u.name} ã‚’å†ç·¨ï¼`, 'log-fatal');
                    } else { u.isRouted=true; u.statusList.forEach((s,idx)=>{ if(s>0) u.statusList[idx]=-1; }); sfx.route(); log(`âš ï¸ã€æ•—èµ°ã€‘${u.name} å´©å£Šï¼`, 'log-fatal'); }
                }
            });

            turn++; updateUI(); isProcessing = false;
            let winA = teams.B.every(u => !u.isAlive()), winB = teams.A.every(u => !u.isAlive());
            if(winA || winB){ autoMode = false; sfx.win(); log(`ğŸ† çµ‚çµ: ${winA?'Aè»':'Bè»'}å‹åˆ©ï¼`, 'log-turn'); return; }
            if(autoMode) setTimeout(runTurn, 400); else document.getElementById("btn-next").disabled = false;
        }

        function startBattle(){ if(!teams.A.length||!teams.B.length) return; audioCtx.resume(); isBattling=true; document.getElementById("btn-start").disabled=true; document.getElementById("btn-next").disabled=false; document.getElementById("btn-auto").disabled=false; updateUI(); }
        function resetGame(){ teams={A:[],B:[]}; turn=1; isBattling=false; autoMode=false; unitCounter=0; isProcessing=false; document.getElementById("btn-start").disabled=false; document.getElementById("btn-next").disabled=true; updateUI(); }
        initSetup();
    </script>
</body>
</html>
